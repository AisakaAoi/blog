---
title: 数学基础-KKT条件，原来如此简单 | 理论+算例实践
categories:
  - 🌙基础学习
  - ⭐最优化理论
abbrlink: 9dca7274
date: 2023-01-04 06:36:42
tags:
---

### 什么是KKT

**KKT条件（Karush Kuhn Tucker conditions）**是最优化（特别是**非线性规划**）领域最重要的成果之一，是**判断某点是极值点**的必要条件。

可理解好它需要用到**梯度、松弛变量、对偶理论等**知识，想讲好**KKT条件**是具有一定难度的。

本文第一部分侧重于**理论部分**，第二部分给出**运用KKT条件**进行**数值和符号运算的Matlab代码**。基于此，大家可以非常方便地应用于自己的**论文写作**。

在介绍KKT条件之前，先补充些**基础知识**。

<!--more-->

***

#### 何谓最优化问题

> **要选择一组参数（变量），在满足一定的限制条件（约束）下，使设计指标（目标）达到最优值。**

根据定义，[古诺模型](https://mp.weixin.qq.com/s?__biz=MzIxMDY1OTk1OA==&mid=2247483878&idx=1&sn=9c862202b8dbb9ce9baa953bfcd838ef)和[Stackelberg模型](https://mp.weixin.qq.com/s?__biz=MzIxMDY1OTk1OA==&mid=2247483899&idx=1&sn=0f37e20c05a6fe0aecb4d24b440a3f19)是最优化问题，只不过它们**均没有约束**，直接对**决策变量求导**便能得到**最优值**。

进一步，根据**有无约束**以及**约束特征**，可以将最优化问题**分为以下三类**，每类问题的**求解方法**也紧跟着列出。

***

#### 最优化问题分类

> **无约束**优化问题：直接求导、最速下降法、共轭梯度法、牛顿法等；
> **等式约束**优化问题：拉格朗日(Lagrange)乘数法；
> **不等式约束**优化问题：KKT条件。

**大家做科研时也要分清楚自己的问题属于哪一类，然后运用对应的求解方法。**

以上知识点在本科的《运筹学》和《高等数学》课程中均学过。**前两类**相对简单，至于**KKT条件**，大家会被课本上复杂的数学公式**劝退**，即使考前重温，过段时间又会忘。

所以，本文不先从那些复杂公式入手，而是以我的理解，带大家一起探索下**Karush–Kuhn–Tucker**这三个人，是**如何发现并总结出KKT条件**的。

***
***

### KKT条件理论部分

该部分先介绍KKT条件的**核心思想**，即**λg(X\*)=0**公式的由来；再解释为什么课本上的**数学公式长那样**，最后再针对性地给出一些**补充说明**和**数学证明**。

***

#### KKT条件核心思想

时光倒流，假设你是还没提出KKT条件的Karush本人，面对不等式约束优化问题，会如何思考呢？

先观察下仅含有一个不等式约束的优化问题：

{% asset_img 1.png %}

> 注：如果是最大化问题，即maxf(X)，约束改写为**g(X\*)≥0**的形式（原因后文会解释）。

既然默认**还不知道KKT条件**，所以目前咱们还不会解决该问题。但不急，想想咱们会啥？会**求求导数**，同时也会等式约束下的**拉格朗日乘数法**啊。

一步步来，先对f(X)函数求导吧（**若X多维则是求梯度**），即**先不考虑g(X)≤0这个约束**。

毕竟求导或求梯度，Karush和你都是**会的**。此时会得到“使f(X)取最小值时的**最优X**”，进一步，如果将其值X*带入约束g(X)，无非就以下三种情况。

> （1）g(X*)<0

那正好满足约束，**X**就是我们要找的**最优解**。

猛然发现，此时该约束完全**不起作用**啊(称为**不起作用约束**)，毕竟我们计算X*时压根都没考虑它。

> （2）g(X*)=0

也就是最优解X*正好也让约束**取了等号**。

这咱们也熟啊，这不转化为含有**等式约束**的优化问题了嘛。如何求解？**拉格朗日乘数法**啊，安排~

> （3）g(X*)>0

显然此时的X*不满足约束，应**舍弃**。

但这并没有结束，我们需要**给出一个解**，那此时大家觉得X*会在哪？很简单，无非又变回了情形（1）或（2）。

综上，我们只需要分情况讨论清楚**若g(X*)<0和若g(X*)=0时，应该如何求解即可**。

一通分析下来，大家或许此时感觉自己好像**已经会了**，不就是：

> **若g(X\*)<0**，约束不起作用，该问题转化为**无约束优化问题**求解；
> **若g(X\*)=0**，引入拉格朗日乘子λ，采用**拉格朗日乘数法**求解嘛，其间，构造的**拉格朗日函数**如下（这是拉格朗日乘数法的知识，不了解的同学可以自行简单重温下）。

{% asset_img 2.png %}

理确实这么个理，但人家数学家追求的是**能否有个统一的形式来求解？**这样**分类讨论**可不那么高大上啊。

既然都已经引进**拉格朗日乘子λ**了，那也得想办法使得在**g(X\*)<0**情形下，也要与**λ**有点关系。

考虑到**若g(X\*)<0**，此时该约束不起作用，而已经构造好的**拉格朗日函数**中又有**λ**，怎么办？

很简单，**让拉格朗日函数中的λ=0即可！**此时**拉格朗日函数**可不就简化为L(x, λ)=f(X)了嘛。此时对L(x, λ)求导（等价于对f(X)求导）时既不用管**约束**，也没有**λ的干扰**，简直完美。

汇总一下就是：

> （1）**若g(X\*)=0，引入拉格朗日乘子λ，并要求λ≥0；**
> （2）**若g(X\*)<0，要求λ=0。**

那怎么统一呢？数学家灵魂附体！脑袋一拍，**含泪发现**，这不就可以采用**λg(X\*)=0**的形式统一了嘛。

恭喜你，你代替**Karush本人提出了λg(X\*)=0！**而这，就是KKT条件的**精髓**。

是不是有点难以置信，但确实，KKT条件的**核心思想和公式**其实已经**讲完了**。

不复杂吧，基础思想确实是很简单的，毕竟早在1939年，Karush在其**硕士学位论文**里就已经给出了KKT条件。硕士生啊，哎，差距。

***

#### KKT条件的数学公式

**掌握了思想**，便可以更好地看懂课本上的公式了。

还是由简到难，先给出仅含有**一个不等式约束**的**KKT条件**。

{% asset_img 3.jpg %}

这里还需要**借助**上一部分给出的**拉格朗日函数**来理解。

{% asset_img 4.png %}

简单分析**公式(1)-(4)**可知：

> 式(1)：对拉格朗日函数求梯度(若X一维就是求导)，其中，下三角表示梯度；
> 式(2)：核心公式，要么λ=0，要么g(X*)=0（此处要求两者不能同时为0）；
> 式(3)：拉格朗日乘子λ必须是正的（下一部分的图示法有证明）；
> 式(4)：原问题自己的约束。

可见，式(1)和(2)都是**等式**，可以帮助我们求**最优X\*和λ**，因为式(2)要**分类讨论**，所以可能存在**多个X\*和λ**；式(3)和(4)主要起**验证作用**，帮助我们排除掉一些**不满足**式(3)和(4)的**X\*和λ**。

具体地，在**应用KKT条件计算**时，通常也是**分类讨论**后先求解**X\*和λ**，再**验证**其是否满足式(3)和(4)，从而排除一些解。

像上述仅含有**一个约束**的例子，只需要**分两类**，通常是以**拉格朗日乘子λ是否为0**进行分类：

> (1) 当 λ=0 时，**计算**X\*的值，并验证g(X\*)≤0是否成立；
> (2) 当 λ≠0 时，**计算**X\*和λ的值，并验证g(X\*)≤0和λ≥0是否成立。

下面，将KKT条件推广至含有多个等式约束和不等式约束的情况。也是课本上给初次学习KKT条件的同学提供的公式，劝退了好多人。

考虑的最优化问题为：

{% asset_img 5.jpg %}

此时定义的**拉格朗日函数**为：

{% asset_img 6.png %}

其中，**{λi}**指的是一系列的λ（有m个），同理**{μj}**也是。由于是多个约束，因此引入求和号∑。

其对应的**KKT条件**为：

{% asset_img 7.webp %}

不要被上述形式吓到了，解题思路与之前叙述**类似**，就是用**几个等式计算**最优值，用**不等式验证**这些值，不满足则排除。

即，**利用式(1)(2)(3)求最优X\*和λi**，然后**通过式(4)和(5)验证这些解是否可行**，“可行”指的是这些解是否能让(4)和(5)的不等号成立，不成立则**排除**。注意，μj是可以取任意值的，不受限制。因为它们是**等式约束**的拉格朗日乘子，不是不等式的乘子。

由于该问题有**m个不等式约束**，每个**约束**对应的**拉格朗日/KKT乘子λi**都可以**“=0”或“≠0”**。因此，需要分类讨论的情况有**2^m**种。

分类详情如下：(1) 当λ1=0，λ2≠0，......，λm≠0时；(2) 当λ1=0，λ2=0，......，λm≠0时；......在此，不再展开，**本文第四部分**会给出**算例**来做具体说明。

至此，从特殊到一般的KKT条件讲解完毕，总结一下，当我们**应用KKT条件求解算例**时，可以采用如下思路：

> 能解出最优解的一定是等式，故式(1)(2)(3)帮我们求最优解；
> 式(4)和式(5)是不等式，帮我们排除一些解，或者得到最优解的适用范围。

这里有必要解释下**“得到最优解的适用范围”**这句话。其主要针对**符号运算**的情形，看完**第四部分的算例**，会有更深的理解，这里仅作为引子简单提一下：

> 大家在写论文时，建立的数学模型多是用**参数和变量**表示的，不同情形下的最优解也是**符号表达式**，因此**很难比较大小**。
> 此时，只能通过式(4)和(5)，来得到**在什么条件（某符号表达式满足某条件）下，最优解X\*和对应的f(X\*)值为多少**，即需要**分类讨论**。

具体如何应用上述理论**求解具体的算例**，并撰写Matlab代码，放在第四部分讲解，本部分着重讲解**理论**。

***
***

### KKT条件补充说明

该部分主要强调KKT条件的**适用范围**和**部分理论的数学证明**。

***

#### 充分性、必要性说明

首先强调的是，KKT条件是判断某点是极值点的**必要条件，不是充分条件**。换句话说，**最优解一定满足KKT条件，但KKT条件的解不一定是最优解**。

对于**凸规划**，KKT条件就是**充要条件**了，只要满足KKT条件，则一定是极值点，且得到的一定还是**全局最优解**。

> **凸规划**指的是：目标函数为**凸函数**，不等式约束函数也为**凸函数**，等式约束函数是**仿射**的（理解成是**线性的**也行）。这牵扯到另一个领域了，本文不再展开陈述。

**补充：**我知道很多同学会问，目标函数是凹函数就不能解了？并不是的，凸规划/凸优化只研究**凸函数的最小化问题**，并且认为凹函数的最大化问题是与它**等价的**。毕竟凹函数只需加个负号就是凸函数了，所以在研究问题中，就不再提凹函数了。

***

#### Min/Max与“≤0”和“≥0”的规定

这里指的是（**该部分也是本文的重点部分，划重点**）：

> （1）如果目标为最小化（Min）问题，那么不等式约束需要整理成“≤0”的形式；
> （2）如果目标为最大化（Max）问题，那么不等式约束需要整理成“≥0”的形式；

以仅含有**一个不等式约束**的情形为例，**最小化和最大化**的优化问题要整理成如下**形式**：

{% asset_img 8.png %}

**该形式**可以死记硬背，但时间一长，大家可能会**忘记或记混**了，下面，采用**图示法**逐步展示为什么会有这个要求，该分析过程也展现了KTT条件的**几何思想**。

{% asset_img 9.webp %}

上图画出了3条f(X)函数的**等值线(图中虚线)**，以及右下角为**可行域S**（即约束条件规定的区域）和**g(X)=0**的曲线，最优解为**X\***。基于此，具体分析如下：

> **（1）f(X)函数值下降方向为左上方：**
> 目标是**最小化问题**，若下降方向为右下方，则最优解（图中X*）一定不是在g(X)=0上，而是在可行域S内部

由于KKT条件中第一条就需要计算f(X)和g(X)函数的**梯度**，所以，这里补充一个基础知识：**梯度方向垂直于函数等值线，指向函数值增长的方向**。

基于此，我们尝试画出**f(X)和g(X)函数的梯度方向**：

> **（2）画出f(X)的梯度方向（下图红色方向）：**
> 梯度方向是函数值增长的方向，因此指向右下方；负梯度方向是函数值下降的方向，指向左上方；
> **（3）画出g(X)的梯度方向（下图蓝色方向）：**
> 由于曲线是g(X)=0，右下方是g(X)<0，是在下降，因此，g(X)函数值增长的方向就是左上方了。

{% asset_img 10.jpg %}

由上述分析和上图可知，在最优解X\*处，**f(X\*)和g(X\*)的梯度方向**共线且方向相反。**向量共线且方向相反**在数学上的写法就是：

**负梯度向量是另一个梯度向量的λ倍。**移项后发现，这不就是**KKT条件的第一个等式**嘛！

{% asset_img 11.png %}

同时可知，λ的值只能取**正值**，因为**g(X)的梯度方向与f(X)负梯度方向**相同。这也是KKT条件要求 **λ≥0** 的原因。

> **基于以上分析可知：最小化问题的约束条件应该整理成“≤0”的形式，且λ≥0。**

同理，最大化的分析不再展开，仅给出分析图，有兴趣的同学可以自己动手分析一下。

{% asset_img 12.webp %}

补充一点，对于**最大化问题**，如果可行域也**非要写成g(X)≤0**的形式，**能行吗？**先别忙着否定，我们分析一下。

此时g(X\*)的梯度方向就不再是右下方了（不是上图了），而是**f(X\*)与g(X\*)的梯度方向相同**，有：

{% asset_img 13.png %}

此时如上图，**要么**KKT条件第一项改为**“作差”**，**要么**让**λ<0**。无论哪一个，其实都是**徒增烦恼**。不如上来就规定约束写成**g(X)≥0**来的方便。

> **因此，最大化问题的约束条件应该整理成“≥0”的形式，且λ≥0。**

下面推广到**多约束条件**的情形，仅是把**梯度的共线**变为**梯度的线性组合**，若不好理解，可跳过。

假设有**起作用约束g1(X)和起作用约束g2(X)**共同影响**目标函数f(X)的梯度**，又是怎么样的图形呢？

{% asset_img 14.webp %}

我们分别画出g1(X)函数在X\*处的梯度，如图中**蓝色向量**，其垂直于曲线g1(X\*)=0；同理，画出g2(X)函数在X\*处的梯度，是另一个**蓝色向量**。

至于f(X)函数的梯度，图中画出**负梯度方向**（函数值下降的方向），这样画的好处是可以直观地看出三个梯度向量间的关系：

> **f函数的负梯度可以表示成g1函数和g2函数梯度的线性组合。则有如下公式：**

{% asset_img 15.jpg %}

简单移项后，又发现了我们的老朋友：**KKT条件的第一个等式**。从图中也可以看出，梯度向量之间的夹角为**锐角**，因此也有**λ1≥0，λ2≥0**的要求。

看完这部分内容，相信大家对于课本上关于KKT条件的的**数学公式和图形**，能记忆也能自己推导了。

***

#### 正则性条件/约束规范说明

KKT条件对于**目标函数**和**约束函数**也是有**要求**的。该部分数学性较强，不好理解可跳过。

**目标函数和约束函数（f、g1、... 、gm、h1、... 、hn函数）均为连续可微函数。**

上述是我们熟知的要求，事实上，并**不完全正确（严谨）**，还缺少一个**regularity条件**（也被成为**正则性条件**或者**约束规范**（constraint qualification））。

其含义指：**以下方程组是线性独立的。**

{% asset_img 16.png %}

其中，I(X*)指的是**起作用约束**的集合。

这里不再深入展开，具体算例可参见B站视频[《KKT条件为什么用不了了》](https://www.bilibili.com/video/BV1LF411i768/)：

<iframe src="//player.bilibili.com/player.html?aid=295196252&bvid=BV1LF411i768&cid=470437975&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe>

***

#### 几类非光滑函数的转化

上一节指出，运用KKT条件时，要求函数**连续可微**。可有些函数很常见，但却存在不可微的点，此时就可以想办法转化下。

> **（1）目标函数：f(x) = max(x, x^2)**

**即目标函数f(x)存在不可微点**：简单画图可知，该函数在 (0, 0) 点和 (1, 1) 点处不可微。此时可以引入变量y，进行如下转化。

{% asset_img 17.png %}

强调一下，虽然这个看着简单，但其实应用挺广，比如对如下k个线性函数求最大。

{% asset_img 18.png %}

> **（2）约束条件：g(x) = |x1| + |x2| ≤ 1**

**即约束条件g(x)存在不可微点**：我们知道，绝对值函数的含义为 |x| = max(x, -x)。而g(x)中有两个绝对值，故可以如下转化。

{% asset_img 19.jpg %}

可见，g(x)函数转化成了四个约束，**四个约束都是线性**，就可以用KKT条件了。当然，对于这种简单的形式，画图求解也许会更方便。

总的来说，绝对值函数的线性化较为简单，而更多的**线性化方法/技巧**，可以参见[常见的线性化方法/技巧（上）](https://mp.weixin.qq.com/s?__biz=MzIxMDY1OTk1OA==&mid=2247483794&idx=1&sn=670cdfa59d9b07c2e64f2bbc77057b91)和[常见的线性化方法/技巧（下）](https://mp.weixin.qq.com/s?__biz=MzIxMDY1OTk1OA==&mid=2247483819&idx=1&sn=606e949de5efea55eb310ef997379cb5)或者[令人拍案叫绝的线性化方法/技巧](https://zhuanlan.zhihu.com/p/552076713)。

***

#### KKT条件与KT条件

1951年，Kuhn和Tucker发现了KKT条件并撰写了论文将其正式发表出来，当然，此时他们不知道另一个K是谁，故命名为Kuhn-Tucker（库恩塔克）条件，也就是KT条件。

很快，他们的成果引起了很多很多学者的重视。树大招风，其中一些学者发现早在1939年，Karush在其**硕士学位论文**里边已经给出了KKT条件，只是当时没有引起广泛关注而已。

不过，后来大家都承认Kuhn，Tucker，Karush三位都是**独立发现KKT条件**的学者。故此后命名多加了个K。

***
***

### 数值与符号运算（重点）

简单回顾下KKT条件：

{% asset_img 20.webp %}

还记得解题思路吗？

> 能解出最优解的一定是等式，故式(1-3)帮我们求最优解；
> 式(4-5)是不等式，帮我们排除一些解，或者得到最优解的适用范围。

这也是口诀**“等式求最优，不等式验证”**的由来。

下面，我们来看下**数值/符号运算**中，KKT条件是如何求解最优化问题的。数值计算例子为求解**最小化问题**，符号运算例子为求解**最大化问题**。

先看下课本上的例题，是如何应用KKT条件进行**数值计算**的。

***

#### 数值计算实操

我们想用**KKT条件**求解如下**非线性最优化问题**：

{% asset_img 21.jpg %}

观察约束，发现有**“≥0”**的形式，由本文第二三部分可知，需要统一转化为**“≤0”**的形式，故上述问题的**标准形式**为：

{% asset_img 22.jpg %}

基于该标准形式，构造的**拉格朗日函数**为：

{% asset_img 23.png %}

对其中的x1和x2分别求导，得到如下**两等式**：

{% asset_img 24.png %}

有些同学习惯用**梯度**表示，也可以，**两种方法一致**，看大家熟悉哪种了：

{% asset_img 25.png %}

数一下，有**四个未知数**，但求导后只有**两个等式方程**，显然还**无法求解**，此时KKT条件的核心公式**λigi=0(i=1,2)**就派上用场了。

**λigi=0（两者不同时为0）+ KKT条件中的不等式**，具体含义为：

> （1）若λ1=λ2=0，则g1<0，g2<0；
> （2）若λ1=0，λ2>0，则g1<0，g2=0；
> （3）若λ1>0，λ2=0，则g1=0，g2<0；
> （4）若λ1>0，λ2>0，则g1=0，g2=0；

仔细观察上述每一种情形，均包含了**两个等式方程**，加上之前求导得到的**两个方程**，总共**四个方程**，这回就可以求解**四个未知数**了。

那还等啥，直接求解吧。

**（i）若λ1=λ2=0，则g1<0, g2<0**

无论哪种情形，主要是求解上面写的**求导后的/梯度方程**，即：

{% asset_img 26.png %}

若λ1=λ2=0，则只需要求解x1，x2即可：

{% asset_img 27.jpg %}

那x1=2，x2=1就是其中的一个解了吗？

赶紧背下口诀**“等式求最优，不等式验证”**！奥，原来还得验证下该解是否满足**不等式g1<0和g2<0**。

将x1=2, x2=1带入g1和g2，有：

{% asset_img 28.png %}

很遗憾，两个式子都无法使得 **g1<0 和 g2<0**，故只能舍弃该解。

**此情形其实已经变为无约束问题**（直接对f(X)求导后得到的解），然而它并不满足约束，只能舍弃。

同时也说明，最优解一定会在**某个约束的边界上**。那就继续吧，看看是在g1=0，还是g2=0，还是g1=g2=0的边界上。

**（ii）若λ1=0, λ2>0，则g1＜0, g2=0**

除了两个求导后的方程，此情形多的两个方程分别为λ1=0和g2=0，故累计又有四个方程，求解有：

{% asset_img 29.jpg %}

此时显然已经有λ2>0，故仅还需验证**“g1＜0”**。

{% asset_img 30.png %}

很可惜，不满足g1＜0，故此解还是需要**舍弃**。

**（iii）若λ1>0, λ2=0，则g1=0, g2<0**

同2，也是**四个方程，求解四个未知数**，有：

{% asset_img 31.jpg %}

发现此解与情形1的解一样（仅是这个例子一样，一般不会一样），但带入g2函数时，有：

{% asset_img 32.png %}

很可惜，依然不能使得g2<0，故该解还是需要**舍弃**。

**（iv）若λ1>0, λ2>0，则g1=0, g2=0**

此时，最优解在g1和g2函数的边界上，联立的四个方程为：

{% asset_img 33.jpg %}

非常好，此时的λ1>0，λ2>0，满足KKT条件，故x1=1, x2=2是本题的**最优解**。

**补充：**一般四个方程，我是不会去手算的，编个简单的Matlab代码，就能快速求解：
``` matlab
syms x1 x2 t1 t2  % t1,t2分别指λ1,λ2
equ1 = 2*x1 - 4 + t1 - t2;  % 将上述四个方程对照着抄一下
equ2 = 4*x2 - 4 + t1 - 2*t2;  % 注意打上*，新手特别容易忘记
equ3 = x1 + x2 - 3;
equ4 = 5 - x1 - 2*x2;
[x1,x2,t1,t2] = solve([equ1 equ2 equ3 equ4], [x1 x2 t1 t2])
```

其中，因为Matlab中不方便打λ，所以我一般用t来代替，同时解四个方程用“[]”框起来，四个变量也用“[]”框起来。“[]”在Matlab中一般用来表示**数组或矩阵**。solve函数就是**解方程**用的。

综上，**x1=1, x2=2**是本题的**最优解**。

***

#### 符号运算实操

下面，实操下科研中遇到**有不等式约束的极值问题**时，该如何**利用KKT条件**，并采用Matlab来**编码求解**。算例如下：

> **无约束定价问题：**
> 若企业生产成本为c的产品，市场**需求函数为D = a - bp (a, b 是参数，p为价格)**，那企业的最优定价**p**为多少？

上面这个算例是无约束的，简单地再编两个约束吧，变为有不等式约束的问题：

> **有不等式约束的定价问题：**
> **约束1（针对需求）：**假定需求量小于外生变量S；
> **约束2（针对价格）：**企业规定价格不能低于m*c（m>1）；

则在这两个约束下，企业**如何定价**才能使**利润最大**？

先给出**无约束问题**下的解，决策最优定价p；再给出**含有两个不等式约束**的最优定价决策。

**（i）无约束定价问题**

此种情形较为简单，就是对利润函数（为**二次函数**）求最优值：

{% asset_img 34.jpg %}

具体的Matlab计算代码如下：

``` matlab
clear
syms a b c p
Pi = (p - c)*(a - b*p);
equ = diff(Pi, p);  % 对利润函数Pi中的p求导
Op_p = solve(equ, p);  % 求解方程equ=0中的p，命名为Op_p
Op_D = simplify(a - b*Op_p);  % 反代回需求函数，并化简
```

其中牵扯到的**diff()、solve()、simplify()以及后面会提及的subs()函数**，含义分别为**求导、解方程、化简、替换**。

**（ii）有不等式约束的定价问题**

这里新增了两个约束：
**约束1(针对需求)：**假定需求量小于外生变量S：
{% asset_img 35.png %}
**约束2(针对价格)：**企业规定价格不能低于m*c（m>1）：
{% asset_img 36.png %}

综上，我们有如下优化问题（**写成最大化问题的标准形式**）：

{% asset_img 37.jpg %}

**注意**，这里与**数值算例的最小化问题**不同，该问题是**最大化问题**，因此需将约束全部转化为**“≥0”**的形式，并命名为**g1、g2**。

还记得第一步是什么吗？基于**标准形式**，构造**拉格朗日函数**：

{% asset_img 38.png %}

决策变量只有**p**，故仅**对p求导**即可：

{% asset_img 39.png %}

显然，这里仅有**一个方程**，要解出p、λ1、λ2**三个未知数**是不可能的，还需要**两个等式方程**。而**KKT条件**就是用来给出**剩下的两个等式方程**的。

这里附上上述过程的Matlab代码（为方便敲代码，依旧用t来代替λ）：

``` matlab
clear
syms a b c m p S t1 t2  % 定义需要用到的所有参数/变量
% 构造拉格朗日函数
L = (p-c)*(a-b*p) + t1*(S-a+b*p) + t2*(p-m*c);
% 对L中的决策变量p求导，命名为Equ
Equ = diff(L, p);
% 记录一下Equ的表达式，后面要用
Equ = a + t2 - 2*b*p + b*t1 + b*c;
```

为方便后续计算，这里汇总下**后面分类讨论时**，会反复用到的几个表达式：

``` matlab
clear
syms a b c m p S t1 t2
% 1：利润函数表达式
Pi = (p - c)*(a - b*p);
% 2：求导后的拉格朗日函数表达式
Equ = a + t2 - 2*b*p + b*t1 + b*c;
% 3：两个约束条件的表达式
g1 = S - a + b*p;
g2 = p - m*c;
```

**综上，求导后的拉格朗日函数（Equ）含有p、λ1、λ2三个未知数，接下来分类讨论的目的，就是利用KKT条件，解这三个未知数。**已经有**Equ=0方程**了，剩下的**两个等式方程**，分以下**四种情况**讨论吧。

> **情形1：若λ1=λ2=0，则g1>0，g2>0**

注意，这里与第一部分数值算例中的“g1<0, g2<0”不同，这里是**最大化问题**。也许有同学已经发现了，这其实就是**无约束问题**（两个约束均没有起作用），得到的最优解即为之前的**p\*=(a+bc)/2b**。

还记得口诀吗？**等式求最优，不等式验证**。所以，剩下的就是检验该解是否满足g1>0，g2>0。

因此，Matlab代码编写也分两步。先给出此种情形下如何计算**最优p和最大利润**，再计算得到该解**需满足的条件**。

``` matlab
%% 情形1：当t1=t2=0时，g1>0, g2>0
equ = subs(Equ, [t1, t2], [0, 0]);  % 将t1=0, t2=0代入Equ函数
Op_p = solve(equ, p)  % 求最优p
Pi = simplify(subs(Pi, p, Op_p))  % 求最优利润并化简
```

时刻记住：**在做符号运算时，求得的每一个解，都是有条件的。**那么该解的条件是什么呢，就是g1>0，g2>0。既然**S**和**m**是我们新引进的**参数**，那么我们就来看看它俩**需满足什么条件**。

``` matlab
% 将上述最优解代入g1，g2函数
g1 = subs(g1, p, Op_p)  % 将g1函数中的p，用Op_p的表达式代替
g2 = subs(g2, p, Op_p)
% 解出g1<0和g2<0时，S和m需要满足的条件
solve(g1, S)
solve(g2, m)
```

代码中solve函数解出来的解，就是S和m需要满足的条件。

汇总下，就是只有**当S和m满足如下条件时，才会得到如下最优解**：

{% asset_img 40.jpg %}

> **情形2：若λ1=0，λ2>0，则g1>0，g2=0**

此时由于g2=p-mc=0，故最优解就是**p\*=mc**；将其带入利润函数，便得到**最优利润表达式**。

当然，还需要看下想得到这个解，需要**满足的条件**，即：λ2>0，且g1>0。将λ1=0，p\*=mc带入**求导后的拉格朗日函数函数Equ**，可以计算得到**λ2**的值，令其**\>0**，加上**g1<0**的约束，便能最终该最优解**适用范围**。代码如下：

``` matlab
%% 情形2：当t1=0，t2>0时，g1>0, g2=0
% 先记录下需要用到几个函数表达式
clear
syms a b c m p S t1 t2
Pi = (p - c)*(a - b*p);
Equ = a + t2 - 2*b*p + b*t1 + b*c;
g1 = S - a + b*p;
​
equ1 = subs(Equ, [t1 p], [0, m*c]);  % 将t1=0，p=mc带入Equ
equ2 = subs(g1, p, m*c);  % 将p=mc带入g1约束
Pi = simplify(subs(Pi, p, m*c));  % 将p=mc带入利润函数并化简
​
% 解出t2>0和g1>0时，S和m的范围
t2 = solve(equ1, t2);  % 通过equ1=0解出t2表达式
solve(t2, m)  % 令t2=0，用m来表示
solve(equ2, S)  % 令equ2=0, 用S来表示
```

最后两行代码得到的解，就是为得到情形2下的最优解，需要满足的条件，汇总有：

{% asset_img 41.png %}

> **情形3：若λ1>0，λ2=0，则g1=0，g2>0**

此时由于g1 = S-a+bp = 0，故最优解就是**p\* = (a-S)/b**；将其带入利润函数，便得到**最优利润表达式**。

再次回忆口诀：**不等式验证**。该情形还需要**满足的条件**，为：**λ1>0，且g2>0**。

将λ2=0，p\* = (a-S)/b带入Equ，可以计算得到**λ1**的值，令其**\>0**，加上**g2>0**的约束，便能最终该最优解**适用范围**。代码如下：


``` matlab
%% 情形3：当t1>0，t2=0时，g1=0, g2>0
% 先记录下需要用到几个函数表达式
clear
syms a b c m p S t1 t2
Pi = (p - c)*(a - b*p);
Equ = a + t2 - 2*b*p + b*t1 + b*c;
g2 = p - m*c;
​
equ1 = subs(Equ, [t2 p], [0, (a-S)/b]);  % 将t2=0，p=(a-S)/b带入Equ
equ2 = subs(g2, p, (a-S)/b);  % 将p=(a-S)/b带入g2约束
Pi = simplify(subs(Pi, p, (a-S)/b));  % 将p=(a-S)/b带入利润函数
​
% 解出t1>0和g2>0时，S和m的范围
t1 = solve(equ1, t1);  % 通过equ1=0解出t1表达式
solve(t1, S)  % 令t2=0，用S来表示
solve(equ2, m)  % 令equ2=0, 用S来表示
```

汇总代码计算结果，有：

{% asset_img 42.jpg %}

> **情形4：若λ1>0，λ2>0，则g1=0，g2=0**

该情形下的最优解就是求解三方程Equ=0，g1=0，g2=0下的p、λ1、λ2值。

由于两个约束都是关于p的一次函数，因此会得到**矛盾的结论**，故此种情形舍弃。

{% asset_img 43.jpg %}

需要说明的是，科研中的很多问题会**同时决策两个变量**，或者有**非线性的约束**等，此时两个约束均取“=”是**有解**的。我这个算例编的简单了，造成该种情形无解。

**（iii）最优值间的相互比较**

上述4种情形，3种情形均有最优解。很显然，工作还没做完，我们真正想得到的是**哪些参数条件下，最优定价和最大利润是多少？**

如果是**数值算例**，很简单直观，拿着每种情形下的最大利润比较下即可。

但**符号运算**就不得不**分类讨论**，很多时候，我们甚至连**某个表达式的正负号**都无法确定。

但大家也不用太担心相互比较会很麻烦。因为，**只看利润的话，真正需要比较的，其实只有情形2和情形3下的利润大小**。聪明的你知道这是为什么吗？

> **答案揭晓：**
> 情形1是无约束极值问题，相当于**全域搜索最优解**，其利润一定是**最大的**；情形2和3下的最优解，均受到了**一个**约束g=0的**硬性限制**，利润一定会小一点；而情形4限制更强，要求**两个约束均为0**，这样再去求利润，一定是最小的。

因此，在情形1的参数范围内，它就是老大，没必要跟它比了。所以，重点还是落在情形2和情形3的参数范围内，到底谁利润更大。

为方便阅读，避免前后翻看，情形2和情形3的结论汇总如下。

{% asset_img 44.webp %}

上述一通分析下来，其实也很简单嘛，将两利润做差，即Pi2 - Pi3，再看看正负号呗。

``` matlab
% 比较情形2和情形3下的利润
clear
syms a b c m S
Pi2 = c*(a - b*c*m)*(m-1);  % 情形2下的最优利润
Pi3 = -S*(c+(S-a)/b);  % 情形3下的最优利润
​
del_Pi = collect(Pi2 - Pi3, S)  % 将两式作差，并以S的降序排列
del_Pi = S^2/b + (c-a/b)*S + c*(a-b*c*m)*(m-1)
```

这里用到了**collect()函数**，真的非常好用，大家一定要记住这个函数。

官方说collect是**合并同类项函数**，但我建议大家这样记忆：**collect(f, x)就是将f函数以x的从高到低次项依次展开**。如上述代码最后一行，就是以**S的二次项，S的一次项，S的常数项**依次展开。

这样有什么好处？那可太有用了，我们做科研时，一旦发现表达式是关于某参数的，**3次甚至4次项**后，建议换个参数或者换条思路求解吧。

因为求解三次函数的**卡丹公式**非常长，不适用于论文。而求解二次函数，**韦达定理**大家都是会的。

回到正文，观察差值**del_Pi**函数，是关于S的**二次函数**，开头向上，截距、对称轴均为正，且有两个解，分别为：

``` matlab
solve(del_Pi, S);  % 求解方程del=0的两个解
S1 = b*c*m - b*c;  S2 = a - b*c*m
```

紧接着，这两个解谁大呢？再做差呗。看看和m的关系。

``` matlab
del_S = S1 - S2;
solve(del_S, m)
% 求解得到 m > (a + b*c)/(2*b*c)
```

而 m > (a+b\*c)/(2\*b\*c)，恰好就是情形2下m的取值范围，故 S1 > S2。那基于此，我们可以画出del_Pi = Pi2 - Pi3的图像如下。

{% asset_img 45.jpg %}

> 当0 < S < bcm-bc时，Pi2 < Pi3；
> 当bcm-bc < S < (a-bc)/2时，Pi2 > Pi3;
> 当(a-bc)/2 < S时，不用算了，Pi1最大。

细心的小伙伴也许会说，上面的第一个范围有问题。当 0 < S < a - bcm 时，不应该是 Pi2 > Pi3 吗？从图像上看，确实是的，但是别忘了，情形2中的 S 取值，是要**“> a - bcm”**的。所以当 0 < S < a - bcm 时，Pi2压根就没有图像。

至此，所有的问题就都分析完了。如果上述有错误，望大家批评指正。核心思想是**会用KKT条件分类讨论**，并会**比较不同情形间的最优利润**。

***
***

### 结语

总结下本文的核心：
1. KKT条件是拉格朗日乘数法的推广，理解引入λi的原因及作用；
2. 理解λg(X\*)=0，就理解了KKT条件的精髓；
3. 掌握采用图示法分析f(X)和g(X)的梯度关系。
4. 数值算例中，在运用KKT条件时，很容易发现矛盾（不满足条件）的解，也很容易比较多个解的大小；
5. 符号运算时，若不考虑参数范围，四种情形下的利润大小关系一定有：情形1 > 情形2、3 > 情形4；
6. 比较利润大小时，最好寻求其关于某个参数的一次或二次函数关系，切忌使用高次项参数。

为了方便大家记忆KKT条件的求解步骤，编了个口诀，希望能对大家有所帮助：
> 大大小小
> 等式求最优，不等式验证

**“大大小小”含义：**在建立拉格朗日函数前，需要整理成**标准形式**。对于**最大化问题**，约束整理成**“≥0”**形式；对于**最小化问题**，约束整理成**“≤0”**形式。

别看写了不少，其实就记住这**两行口诀**就行。怎么样，是不是感觉KKT条件也不难嘛。

其实，还有拉格朗日乘子的敏感性分析没讲，这和**对偶理论**有关，篇幅有限，也较难，不再展开。

***
***

### 参考资料

> <https://zhuanlan.zhihu.com/p/556832103>
