---
title: Android-éŸ³è§†é¢‘-éŸ³é¢‘å¼€å‘-ï¼ˆäºŒï¼‰éŸ³é¢‘å½•åˆ¶
categories:
  - ğŸŒ™é€¢å‚æ‚è°ˆä¸æ¬è¿
  - â­ä¸€äº›æŠ€æœ¯
abbrlink: 2ac4e08d
date: 2021-09-17 15:26:17
tags:
---

### AudioRecordï¼ˆåŸºäºå­—èŠ‚æµå½•éŸ³ï¼‰

ä¼˜ç‚¹ï¼šå¯ä»¥å®ç°è¯­éŸ³çš„å®æ—¶å¤„ç†ï¼Œè¿›è¡Œè¾¹å½•è¾¹æ’­ï¼Œå¯¹éŸ³é¢‘çš„å®æ—¶å¤„ç†ã€‚

ç¼ºç‚¹ï¼šè¾“å‡ºçš„æ˜¯PCMçš„è¯­éŸ³æ•°æ®ï¼Œå¦‚æœä¿å­˜æˆéŸ³é¢‘æ–‡ä»¶æ˜¯ä¸èƒ½è¢«æ’­æ”¾å™¨æ’­æ”¾çš„ã€‚è¦ç”¨åˆ°AudioTrackè¿™ä¸ªå»è¿›è¡Œå¤„ç†ã€‚

<!--more-->

#### å®ç° AudioRecord å½•éŸ³çš„æµç¨‹

1. æ„é€ ä¸€ä¸ª AudioRecord å¯¹è±¡ï¼Œå…¶ä¸­æœ€å°å½•éŸ³ç¼“å­˜ buffer å¤§å°å¯ä»¥é€šè¿‡ getMinBufferSize æ–¹æ³•å¾—åˆ°ã€‚å¦‚æœ buffer å®¹é‡è¿‡å°ï¼Œå°†å¯¼è‡´å¯¹è±¡æ„é€ çš„å¤±è´¥ã€‚

2. åˆå§‹åŒ–ä¸€ä¸ª bufferï¼Œè¯¥ buffer å¤§äºç­‰äº AudioRecord å¯¹è±¡ç”¨äºå†™å£°éŸ³æ•°æ®çš„ buffer å¤§å°ã€‚

3. å¼€å§‹å½•éŸ³

4. åˆ›å»ºä¸€ä¸ªæ•°æ®æµï¼Œä¸€è¾¹ä» AudioRecord ä¸­è¯»å–å£°éŸ³æ•°æ®åˆ°åˆå§‹åŒ–çš„ bufferï¼Œä¸€è¾¹å°† buffer ä¸­æ•°æ®å¯¼å…¥æ•°æ®æµã€‚

5. å…³é—­æ•°æ®æµ

6. åœæ­¢å½•éŸ³

7. é‡Šæ”¾å¯¹è±¡

#### æ„é€  AudioRecord å¯¹è±¡éœ€è¦çš„å‚æ•°

1. éŸ³é¢‘æºï¼šä¸€èˆ¬å¯ä»¥ä½¿ç”¨éº¦å…‹é£ä½œä¸ºé‡‡é›†éŸ³é¢‘çš„æ•°æ®æºã€‚

2. é‡‡æ ·ç‡ï¼šä¸€ç§’å†…å¯¹å£°éŸ³æ•°æ®çš„é‡‡æ ·æ¬¡æ•°ï¼Œé‡‡æ ·ç‡è¶Šé«˜ï¼ŒéŸ³è´¨è¶Šå¥½ã€‚

3. é€šé“ï¼šå•å£°é“ï¼ŒåŒå£°é“ç­‰ã€‚

4. éŸ³é¢‘æ ¼å¼ï¼šä¸€èˆ¬é€‰ç”¨ PCM æ ¼å¼ï¼Œå³åŸå§‹çš„éŸ³é¢‘æ ·æœ¬ã€‚

5. ç¼“å†²åŒºå¤§å°ï¼šéŸ³é¢‘æ•°æ®å†™å…¥ç¼“å†²åŒºçš„æ€»æ•°ï¼Œé€šè¿‡ AudioRecord.getMinBufferSize è·å–æœ€å°çš„ç¼“å†²åŒºã€‚

ï¼ˆæœ€åç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶æ˜¯ PCM æ ¼å¼çš„ï¼Œä¹Ÿå°±æ˜¯æœ€åŸå§‹çš„éŸ³é¢‘æ•°æ®ï¼Œå®ƒæ²¡æœ‰å¤´ä¿¡æ¯ï¼Œä¸èƒ½ç›´æ¥æ’­æ”¾ï¼Œå¿…é¡»è½¬æ¢æˆå¯è¯†åˆ«çš„æ ¼å¼æ‰è¡Œã€‚è‹¥è½¬æˆ WAV æ ¼å¼ï¼Œåœ¨æ–‡ä»¶çš„æ•°æ®å¼€å¤´åŠ å…¥ WAVE HEADã€‚ï¼‰

#### AudioRecordä¾‹å­ï¼šå½•åˆ¶éŸ³é¢‘

å½•éŸ³JNIå‡½æ•°ä¸å…·æœ‰çº¿ç¨‹å®‰å…¨æ€§ï¼Œå› æ­¤ç”¨å•çº¿ç¨‹ï¼Œä»¥åŠè®¾ç½®ç¼“å­˜å¤§å°

``` java
mExecutorService = Executors.newSingleThreadExecutor();
mHandler = new Handler(Looper.getMainLooper());
mAudioRecordTest = new AudioRecordTest.Builder(this)
        .setExecutorService(mExecutorService)
        .setHandler(mHandler)
        .setBtStreamRecorder(mBtStreamRecorder)
        .setBufferSize(BUFFER_SIZE)
        .build();
```

ç‚¹å‡»buttonè¿›è¡Œå½•éŸ³ï¼Œå†æ¬¡ç‚¹å‡»åœæ­¢å½•éŸ³åŠŸèƒ½recorderAudio()

``` java
public void recordAudio() {
    if (mIsRecording) {
        mIsRecording = false;
        mBtStreamRecorder.setText("å¼€å§‹å½•éŸ³");
        // åœ¨å¼€å§‹å½•éŸ³ä¸­å¦‚æœè¿™ä¸ªå€¼æ²¡æœ‰å˜falseï¼Œåˆ™ä¸€ç›´è¿›è¡Œï¼Œå½“å†æ¬¡ç‚¹å‡»å˜falseæ—¶ï¼Œå½•éŸ³æ‰åœæ­¢
    } else {
        mIsRecording = true;
        mBtStreamRecorder.setText("åœæ­¢å½•éŸ³");
        // æäº¤åå°ä»»åŠ¡ï¼Œæ‰§è¡Œå½•éŸ³é€»è¾‘
        mExecutorService.submit(this::startRecord);
    }
}
```

å¼€å§‹å½•éŸ³startRecorder()

``` java
private void startRecord() {
    if (!doStartRecord()) {
        recordFail();
    }
}
```

AudioRecordçš„é…ç½®åŠå½•éŸ³åŠŸèƒ½å®ç°doStartRecord()

``` java
private boolean doStartRecord() {
    try {
        // è®°å½•å¼€å§‹å½•éŸ³æ—¶é—´
        startRecorderTime = System.currentTimeMillis();
 
        // åˆ›å»ºå½•éŸ³æ–‡ä»¶
        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.KITKAT) {
            mAudioRecordFile = new File(mContext.getExternalFilesDir(Environment.DIRECTORY_DOCUMENTS) +
                    "/AudioRecordDemo/" + startRecorderTime + ".pcm");
            if (!mAudioRecordFile.getParentFile().exists()) {
                mAudioRecordFile.getParentFile().mkdirs();
            }
        } else {
            return false;
        }
 
        mAudioRecordFile.createNewFile();
 
        // åˆ›å»ºæ–‡ä»¶è¾“å‡ºæµ
        FileOutputStream fos = new FileOutputStream(mAudioRecordFile);
 
        // é…ç½®AudioRecord
        int audioSource = MediaRecorder.AudioSource.MIC;
 
        // æ‰€æœ‰androidç³»ç»Ÿéƒ½æ”¯æŒ
        int sampleRate = 44100;
 
        // å•å£°é“è¾“å…¥
        int channelConfig = AudioFormat.CHANNEL_IN_MONO;
 
        // PCM_16æ˜¯æ‰€æœ‰androidç³»ç»Ÿéƒ½æ”¯æŒçš„
        int audioFormat = AudioFormat.ENCODING_PCM_16BIT;
 
        // è®¡ç®—AudioRecordå†…éƒ¨bufferæœ€å°
        int minBufferSize = AudioRecord.getMinBufferSize(sampleRate, channelConfig, audioFormat);
 
        // bufferä¸èƒ½å°äºæœ€ä½è¦æ±‚ï¼Œä¹Ÿä¸èƒ½å°äºæˆ‘ä»¬æ¯æ¬¡æˆ‘ä»¬è¯»å–çš„å¤§å°ã€‚
        mAudioRecord = new AudioRecord(audioSource, sampleRate, channelConfig,
                audioFormat, Math.max(minBufferSize, BUFFER_SIZE));
 
        // å¼€å§‹å½•éŸ³
        mAudioRecord.startRecording();
 
        // å¾ªç¯è¯»å–æ•°æ®ï¼Œå†™å…¥è¾“å‡ºæµä¸­
        while (mIsRecording) {
            // åªè¦è¿˜åœ¨å½•éŸ³å°±ä¸€ç›´è¯»å–
            int read = mAudioRecord.read(mBuffer, 0, BUFFER_SIZE);
            if (read <= 0) {
                return false;
            } else {
                fos.write(mBuffer, 0, read);
            }
        }
        // é€€å‡ºå¾ªç¯ï¼Œåœæ­¢å½•éŸ³ï¼Œé‡Šæ”¾èµ„æº
        stopRecord();
    } catch (Exception e) {
        e.printStackTrace();
        return false;
    } finally {
        if (mAudioRecord != null) {
            mAudioRecord.stop();
            mAudioRecord.release();
            mAudioRecord = null;
        }
    }
    return true;
}
```

åœæ­¢å½•éŸ³stopRecorder()

``` java
private void stopRecord() {
    mIsRecording = false;
    if (!doStopRecord()) {
        recordFail();
    }
}
```

å†æ¬¡ç‚¹å‡»åœæ­¢å½•éŸ³doStopRecord()

``` java
private boolean doStopRecord() {
    // åœæ­¢å½•éŸ³ï¼Œå…³é—­æ–‡ä»¶è¾“å‡ºæµ
    mAudioRecord.stop();
    mAudioRecord.release();
    mAudioRecord = null;
    // è®°å½•ç»“æŸæ—¶é—´ï¼Œç»Ÿè®¡å½•éŸ³æ—¶é•¿
    long stopRecorderTime = System.currentTimeMillis();
    // å¤§äº3ç§’ç®—æˆåŠŸï¼Œåœ¨ä¸»çº¿ç¨‹æ›´æ–°UI
    final int second = (int) (stopRecorderTime - startRecorderTime) / 1000;
    if (second > 3) {
        mHandler.post(() -> {
            Toast.makeText(mContext,
                    "å½•éŸ³æˆåŠŸï¼š" + second + "ç§’", Toast.LENGTH_SHORT).show();
            Log.d(TAG, "save in " + startRecorderTime + ".pcm");
            mBtStreamRecorder.setText("å¼€å§‹å½•éŸ³");
        });
    } else {
        recordFail();
        return false;
    }
    return true;
}
```

å½•å–å¤±è´¥ï¼Œæ›´æ–°UIæ“ä½œrecorderFail()

``` java
private void recordFail() {
    mHandler.post(() -> {
        Toast.makeText(mContext,
                "å½•åˆ¶å¤±è´¥ï¼Œå½•éŸ³è¯·å¤§äº3ç§’ï¼", Toast.LENGTH_SHORT).show();
        mBtStreamRecorder.setText("å¼€å§‹å½•éŸ³");
        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.KITKAT) {
            File audioRecordFile = new File(mContext.getExternalFilesDir(Environment.DIRECTORY_DOCUMENTS) +
                    "/AudioRecordDemo/" + startRecorderTime + ".pcm");
            audioRecordFile.delete();
        }
        mIsRecording = false;
    });
}
```

onDestroy()é˜²æ­¢å†…å­˜æ³„æ¼

``` java
@Override
protected void onDestroy() {
    super.onDestroy();
    if (mAudioRecordTest.getAudioRecord() != null) {
        mAudioRecordTest.getAudioRecord().stop();
    }
    if (mExecutorService != null) {
        mExecutorService.shutdownNow();
        mExecutorService = null;
    }
}
```

***

### MediaRecorderï¼ˆåŸºäºæ–‡ä»¶å½•éŸ³ï¼‰

å·²é›†æˆäº†å½•éŸ³ï¼Œç¼–ç ï¼Œå‹ç¼©ç­‰ï¼Œæ”¯æŒå°‘é‡çš„éŸ³é¢‘æ ¼å¼æ–‡ä»¶ã€‚

ä¼˜ç‚¹ï¼šå°è£…åº¦å¾ˆé«˜ï¼Œæ“ä½œç®€å•

ç¼ºç‚¹ï¼šæ— æ³•å®ç°å®æ—¶å¤„ç†éŸ³é¢‘ï¼Œè¾“å‡ºçš„éŸ³é¢‘æ ¼å¼å°‘ã€‚

{% asset_img 1.webp %}

#### MediaRecorder ç±»è¿›è¡ŒéŸ³é¢‘å½•åˆ¶çš„åŸºæœ¬æ­¥éª¤

1. å»ºç«‹ MediaRecorder ç±»çš„å¯¹è±¡ï¼šnew MediaRecorder()

2. è®¾ç½®éŸ³é¢‘æ¥æºï¼šmMediaRecorder.setAudioSource()

3. è®¾ç½®éŸ³é¢‘ç¼–ç æ–¹å¼ï¼šmMediaRecorder.setAudioEncoder()

4. è®¾ç½®éŸ³é¢‘æ–‡ä»¶çš„ä¿å­˜ä½ç½®åŠæ–‡ä»¶åï¼šmMediaRecorder.setOutputFile()

5. å°†å½•éŸ³å™¨ç½®äºå‡†å¤‡çŠ¶æ€ï¼šmMediaRecorder.prepare()

6. å¯åŠ¨å½•éŸ³å™¨ï¼šmMediaRecorder.start()

7. éŸ³é¢‘å½•åˆ¶å®Œæˆï¼Œåœæ­¢å½•éŸ³å™¨ï¼šmMediaRecorder.stop()

8. é‡Šæ”¾å½•éŸ³å™¨å¯¹è±¡ï¼šmMediaRecorder.release()

#### MediaRecorderä¾‹å­ï¼šå½•åˆ¶éŸ³é¢‘

å½•éŸ³JNIå‡½æ•°ä¸å…·æœ‰çº¿ç¨‹å®‰å…¨æ€§ï¼Œå› æ­¤ç”¨å•çº¿ç¨‹

``` java
mExecutorService = Executors.newSingleThreadExecutor();
mHandler = new Handler(Looper.getMainLooper());
mMediaRecorderTest = new MediaRecorderTest.Builder(this)
        .setExecutorService(mExecutorService)
        .setHandler(mHandler)
        .setBtMediaRecorder(mBtMediaRecorder)
        .build();
```

å¼€å¯ä¸€ä¸ªå•çº¿ç¨‹å»å®ç°å½•éŸ³åŠŸèƒ½æŒ‰ä¸‹æŒ‰é’®recordMedia()

``` java
public void recordMedia() {
    if (mIsRecording) {
        mIsRecording = false;
        mBtMediaRecorder.setText("å¼€å§‹å½•éŸ³");
        mExecutorService.submit(this::stopRecorder);
    } else {
        mIsRecording = true;
        mBtMediaRecorder.setText("åœæ­¢å½•éŸ³");
        // æäº¤åå°ä»»åŠ¡ï¼Œæ‰§è¡Œå½•éŸ³é€»è¾‘
        mExecutorService.submit(this::startRecorder);
    }
}
```

å¼€å§‹å½•éŸ³startRecorder()

``` java
private void startRecorder() {
    // é‡Šæ”¾ä¸Šä¸€æ¬¡çš„å½•éŸ³
    releaseRecorder();
    // å¼€å§‹å½•éŸ³
    if (!doStart()) {
        recorderFail();
    }
}
```

å¯åŠ¨å½•éŸ³doStart()

``` java
private boolean doStart() {
    try {
        // åˆ›å»ºMediaRecorder
        mMediaRecorder = new MediaRecorder();
 
        startRecorderTime = System.currentTimeMillis();
 
        // åˆ›å»ºå½•éŸ³æ–‡ä»¶
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
            mRecorderFile = new File(mContext.getExternalFilesDir(Environment.DIRECTORY_DOCUMENTS)
                    + "/MediaRecorderDemo/" + startRecorderTime + ".m4a");
            if (!mRecorderFile.getParentFile().exists()) {
                mRecorderFile.getParentFile().mkdirs();
            }
        } else {
            return false;
        }
 
        mRecorderFile.createNewFile();
 
        // é…ç½®MediaRecorder
 
        // ä»éº¦å…‹é£é‡‡é›†
        mMediaRecorder.setAudioSource(MediaRecorder.AudioSource.MIC);
 
        // ä¿å­˜æ–‡ä»¶ä¸ºMP4æ ¼å¼
        mMediaRecorder.setOutputFormat(MediaRecorder.OutputFormat.MPEG_4);
 
        // æ‰€æœ‰androidç³»ç»Ÿéƒ½æ”¯æŒçš„é€‚ä¸­é‡‡æ ·çš„é¢‘ç‡
        mMediaRecorder.setAudioSamplingRate(44100);
 
        // é€šç”¨çš„AACç¼–ç æ ¼å¼
        mMediaRecorder.setAudioEncoder(MediaRecorder.AudioEncoder.AAC);
 
        // è®¾ç½®éŸ³è´¨é¢‘ç‡
        mMediaRecorder.setAudioEncodingBitRate(96000);
 
        // è®¾ç½®æ–‡ä»¶å½•éŸ³çš„ä½ç½®
        mMediaRecorder.setOutputFile(mRecorderFile.getAbsolutePath());
 
        // å¼€å§‹å½•éŸ³
        mMediaRecorder.prepare();
        mMediaRecorder.start();
 
    } catch (Exception e) {
        Toast.makeText(mContext, "å½•éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•", Toast.LENGTH_SHORT).show();
        return false;
    }
 
    // è®°å½•å¼€å§‹å½•éŸ³æ—¶é—´
 
    return true;
}
```

åœæ­¢å½•éŸ³stopRecorder()

``` java
private void stopRecorder() {
    // æäº¤åå°ä»»åŠ¡ï¼Œåœæ­¢å½•éŸ³
    if (!doStop()) {
        recorderFail();
    }
    releaseRecorder();
}
```

åœæ­¢å½•éŸ³è®¡ç®—æ—¶é•¿doStop()

``` java
private boolean doStop() {
    try {
        mMediaRecorder.stop();
        stopRecorderTime = System.currentTimeMillis();
        final int second = (int) (stopRecorderTime - startRecorderTime) / 1000;
        // æŒ‰ä½æ—¶é—´å°äº3ç§’é’Ÿï¼Œç®—ä½œå½•å–å¤±è´¥ï¼Œä¸è¿›è¡Œå‘é€
        if (second < 3) return false;
        mHandler.post(new Runnable() {
            @Override
            public void run() {
                Toast.makeText(mContext,
                        "å½•éŸ³æˆåŠŸï¼š" + second + "ç§’", Toast.LENGTH_SHORT).show();
                Log.d(TAG, "save in " + startRecorderTime + ".m4a");
            }
        });
    } catch (Exception e) {
        e.printStackTrace();
    }
    return true;
}
```

é‡Šæ”¾MediaRecorderçš„releaseRecorder()

``` java
private void releaseRecorder() {
    if (mMediaRecorder != null) {
        mMediaRecorder.release();
        mMediaRecorder = null;
    }
}
```

è®¾ç½®å½•éŸ³å¤±è´¥çš„é€»è¾‘recorderFail()

``` java
private void recorderFail() {
    mRecorderFile = null;
    mHandler.post(new Runnable() {
        @Override
        public void run() {
            Toast.makeText(mContext,
                    "å½•åˆ¶å¤±è´¥ï¼Œå½•éŸ³è¯·å¤§äº3ç§’ï¼", Toast.LENGTH_SHORT).show();
            mBtMediaRecorder.setText("å¼€å§‹å½•éŸ³");
            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.KITKAT) {
                File audioRecordFile = new File(mContext.getExternalFilesDir(Environment.DIRECTORY_DOCUMENTS) +
                        "/MediaRecorderDemo/" + startRecorderTime + ".m4a");
                audioRecordFile.delete();
            }
        }
    });
}
```

è®°å¾—åœ¨onDestroy()é˜²æ­¢å†…å­˜æ³„æ¼

``` java
@Override
protected void onDestroy() {
    super.onDestroy();
    if (mMediaRecorderTest.getMediaRecorder() != null) {
        mMediaRecorderTest.getMediaRecorder().stop();
    }
    if (mExecutorService != null) {
        mExecutorService.shutdownNow();
        mExecutorService = null;
    }
}
```
