---
title: Android-éŸ³è§†é¢‘-AACç¼–ç 
categories:
  - ğŸŒ™é€¢å‚æ‚è°ˆä¸æ¬è¿
  - â­ä¸€äº›æŠ€æœ¯
abbrlink: 18fff05b
date: 2021-10-21 15:58:44
tags:
---

### ä»€ä¹ˆæ˜¯AAC

#### ç®€ä»‹

AACæ˜¯é«˜çº§éŸ³é¢‘ç¼–ç ï¼ˆAdvanced Audio Codingï¼‰çš„ç¼©å†™ï¼Œå‡ºç°äº1997å¹´ï¼Œæœ€åˆæ˜¯åŸºäºMPEG-2çš„éŸ³é¢‘ç¼–ç æŠ€æœ¯ã€‚ç”±Fraunhofer IISã€Dolby Laboratoriesã€AT&Tã€Sonyç­‰å…¬å¸å…±åŒå¼€å‘ï¼Œç›®çš„æ˜¯å–ä»£MP3æ ¼å¼ã€‚2000å¹´ï¼ŒMPEG-4æ ‡å‡†å‡ºå°ï¼ŒAACé‡æ–°é›†æˆäº†å…¶å®ƒæŠ€æœ¯ï¼ˆPS,SBRï¼‰ï¼Œä¸ºåŒºåˆ«äºä¼ ç»Ÿçš„MPEG-2 AACï¼Œæ•…å«æœ‰SBRæˆ–PSç‰¹æ€§çš„AACåˆç§°ä¸ºMPEG-4 AACã€‚

AACé€šå¸¸å‹ç¼©æ¯”ä¸º18ï¼š1ï¼Œä¹Ÿæœ‰èµ„æ–™è¯´ä¸º20ï¼š1ï¼Œè¿œèƒœmp3ã€‚

<!--more-->

#### ç‰¹ç‚¹

1. AACæ˜¯ä¸€ç§é«˜å‹ç¼©æ¯”çš„éŸ³é¢‘å‹ç¼©ç®—æ³•ï¼Œä½†å®ƒçš„å‹ç¼©æ¯”è¦è¿œè¶…è¿‡è¾ƒè€çš„éŸ³é¢‘å‹ç¼©ç®—æ³•ï¼Œå¦‚AC-3ã€MP3ç­‰ã€‚å¹¶ä¸”å…¶è´¨é‡å¯ä»¥åŒæœªå‹ç¼©çš„CDéŸ³è´¨ç›¸åª²ç¾ã€‚

2. åŒå…¶ä»–ç±»ä¼¼çš„éŸ³é¢‘ç¼–ç ç®—æ³•ä¸€æ ·ï¼ŒAACä¹Ÿæ˜¯é‡‡ç”¨äº†å˜æ¢ç¼–ç ç®—æ³•ï¼Œä½†AACä½¿ç”¨äº†åˆ†è¾¨ç‡æ›´é«˜çš„æ»¤æ³¢å™¨ç»„ï¼Œå› æ­¤å®ƒå¯ä»¥è¾¾åˆ°æ›´é«˜çš„å‹ç¼©æ¯”ã€‚

3. AACä½¿ç”¨äº†ä¸´æ—¶å™ªå£°é‡æ•´ã€åå‘è‡ªé€‚åº”çº¿æ€§é¢„æµ‹ã€è”åˆç«‹ä½“å£°æŠ€æœ¯å’Œé‡åŒ–å“ˆå¤«æ›¼ç¼–ç ç­‰æœ€æ–°æŠ€æœ¯ï¼Œè¿™äº›æ–°æŠ€æœ¯çš„ä½¿ç”¨éƒ½ä½¿å‹ç¼©æ¯”å¾—åˆ°è¿›ä¸€æ­¥çš„æé«˜ã€‚

4. AACæ”¯æŒæ›´å¤šç§é‡‡æ ·ç‡å’Œæ¯”ç‰¹ç‡ã€æ”¯æŒ1ä¸ªåˆ°48ä¸ªéŸ³è½¨ã€æ”¯æŒå¤šè¾¾15ä¸ªä½é¢‘éŸ³è½¨ã€å…·æœ‰å¤šç§è¯­è¨€çš„å…¼å®¹èƒ½åŠ›ã€è¿˜æœ‰å¤šè¾¾15ä¸ªå†…åµŒæ•°æ®æµã€‚

5. AACæ”¯æŒæ›´å®½çš„å£°éŸ³é¢‘ç‡èŒƒå›´ï¼Œæœ€é«˜å¯è¾¾åˆ°96kHzï¼Œæœ€ä½å¯è¾¾8KHzï¼Œè¿œå®½äºMP3çš„16KHz-48kHzçš„èŒƒå›´ã€‚

6. ä¸åŒäºMP3åŠWMAï¼ŒAACå‡ ä¹ä¸æŸå¤±å£°éŸ³é¢‘ç‡ä¸­çš„ç”šé«˜ã€ç”šä½é¢‘ç‡æˆåˆ†ï¼Œå¹¶ä¸”æ¯”WMAåœ¨é¢‘è°±ç»“æ„ä¸Šæ›´æ¥è¿‘äºåŸå§‹éŸ³é¢‘ï¼Œå› è€Œå£°éŸ³çš„ä¿çœŸåº¦æ›´å¥½ã€‚ä¸“ä¸šè¯„æµ‹ä¸­è¡¨æ˜ï¼ŒAACæ¯”WMAå£°éŸ³æ›´æ¸…æ™°ï¼Œè€Œä¸”æ›´æ¥è¿‘åŸéŸ³ã€‚

7. AACé‡‡ç”¨ä¼˜åŒ–çš„ç®—æ³•è¾¾åˆ°äº†æ›´é«˜çš„è§£ç æ•ˆç‡ï¼Œè§£ç æ—¶åªéœ€è¾ƒå°‘çš„å¤„ç†èƒ½åŠ›ã€‚

#### ç¼–ç æ–¹å¼

AACéŸ³é¢‘æ ¼å¼æœ‰ADIFå’ŒADTSï¼š

**ADIFï¼š**Audio Data Interchange Format éŸ³é¢‘æ•°æ®äº¤æ¢æ ¼å¼ã€‚è¿™ç§æ ¼å¼çš„ç‰¹å¾æ˜¯å¯ä»¥ç¡®å®šçš„æ‰¾åˆ°è¿™ä¸ªéŸ³é¢‘æ•°æ®çš„å¼€å§‹ï¼Œä¸éœ€è¿›è¡Œåœ¨éŸ³é¢‘æ•°æ®æµä¸­é—´å¼€å§‹çš„è§£ç ï¼Œå³å®ƒçš„è§£ç å¿…é¡»åœ¨æ˜ç¡®å®šä¹‰çš„å¼€å§‹å¤„è¿›è¡Œã€‚æ•…è¿™ç§æ ¼å¼å¸¸ç”¨åœ¨ç£ç›˜æ–‡ä»¶ä¸­ã€‚

**ADTSï¼š**Audio Data Transport Stream éŸ³é¢‘æ•°æ®ä¼ è¾“æµã€‚è¿™ç§æ ¼å¼çš„ç‰¹å¾æ˜¯å®ƒæ˜¯ä¸€ä¸ªæœ‰åŒæ­¥å­—çš„æ¯”ç‰¹æµï¼Œè§£ç å¯ä»¥åœ¨è¿™ä¸ªæµä¸­ä»»ä½•ä½ç½®å¼€å§‹ã€‚å®ƒçš„ç‰¹å¾ç±»ä¼¼äºmp3æ•°æ®æµæ ¼å¼ã€‚

ç®€å•è¯´ï¼ŒADTSå¯ä»¥åœ¨ä»»æ„å¸§è§£ç ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ¯ä¸€å¸§éƒ½æœ‰å¤´ä¿¡æ¯ã€‚ADIFåªæœ‰ä¸€ä¸ªç»Ÿä¸€çš„å¤´ï¼Œæ‰€ä»¥å¿…é¡»å¾—åˆ°æ‰€æœ‰çš„æ•°æ®åè§£ç ã€‚ä¸”è¿™ä¸¤ç§çš„headerçš„æ ¼å¼ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œç›®å‰ä¸€èˆ¬ç¼–ç åçš„å’ŒæŠ½å–å‡ºçš„éƒ½æ˜¯ADTSæ ¼å¼çš„éŸ³é¢‘æµã€‚

ADTSæ˜¯å¸§åºåˆ—ï¼Œæœ¬èº«å…·å¤‡æµç‰¹å¾ï¼Œåœ¨éŸ³é¢‘æµçš„ä¼ è¾“ä¸å¤„ç†æ–¹é¢æ›´åŠ åˆé€‚ã€‚

***

### ADIFç¼–ç 

**ADIFï¼š**Audio Data Interchange Format éŸ³é¢‘æ•°æ®äº¤æ¢æ ¼å¼ã€‚è¿™ç§æ ¼å¼çš„ç‰¹å¾æ˜¯å¯ä»¥ç¡®å®šçš„æ‰¾åˆ°è¿™ä¸ªéŸ³é¢‘æ•°æ®çš„å¼€å§‹ï¼Œä¸éœ€è¿›è¡Œåœ¨éŸ³é¢‘æ•°æ®æµä¸­é—´å¼€å§‹çš„è§£ç ï¼Œå³å®ƒçš„è§£ç å¿…é¡»åœ¨æ˜ç¡®å®šä¹‰çš„å¼€å§‹å¤„è¿›è¡Œã€‚æ•…è¿™ç§æ ¼å¼å¸¸ç”¨åœ¨ç£ç›˜æ–‡ä»¶ä¸­ã€‚

{% asset_img 3.webp %}

ADIFåªæœ‰ä¸€ä¸ªæ–‡ä»¶å¤´ã€‚

#### ADIFå¤´ä¿¡æ¯

{% asset_img 4.webp %}

***

### ADTSç¼–ç 

**ADTSï¼š**Audio Data Transport Stream éŸ³é¢‘æ•°æ®ä¼ è¾“æµã€‚è¿™ç§æ ¼å¼çš„ç‰¹å¾æ˜¯å®ƒæ˜¯ä¸€ä¸ªæœ‰åŒæ­¥å­—çš„æ¯”ç‰¹æµï¼Œè§£ç å¯ä»¥åœ¨è¿™ä¸ªæµä¸­ä»»ä½•ä½ç½®å¼€å§‹ã€‚å®ƒçš„ç‰¹å¾ç±»ä¼¼äºmp3æ•°æ®æµæ ¼å¼ã€‚è¿™ç§æ ¼å¼å¯ä»¥ç”¨äºå¹¿æ’­ç”µè§†ã€‚

{% asset_img 1.webp %}

å¯ä»¥çœ‹åˆ°ADTSçš„æ¯ä¸€å¸§éƒ½æœ‰å¤´ä¿¡æ¯ï¼Œå³ADTS_headerï¼ŒADTSå¤´ä¸­ç›¸å¯¹æœ‰ç”¨çš„ä¿¡æ¯æ˜¯é‡‡æ ·ç‡ã€å£°é“æ•°ã€å¸§é•¿åº¦ã€‚ä¸€èˆ¬ADTSå¤´ä¿¡æ¯éƒ½æ˜¯7å­—èŠ‚ï¼Œå¦‚æœæœ‰CRCåˆ™ä¸º9å­—èŠ‚ã€‚

ADTSæ¯ä¸ªåŒ…å‰é¢æœ‰ä¸€ä¸ªæ–‡ä»¶å¤´ã€‚

#### ADTSå¤´ä¿¡æ¯

{% asset_img 5.webp %}

#### ADTSå¸§é¦–éƒ¨ç»“æ„

| åºå· | åŸŸ | é•¿åº¦ï¼ˆbitsï¼‰ | è¯´æ˜ |
| ---- | -- | ----------- | ---- |
| 1 | Syncword | 12 | all bits must be 1 |
| 2 | MPEG version | 1 | 0 for MPEG-4, 1 for MPEG-2 |
| 3 | Layer | 2 | always 0 |
| 4 | Protection Absent | 1 | et to 1 if there is no CRC and 0 if there is CRC |
| 5 | Profile | 2 | the MPEG-4 Audio Object Type minus 1 |
| 6 | MPEG-4 Sampling Frequency Index | 4 | MPEG-4 Sampling Frequency Index (15 is forbidden) |
| 7 | Private Stream | 1 | set to 0 when encoding, ignore when decoding |
| 8 | MPEG-4 Channel Configuration | 3 | MPEG-4 Channel Configuration (in the case of 0, the channel configuration is sent via an inband PCE) |
| 9 | Originality | 1 | set to 0 when encoding, ignore when decoding |
| 10 | Home | 1 | set to 0 when encoding, ignore when decoding |
| 11 | Copyrighted Stream | 1 | set to 0 when encoding, ignore when decoding |
| 12 | Copyrighted Start | 1 | set to 0 when encoding, ignore when decoding |
| 13 | Frame Length | 13 | this value must include 7 or 9 bytes of header length: FrameLength = (ProtectionAbsent == 1 ? 7 : 9) + size(AACFrame) |
| 14 | Buffer Fullness | 11 | buffer fullness |
| 15 | Number of AAC Frames | 2 | number of AAC frames (RDBs) in ADTS frame minus 1, for maximum compatibility always use 1 AAC frame per ADTS frame |
| 16 | CRC | 16 | CRC if protection absent is 0 |

#### ADTSå¤´éƒ¨çš„ç”Ÿæˆ

``` java
/**
 * æ·»åŠ ADTSå¤´éƒ¨
 *
 * @param packet    ADTS header çš„ byte[]ï¼Œé•¿åº¦ä¸º7
 * @param packetLen è¯¥å¸§çš„é•¿åº¦ï¼ŒåŒ…æ‹¬headerçš„é•¿åº¦
 */
private void addADTStoPacket(byte[] packet, int packetLen) {
    int profile = 2; // AAC LC
    int freqIdx = 3; // 48000Hz
    int chanCfg = 2; // 2 Channel

    packet[0] = (byte) 0xFF;
    packet[1] = (byte) 0xF9;
    packet[2] = (byte) (((profile - 1) << 6) + (freqIdx << 2) + (chanCfg >> 2));
    packet[3] = (byte) (((chanCfg & 3) << 6) + (packetLen >> 11));
    packet[4] = (byte) ((packetLen & 0x7FF) >> 3);
    packet[5] = (byte) (((packetLen & 7) << 5) + 0x1F);
    packet[6] = (byte) 0xFC;
}
```

å…¶ä¸­profileè¡¨ç¤ºä½¿ç”¨å“ªä¸ªçº§åˆ«çš„AACï¼Œåœ¨MPEG-2 AACä¸­å®šä¹‰äº†3ç§ï¼š

{% asset_img 2.webp %}

freqIdxè¡¨ç¤ºä½¿ç”¨çš„é‡‡æ ·ç‡ä¸‹æ ‡ï¼Œé€šè¿‡è¿™ä¸ªä¸‹æ ‡åœ¨ Sampling Frequencies[ ]æ•°ç»„ä¸­æŸ¥æ‰¾å¾—çŸ¥é‡‡æ ·ç‡çš„å€¼ï¼š

| freqIdx | é‡‡æ ·ç‡ï¼ˆHzï¼‰ | freqIdx | é‡‡æ ·ç‡ï¼ˆHzï¼‰ |
| ------- | ----------- | ------- | ----------- |
| 0 | 96000Hz | 1 | 88200Hz |
| 2 | 64000Hz | 3 | 48000Hz |
| 4 | 44100Hz | 5 | 32000Hz |
| 6 | 24000Hz | 7 | 22050Hz |
| 8 | 16000Hz | 9 | 12000Hz |
| 10 | 11025Hz | 11 | 8000Hz |
| 12 | 7350Hz | 13 | Reserved |
| 14 | Reserved | 15 | frequency is written explictly |

chanCfgè¡¨ç¤ºå£°é“æ•°ï¼š

| chanCfg | å£°é“æ•° | chanCfg | å£°é“æ•° |
| ------- | ------ | ------- | ----- |
| 0 | Defined in AOT Specifc Config | 1 | 1 channel: front-center |
| 2 | 2 channels: front-left, front-right | 3 | 3 channels: front-center, front-left, front-right |
| 4 | 4 channels: front-center, front-left, front-right, back-center | 5 | 5 channels: front-center, front-left, front-right, back-left, back-right |
| 6 | 6 channels: front-center, front-left, front-right, back-left, back-right, LFE-channel | 7 | 8 channels: front-center, front-left, front-right, side-left, side-right, back-left, back-right, LFE-channel |
| 8-15 | Reserved |

***

#### AACçš„è§£æ

``` java
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.nio.ByteBuffer;
import java.util.HashMap;
import java.util.Map;

public class AACHelper {
    // é‡‡æ ·é¢‘ç‡å¯¹ç…§è¡¨
    private static Map<Integer, Integer> samplingFrequencyIndexMap = new HashMap<>();

    static {
        samplingFrequencyIndexMap.put(96000, 0);
        samplingFrequencyIndexMap.put(88200, 1);
        samplingFrequencyIndexMap.put(64000, 2);
        samplingFrequencyIndexMap.put(48000, 3);
        samplingFrequencyIndexMap.put(44100, 4);
        samplingFrequencyIndexMap.put(32000, 5);
        samplingFrequencyIndexMap.put(24000, 6);
        samplingFrequencyIndexMap.put(22050, 7);
        samplingFrequencyIndexMap.put(16000, 8);
        samplingFrequencyIndexMap.put(12000, 9);
        samplingFrequencyIndexMap.put(11025, 10);
        samplingFrequencyIndexMap.put(8000, 11);
        samplingFrequencyIndexMap.put(0x0, 96000);
        samplingFrequencyIndexMap.put(0x1, 88200);
        samplingFrequencyIndexMap.put(0x2, 64000);
        samplingFrequencyIndexMap.put(0x3, 48000);
        samplingFrequencyIndexMap.put(0x4, 44100);
        samplingFrequencyIndexMap.put(0x5, 32000);
        samplingFrequencyIndexMap.put(0x6, 24000);
        samplingFrequencyIndexMap.put(0x7, 22050);
        samplingFrequencyIndexMap.put(0x8, 16000);
        samplingFrequencyIndexMap.put(0x9, 12000);
        samplingFrequencyIndexMap.put(0xa, 11025);
        samplingFrequencyIndexMap.put(0xb, 8000);
    }

    private AdtsHeader mAdtsHeader = new AdtsHeader();
    private BitReader mHeaderBitReader = new BitReader(new byte[7]);
    private byte[] mSkipTwoBytes = new byte[2];
    private FileInputStream mFileInputStream;
    private byte[] mBytes = new byte[1024];

    /**
     * æ„é€ å‡½æ•°ï¼Œé€šè¿‡ä¼ é€’è¿›æ¥çš„æ–‡ä»¶è·¯å¾„åˆ›å»ºè¾“å…¥æµ
     *
     * @param aacFilePath AACæ–‡ä»¶è·¯å¾„
     * @throws FileNotFoundException
     */
    public AACHelper(String aacFilePath) throws FileNotFoundException {
        mFileInputStream = new FileInputStream(aacFilePath);
    }

    /**
     * è·å–ä¸‹ä¸€Sampleæ•°æ®
     *
     * @param byteBuffer å­˜æ”¾Sampleæ•°æ®çš„ByteBuffer
     * @return å½“å‰Sampleçš„byte[]å¤§å°ï¼Œå¦‚æœä¸ºç©ºè¿”å›-1
     * @throws IOException
     */
    public int getSample(ByteBuffer byteBuffer) throws IOException {
        if (readADTSHeader(mAdtsHeader, mFileInputStream)) {
            int length = mFileInputStream.read(mBytes, 0, mAdtsHeader.frameLength - mAdtsHeader.getSize());
            byteBuffer.clear();
            byteBuffer.put(mBytes, 0, length);
            byteBuffer.position(0);
            byteBuffer.limit(length);
            return length;
        }
        return -1;
    }

    /**
     * ä»AACæ–‡ä»¶æµä¸­è¯»å–ADTSå¤´éƒ¨
     *
     * @param adtsHeader      ADTSå¤´éƒ¨
     * @param fileInputStream AACæ–‡ä»¶æµ
     * @return æ˜¯å¦è¯»å–æˆåŠŸ
     * @throws IOException
     */
    private boolean readADTSHeader(AdtsHeader adtsHeader, FileInputStream fileInputStream) throws IOException {
        if (fileInputStream.read(mHeaderBitReader.buffer) < 7) {
            return false;
        }

        mHeaderBitReader.position = 0;

        int syncWord = mHeaderBitReader.readBits(12); // A
        if (syncWord != 0xfff) {
            throw new IOException("Expected Start Word 0xfff");
        }
        adtsHeader.mpegVersion = mHeaderBitReader.readBits(1); // B
        adtsHeader.layer = mHeaderBitReader.readBits(2); // C
        adtsHeader.protectionAbsent = mHeaderBitReader.readBits(1); // D
        adtsHeader.profile = mHeaderBitReader.readBits(2) + 1;  // E
        adtsHeader.sampleFrequencyIndex = mHeaderBitReader.readBits(4);
        adtsHeader.sampleRate = samplingFrequencyIndexMap.get(adtsHeader.sampleFrequencyIndex); // F
        mHeaderBitReader.readBits(1); // G
        adtsHeader.channelconfig = mHeaderBitReader.readBits(3); // H
        adtsHeader.original = mHeaderBitReader.readBits(1); // I
        adtsHeader.home = mHeaderBitReader.readBits(1); // J
        adtsHeader.copyrightedStream = mHeaderBitReader.readBits(1); // K
        adtsHeader.copyrightStart = mHeaderBitReader.readBits(1); // L
        adtsHeader.frameLength = mHeaderBitReader.readBits(13); // M
        adtsHeader.bufferFullness = mHeaderBitReader.readBits(11); // 54
        adtsHeader.numAacFramesPerAdtsFrame = mHeaderBitReader.readBits(2) + 1; // 56
        if (adtsHeader.numAacFramesPerAdtsFrame != 1) {
            throw new IOException("This muxer can only work with 1 AAC frame per ADTS frame");
        }
        if (adtsHeader.protectionAbsent == 0) {
            fileInputStream.read(mSkipTwoBytes);
        }
        return true;
    }

    /**
     * é‡Šæ”¾èµ„æº
     *
     * @throws IOException
     */
    public void release() throws IOException {
        mFileInputStream.close();
    }

    /**
     * ADTSå¤´éƒ¨
     */
    private class AdtsHeader {
        int getSize() {
            return 7 + (protectionAbsent == 0 ? 2 : 0);
        }

        int sampleFrequencyIndex;

        int mpegVersion;
        int layer;
        int protectionAbsent;
        int profile;
        int sampleRate;

        int channelconfig;
        int original;
        int home;
        int copyrightedStream;
        int copyrightStart;
        int frameLength;
        int bufferFullness;
        int numAacFramesPerAdtsFrame;
    }
}
```

***

### å‚è€ƒä¸é¸£è°¢

> <https://www.jianshu.com/p/839b11e0638b>
> <https://www.jianshu.com/p/b5ca697535bd>
> <https://blog.csdn.net/leixiaohua1020/article/details/11822537>
