---
title: Android-éŸ³è§†é¢‘-éŸ³é¢‘å¼€å‘-ï¼ˆå››ï¼‰éŸ³é¢‘å¤„ç†
categories:
  - ğŸŒ™åŸºç¡€å­¦ä¹ 
  - â­Android
abbrlink: 555ed0ac
date: 2021-09-25 16:07:20
tags:
---

### æ‹¼æ¥

ä¸‹å›¾æ˜¯pcmæ•°æ®çš„å‚¨å­˜ï¼š

{% asset_img 1.webp %}

å°†ä¸¤ä¸ªpcmæ•°æ®è¿›è¡Œåˆå¹¶åªéœ€å°†è¿™ä¸¤ä¸ªpcmæ•°æ®ç›´æ¥è¿ç»­å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­å°±èƒ½å¤Ÿè·å¾—ä¸€ä¸ªæ‹¼æ¥å¥½çš„æ•°æ®ã€‚è¦æ³¨æ„çš„æ˜¯è¦æ§åˆ¶å¥½å†™å…¥çš„bufferå¤§å°è¿™æ ·æ‰èƒ½ä¿è¯æ•°æ®å†™å…¥çš„é€Ÿåº¦ï¼ˆä¾‹å¦‚1kbï¼‰

<!--more-->

éŸ³é¢‘æ‹¼æ¥

``` java
DataInputStream ins1 = new DataInputStream(new BufferedInputStream(new FileInputStream(file1.file)));
DataInputStream ins2 = new DataInputStream(new BufferedInputStream(new FileInputStream(file2.file)));
DataOutputStream outputStream  = new DataOutputStream(new BufferedOutputStream(new FileOutputStream(file)));
byte[] bytes = new byte[1024];
byte[] bytes2 = new byte[1024];
boolean isfinish1= false;
boolean isfinish2 = false;
while(!isfinish1){
    int temp = ins1.read(bytes);
    if(temp <= 0){
        isfinish1 = true;
    } else {
        outputStream.write(bytes);
    }
}
while(!isfinish2){
    int temp = ins2.read(bytes2);
    if(temp <= 0){
        isfinish2 = true;
    } else {
        outputStream.write(bytes2);
    }
}
ins1.close();
ins2.close();
outputStream.close();
```

***

### è£å‰ª

å‰ªpcmå’Œæ‹¼æ¥pcmç›¸ä¼¼ï¼Œä¸€ä¸ªæ˜¯å°†ä¸¤ä¸ªæ–‡ä»¶å†™å…¥ä¸€ä¸ªæ–‡ä»¶ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶ä¸­çš„ä¸€æ®µå†™å…¥å¦å¤–ä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦çš„é—®é¢˜æ˜¯å¦‚ä½•ç¡®å®šæ•°æ®æ‰€è¡¨æ˜çš„æ—¶é—´ç‚¹ã€‚

è¿™é‡Œè¦ç»è¿‡è®¡ç®—è·å¾—å¼€å§‹å†™å…¥å’Œç»“æŸå†™å…¥çš„æ•°æ®ä½ç½®ï¼Œç»è¿‡é‡‡æ ·ç‡ã€å£°é“æ•°å’Œæ¯”ç‰¹æ•°æ¥è·å¾—æ¯ç§’çš„æ•°æ®é‡ã€‚

æ¯ç§’æ•°æ®é‡ = é‡‡æ ·ç‡ âˆ— å£°é“æ•° âˆ— æ¯”ç‰¹æ•° / 1000 / 8

éŸ³é¢‘è£å‰ª

``` java
DataInputStream inputStream = new DataInputStream(new BufferedInputStream(new FileInputStream(source.file)));
DataOutputStream outputStream = new DataOutputStream(new BufferedOutputStream(new FileOutputStream(file)));
int audioFormat = 0;
if(source.bit_num == 16){
    audioFormat = AudioFormat.ENCODING_PCM_16BIT;
} else {
    audioFormat = AudioFormat.ENCODING_PCM_8BIT;
}
int bufferSize = AudioRecord.getMinBufferSize(source.sample_rage_hz,source.channel,audioFormat);
byte[] buffer = new byte[bufferSize * 2];
int sample = source.getSampleNuit();
while(start < end){
    inputStream.read(buffer,0,buffer.length);
    outputStream.write(buffer, 0, buffer.length);
    start = (bufferSize * 2 + start * sample) / sample;
}
inputStream.close();
outputStream.close();
```

***

### æ··éŸ³

#### çº¿æ€§å åŠ åæ±‚å¹³å‡

å¯¹äºpcmçš„æ··éŸ³åŸç†æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ•°æ®çš„åŠ å’Œï¼Œå¯æ˜¯ä¸ä¸€æ ·åŠ å’Œè·å¾—çš„æ•ˆæœæ˜¯ä¸åŒçš„ã€‚ä¾‹å¦‚æ­¤æ ·ä¾‹å°±æ˜¯ç”¨äº†æœ€ç®€å•çš„çº¿æ€§å åŠ åæ±‚å¹³å‡ã€‚å°±æ˜¯ä¸¤ä¸ªpcmæ–‡ä»¶å¯¹åº”çš„æ•°å€¼å‘åŠ é™¤ä»¥2ï¼Œå›ºç„¶ä¸ºäº†èƒ½å¤Ÿè°ƒèŠ‚è¿™ä¸¤ä¸ªéŸ³é¢‘å£°éŸ³å¤§å°ï¼Œèƒ½å¤Ÿåœ¨æ¯ä¸€ä¸ªæ•°æ®ä»¥å‰ä¹˜ä»¥ä¸€ä¸ªç³»æ•°ã€‚

æ•°æ®ç»“æœ = [(pcmæ•°æ®1 âˆ— ç³»æ•°1) + (pcmæ•°æ®2 âˆ— ç³»æ•°2)] / 2

ä¼˜åŠ¿ï¼šä¸ä¼šäº§ç”Ÿæº¢å‡ºï¼Œå™ªéŸ³è¾ƒå°

ç¼ºç‚¹ï¼šè¡°å‡è¿‡å¤§ï¼Œå½±å“è´¨é‡

è¿˜æœ‰å¤æ‚çš„æ–¹æ³•ï¼šä¾‹å¦‚å½’ä¸€åŒ–æ··éŸ³å’Œä»æ–°é‡‡æ ·æ³•ç­‰ã€‚

éŸ³é¢‘æ··éŸ³â€”â€”â€”â€”çº¿æ€§å åŠ åæ±‚å¹³å‡

``` java
private byte remixAVG(byte buffer1, byte buffer2) {
    int value = (buffer1 + buffer2) / 2;
    return (byte) value;
}
```

#### å½’ä¸€åŒ–æ··éŸ³ï¼ˆè‡ªé€‚åº”åŠ æƒæ··éŸ³ç®—æ³•ï¼‰

ä½¿ç”¨æ›´å¤šçš„ä½æ•°ï¼ˆ32 bitï¼‰æ¥è¡¨ç¤ºéŸ³é¢‘æ•°æ®çš„ä¸€ä¸ªæ ·æœ¬ï¼Œæ··å®ŒéŸ³ååœ¨æƒ³åŠæ³•ä¸‹é™å…¶æŒ¯å¹…ï¼Œä½¿å…¶ä»æ—§åˆ†å¸ƒåœ¨16 bitæ‰€èƒ½è¡¨ç¤ºçš„èŒƒå›´ä»¥å†…ã€‚

ä¸ºé¿å…å‘ç”Ÿæº¢å‡ºï¼Œä½¿ç”¨ä¸€ä¸ªå¯å˜çš„è¡°å‡å› å­å¯¹è¯­éŸ³è¿›è¡Œè¡°å‡ã€‚è¿™ä¸ªè¡°å‡å› å­ä¹Ÿå°±è¡¨æ˜è¯­éŸ³çš„æƒé‡ï¼Œè¡°å‡å› å­éšç€éŸ³é¢‘æ•°æ®çš„å˜åŒ–è€Œå˜åŒ–ï¼Œå› æ­¤ç§°ä¸ºè‡ªé€‚åº”åŠ æƒæ··éŸ³ã€‚å½“æº¢å‡ºæ—¶ï¼Œè¡°å‡å› å­è¾ƒå°ï¼Œä½¿å¾—æº¢å‡ºçš„æ•°æ®åœ¨è¡°å‡åå¯ä»¥å¤„äºä¸´ç•Œå€¼ä¹‹å†…ï¼Œè€Œåœ¨æ²¡æœ‰æº¢å‡ºæ—¶ï¼Œåˆè®©è¡°å‡å› å­æ…¢æ…¢å¢å¤§ï¼Œä½¿æ•°æ®è¾ƒä¸ºå¹³ç¼“çš„å˜åŒ–ã€‚

åŸºæœ¬å…¬å¼æ˜¯ï¼šC = A + B - A*B / (æ•°æ®ç±»å‹çš„æœ€å¤§å€¼)ï¼ˆbyteæ•°æ®å°±æ˜¯ï¼šC = A + B - A*B / 127; shortæ•°æ®å°±æ˜¯ï¼šC = A + B - A * B / 32767;ï¼‰

éŸ³é¢‘æ··éŸ³â€”â€”å½’ä¸€åŒ–æ··éŸ³ï¼ˆè‡ªé€‚åº”åŠ æƒæ··éŸ³ç®—æ³•ï¼‰

``` java
private short remixNOR(short buffer1, short buffer2) {
    int value;
    if (buffer1 < 0 && buffer2 < 0) {
        value = (int) (buffer1 + buffer2 - buffer1 * buffer2 / (-(Math.pow(2,16-1)-1)));
    } else {
        value = (int) (buffer1 + buffer2 - buffer1 * buffer2 / (Math.pow(2,16-1)-1));
    }
    return (short) value;
}
```

***

### é™å™ª

#### å¸¸è§çš„å¼€æºé™å™ªæ–¹æ¡ˆ

Speexï¼šSpeexæ˜¯ä¸€å¥—ä¸»è¦é’ˆå¯¹è¯­éŸ³çš„å¼€æºå…è´¹ï¼Œæ— ä¸“åˆ©ä¿æŠ¤çš„åº”ç”¨é›†åˆï¼Œå®ƒä¸ä»…åŒ…æ‹¬ç¼–è§£ç å™¨ï¼Œè¿˜åŒ…æ‹¬VAD(è¯­éŸ³æ£€æµ‹)ã€DTX(ä¸è¿ç»­ä¼ è¾“)ã€AEC(å›å£°æ¶ˆé™¤)ã€NS(å»å™ª)ç­‰å®ç”¨æ¨¡å—ã€‚

RNNoiseï¼šRNNoiseé™å™ªç®—æ³•æ˜¯æ ¹æ®çº¯è¯­éŸ³ä»¥åŠå™ªå£°é€šè¿‡GRUè®­ç»ƒæ¥åšã€‚åŒ…å«ç‰¹å¾ç‚¹æå–ã€é¢„æ–™ç­‰æ ¸å¿ƒéƒ¨åˆ†ã€‚

WebRTCï¼šWebRTCæä¾›äº†è§†é¢‘ä¼šè®®çš„æ ¸å¿ƒæŠ€æœ¯ï¼ŒåŒ…æ‹¬éŸ³è§†é¢‘çš„é‡‡é›†ã€ç¼–è§£ç ã€ç½‘ç»œä¼ è¾“ã€æ˜¾ç¤ºç­‰åŠŸèƒ½ï¼Œå¹¶ä¸”è¿˜æ”¯æŒè·¨å¹³å°ï¼šWindowsã€Linuxã€Macã€Androidã€‚ä½¿ç”¨çš„å°±æ˜¯WebRTCçš„éŸ³é¢‘å¤„ç†æ¨¡å—audio_processing

#### RNNoiseé™å™ªæ–¹æ¡ˆ

ä¼ ç»Ÿé™å™ªç®—æ³•å¤§éƒ¨åˆ†æ˜¯ä¼°è®¡å™ªå£°+ç»´çº³æ»¤æ³¢ï¼Œå™ªå£°ä¼°è®¡çš„å‡†ç¡®æ€§æ˜¯æ•´ä¸ªç®—æ³•æ•ˆæœçš„æ ¸å¿ƒã€‚æ ¹æ®å™ªå£°çš„ä¸åŒå¤§éƒ¨åˆ†å¤„ç†æ˜¯é’ˆå¯¹å¹³ç¨³å™ªå£°ä»¥åŠç¬æ—¶å™ªå£°æ¥åšã€‚

RNNoiseçš„ä¼˜ç‚¹ä¸»è¦æ˜¯ä¸€ä¸ªç®—æ³•é€šè¿‡è®­ç»ƒå¯ä»¥è§£å†³æ‰€æœ‰å™ªå£°åœºæ™¯ä»¥åŠå¯ä»¥ä¼˜åŒ–ä¼ ç»Ÿå™ªå£°ä¼°è®¡çš„æ—¶å»¶å’Œæ”¶æ•›é—®é¢˜ã€‚

RNNoiseçš„ç¼ºç‚¹æ˜¯æ·±åº¦å­¦ä¹ ç®—æ³•è½åœ°é—®é¢˜ã€‚å› ä¸ºç›¸å¯¹å¤§éƒ¨åˆ†ä¼ ç»Ÿç®—æ³•ï¼ŒRNNoiseè®­ç»ƒè¦å¾—åˆ°ä¸€ä¸ªå¾ˆå¥½çš„æ•ˆæœï¼Œç”±äºç‰¹å¾ç‚¹ä¸ªæ•°ã€éšè—å•å…ƒçš„ä¸ªæ•°ä»¥åŠç¥ç»ç½‘ç»œå±‚æ•°çš„å¢åŠ ï¼Œå¯¼è‡´æ¨¡å‹å¢å¤§ï¼Œè¿è¡Œæ•ˆç‡ã€‚

æ€»çš„æ¥è¯´ï¼ŒRNNoiseå¤„ç†ä¹‹åçš„æ•°æ®æ›´å¹²å‡€äº›ï¼Œå‡ ä¹æ²¡æœ‰ç”µæµéŸ³å’Œæ‚éŸ³ï¼Œä½†æ˜¯å—é™äºè®­ç»ƒé›†ã€ç‰¹å¾ç‚¹é—®é¢˜ï¼Œåœ¨å¤„ç†ä¸€äº›æ•°æ®æ—¶å€™ä¼šæŠŠæ­£å¸¸çš„åŸå£°æ•°æ®ä¸€å¹¶é”™è¯¯å¤„ç†æ‰ã€‚

- RNNoiseçš„ä»£ç æ˜¯åŸºäºCå¼€æºçš„ï¼Œé›†æˆåˆ°Androidä¸­éœ€è¦ä½¿ç”¨NDKã€‚å¼€æºä»£ç ä¸­çš„rnn_data.cå’Œrnn_data.hæ˜¯é€šè¿‡æœºå™¨å­¦ä¹ è®­ç»ƒå‡ºæ¥çš„ï¼Œä¸æ˜¯é€šç”¨çš„ã€‚

- å¼€æºé¡¹ç›®æä¾›çš„ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼Œä½†æ˜¯è¯¥æ–¹æ³•æ˜¯é’ˆå¯¹æ–‡ä»¶å¤„ç†çš„ï¼Œå¯ä»¥æŠŠä¸€ä¸ªå¸¦å™ªéŸ³çš„PCMæ–‡ä»¶å¤„ç†æˆæ— å™ªéŸ³æ–‡ä»¶ã€‚ç›´æ’­SDKä¸­çš„éŸ³é¢‘æ•°æ®æ˜¯åˆ†æ®µçš„byteæ•°ç»„æ•°æ®ï¼Œæ‰€ä»¥ä¸­é—´éœ€è¦æ·»åŠ ä¸€äº›æ¥å£æ¥è®©RNNoiseæ¥æ”¯æŒåˆ†æ®µæ•°æ®çš„é™å™ªå¤„ç†ã€‚

- æ ¹æ®RNNoiseçš„é™å™ªè¿‡ç¨‹å’Œä¸šåŠ¡æ¥å£æµç¨‹ï¼ŒæŠŠæ¥å£å®šä¹‰æˆinitã€processã€freeä¸‰ä¸ªæ¥å£ã€‚

- åœ¨processæ•°æ®æ—¶å‘ç°RNNosieçš„å¤„ç†çª—å£å¤§å°æ˜¯480ï¼Œæ‰€ä»¥ä¼ å…¥çš„æ•°æ®ä¹Ÿå¿…é¡»æ˜¯480çš„æ­£æ•´æ•°å€ã€‚å¦‚æœä¸æ˜¯çš„è¯å¤„ç†ä¹‹åä¼šæœ‰æ˜æ˜¾çš„æ–°å¼•å…¥å™ªéŸ³ã€‚

``` C++
#define FRAME_SIZE_SHIFT 2
#define FRAME_SIZE (120<<FRAME_SIZE_SHIFT)
#define WINDOW_SIZE (2*FRAME_SIZE)
 
// å¯å¼ºåˆ¶ä¿®æ”¹FRAME_SIZEå¤§å°#define FRAME_SIZE (128<<FRAME_SIZE_SHIFT)
```

- å¼€æºä»£ç ä¸­çš„rnn_data.cå’Œrnn_data.hæ˜¯é€šè¿‡æœºå™¨å­¦ä¹ è®­ç»ƒå‡ºæ¥çš„ï¼Œä¸æ˜¯é€šç”¨çš„ã€‚åœ¨å¤„ç†ä¸€ä¸ªå™ªéŸ³æ•°æ®æ—¶å‘ç°æœ‰äº›æ•°æ®ä¸­çš„åŸå£°ä¹Ÿä¼šä¸€å¹¶å¤„ç†æ‰ï¼Œè¿™ä¸ªæ•ˆæœå¦‚æœä¸é€šè¿‡æ–°çš„æ•°æ®é›†è®­ç»ƒé‚£ä¹ˆé™å™ªä¹‹åçš„æ•°æ®æ˜¯ä¸å¯ç”¨çš„ã€‚

``` C++
/*This file is automatically generated from a Keras model*/
#ifndef RNN_DATA_H
#define RNN_DATA_H
#include "rnn.h"
#define INPUT_DENSE_SIZE 24
extern const DenseLayer input_dense;
#define VAD_GRU_SIZE 24
extern const GRULayer vad_gru;
#define NOISE_GRU_SIZE 48
extern const GRULayer noise_gru;
#define DENOISE_GRU_SIZE 96
extern const GRULayer denoise_gru;
#define DENOISE_OUTPUT_SIZE 22
extern const DenseLayer denoise_output;
#define VAD_OUTPUT_SIZE 1
extern const DenseLayer vad_output;
struct RNNState {
    float vad_gru_state[VAD_GRU_SIZE];
    float noise_gru_state[NOISE_GRU_SIZE];
    float denoise_gru_state[DENOISE_GRU_SIZE];
};
#endif
```

- æœºå™¨å­¦ä¹ å’Œè®­ç»ƒæ˜¯RNNoiseçš„çµé­‚ï¼Œéœ€è¦ä¸šåŠ¡æ¥å…¥æ–¹æ ¹æ®è‡ªèº«çš„ä½¿ç”¨åœºæ™¯é€šè¿‡å¤§é‡çš„æ•°æ®é›†æ¥æ‰¾å‡ºæœ€åˆé€‚çš„å¤„ç†é›†ã€‚

#### WebRTCé™å™ªæ–¹æ¡ˆ

- WebRTCçš„ä»£ç æ˜¯åŸºäºC++å¼€æºçš„ï¼Œé›†æˆåˆ°Androidä¸­éœ€è¦ä½¿ç”¨NDKã€‚

- WebRTCåªèƒ½å¤„ç†ç‰¹å®šçš„é‡‡æ ·ç‡æ•°æ®ï¼š8000ã€16000ã€32000ã€44100ã€48000ï¼Œè¿™ä¸ªæ˜¯å…¶ä»£ç å†…éƒ¨æ˜¯å†™æ­»çš„ï¼Œéœ€è¦è‡ªå·±å®ç°éŸ³é¢‘é‡é‡‡æ ·æ¥æ»¡è¶³WebRTCçš„é™å™ªé‡‡æ ·ç‡éœ€æ±‚ã€‚

- æ ¹æ®WebRTCçš„é™å™ªè¿‡ç¨‹å’Œä¸šåŠ¡æ¥å£æµç¨‹ï¼ŒæŠŠæ¥å£å®šä¹‰æˆinitã€processã€freeä¸‰ä¸ªæ¥å£ã€‚åŒºåˆ«RNNoiseçš„æ˜¯éœ€è¦åœ¨processä¸­åšå¢ç›Šå¤„ç†ï¼ŒWebRTCé™å™ªä¼šé™ä½æ•°æ®çš„å£°éŸ³å¤§å°ï¼Œé€šè¿‡å¢ç›Šç”¨æ¥è¡¥å……å£°éŸ³å¤§å°ã€‚

- åœ¨processæ•°æ®æ—¶å‘ç°WebRTCçš„å¤„ç†çª—å£å¤§å°å¿…é¡»æ˜¯160æˆ–æ˜¯320ä¸ªbyteï¼Œæ ¹æ®é‡‡æ ·ç‡ä¸åŒçª—å£å¤§å°ä¸åŒã€‚è¿™ä¸ªå’Œå¤„ç†RNNoiseæ˜¯ä¸€è‡´éƒ½åªèƒ½ä¼ æ­£æ•´æ•°å€æ•°æ®ï¼Œè¦ä¸è¿˜æ˜¯ä¼šæ–°å¼•å…¥å™ªéŸ³æ•°æ®ã€‚

- WebRTCçš„é™å™ªNSæ¨¡å—å’Œå¢ç›ŠAGCæ¨¡å—æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ºäº†ä¸€æ¬¡æ•°æ®å®Œæˆä¸¤ä¸ªè¿‡ç¨‹éœ€è¦ç»„åˆæ•°æ®ï¼Œè¾¹é™å™ªè¾¹å¢ç›Šï¼Œå‡å°‘å¤„ç†è€—æ—¶ã€‚

è‡ªå®šä¹‰è°ƒç”¨WebRTCæš´éœ²çš„æ¥å£

``` java
/**
 *  åˆå§‹åŒ–é™å™ª
 */
private void initProccesor(){
    mProcessor = new WebrtcProcessor();
    mProcessor.init(frequency);
}
 
/**
 * å¤„ç†éœ€è¦é™å™ªçš„éŸ³é¢‘æ•°æ®
 * @param data
 */
private void processData(byte[] data){
    if(mProcessor != null){
        mProcessor.processNoise(data);
    }
}
 
/**
 * å¤„ç†éœ€è¦é™å™ªçš„éŸ³é¢‘æ•°æ®
 * @param data
 */
private void processData(short[] data){
    if(mProcessor != null){
        mProcessor.processNoise(data);
    }
}
 
/**
 * é‡Šæ”¾é™å™ªèµ„æº
 */
private void releaseProcessor(){
    if(mProcessor != null){
        mProcessor.release();
    }
}
```

è‡ªå®šä¹‰é™å™ªç±»WebrtcProcessor.java

``` java
package com.test.jni;
 
import android.util.Log;
 
/**
 * éŸ³é¢‘é™å™ªå¤„ç†
 */
public class WebrtcProcessor {
 
    static {
        try {
            //åŠ è½½é™å™ªåº“
            System.loadLibrary("webrtc");
        } catch (UnsatisfiedLinkError e) {
            Log.e("TAG", "Couldn't load lib:   - " + e.getMessage());
        }
 
    }
 
    /**
     * å¤„ç†é™å™ª
     * @param data
     */
    public void processNoise(byte[] data){
 
        if(data == null) return;
 
        int newDataLength = data.length/2;
        if(data.length % 2 == 1){
            newDataLength += 1;
        }
 
        //æ­¤å¤„æ˜¯å°†å­—èŠ‚æ•°æ®è½¬æ¢ä¸ºshortæ•°æ®
        short[] newData = new short[newDataLength];
 
        for(int i=0; i<newDataLength; i++){
            byte low = 0;
            byte high = 0;
 
            if(2*i < data.length){
                low = data[2*i];
            }
            if((2*i+1) < data.length){
                high = data[2*i+1];
            }
 
            newData[i] = (short) (((high << 8) & 0xff00) | (low & 0x00ff));
        }
 
        // äº¤ç»™åº•å±‚å¤„ç†
        processNoise(newData);
 
        //å¤„ç†å®Œä¹‹å, åˆå°†shortæ•°æ®è½¬æ¢ä¸ºå­—èŠ‚æ•°æ®
        for(int i=0; i<newDataLength; i++){
            if(2*i < data.length){
                data[2*i] = (byte) (newData[i] & 0xff);
            }
            if((2*i+1) < data.length){
                data[2*i+1] = (byte) ((newData[i] >> 8) & 0xff);
            }
        }
 
    }
 
    /**
     * åˆå§‹åŒ–é™å™ªè®¾ç½®
     * @param sampleRate é‡‡æ ·ç‡
     * @return æ˜¯å¦åˆå§‹åŒ–æˆåŠŸ
     */
    public native boolean init(int sampleRate);
 
    /**
     * å¤„ç†é™å™ª
     * @param data
     * @return
     */
    public native boolean processNoise(short[] data);
 
    /**
     *  é‡Šæ”¾é™å™ªèµ„æº
     */
    public native void release();
 
}
```

åªä½¿ç”¨çš„è¯ä¸Šè¿°ä»£ç å·²è¶³å¤Ÿï¼Œä¸‹é¢ç¨å¾®çœ‹ä¸€ä¸‹æºç ï¼š

``` C++
#include <jni.h>
#include "audio_ns.h"
#include "noise_suppression.h"
 
//æ­¤å¤„æ˜¯ä¸ºäº†é‡Œé¢çš„åº•å±‚æ–¹æ³•èƒ½è¢«javaå±‚è¯†åˆ«
extern "C" {
 
    //é™å™ªçš„å®ä¾‹,å¥æŸ„
    NsHandle* handle = NULL;
 
    //é™å™ªå¤„ç†
    void innerProcess(short in_sample[], short out_sample[], int length){
 
        int curPosition = 0;
 
        //æ­¤å¤„ä»¥80ä¸ºå•ä½, ä¾æ¬¡è°ƒç”¨audio_ns_processå¤„ç†æ•°æ®,å› ä¸ºè¿™ä¸ªæ–¹æ³•ä¸€æ¬¡åªèƒ½å¤„ç†80ä¸ªshortéŸ³é¢‘æ•°æ®
        while(curPosition < length){
            audio_ns_process((int) handle, in_sample + curPosition, out_sample + curPosition);
            curPosition += 80;
        }
 
    }
 
    JNIEXPORT jboolean JNICALL
    Java_com_test_jni_WebrtcProcessor_init(JNIEnv *env, jobject instance, jint sample_rate) {
 
        //åˆå§‹åŒ–é™å™ªå®ä¾‹
        handle = (NsHandle *) audio_ns_init(sample_rate);
 
        return false;
    }
 
    JNIEXPORT jboolean JNICALL
    Java_com_test_jni_WebrtcProcessor_processNoise(JNIEnv *env, jobject instance, jshortArray sample) {
 
        if(!handle)
            return false;
 
        //è·å–æ•°æ®é•¿åº¦
        jsize length = env->GetArrayLength(sample);
 
        //è½¬æ¢ä¸ºjshortæ•°ç»„
        jshort *sam = env->GetShortArrayElements(sample, 0);
 
        //å°†samçš„æ•°æ®å…¨éƒ¨å¤åˆ¶ç»™æ–°çš„in_sample
        short in_sample[length];
        for(int i=0; i<length; i++){
            in_sample[i] = sam[i];
        }
 
        //ä¼ å…¥in_sampleä½œä¸ºéœ€è¦å¤„ç†éŸ³é¢‘æ•°æ®, å¤„ç†ä¹‹åçš„æ•°æ®è¿”å›åˆ°samä¸­
        innerProcess(in_sample, sam, length);
 
        //å°†samä¸­çš„æ•°æ®,å†è½¬æ¢å›sampleä¸­
        env->ReleaseShortArrayElements(sample, sam, 0);
 
        return true;
    }
 
    JNIEXPORT void JNICALL
    Java_com_test_jni_WebrtcProcessor_release(JNIEnv *env, jobject instance) {
        // é‡Šæ”¾é™å™ªèµ„æº
        if(handle){
            audio_ns_destroy((int) handle);
        }
    }
 
}
```

ä¸Šè¿°ä»£ç å®é™…ä¸ŠWebRTCé™å™ªä¸€æ¬¡æ€§åªå¤„ç†äº†80ä¸ªshortæ•°æ®ï¼ˆåœ¨8000é‡‡æ ·ç‡ä¸­æ˜¯è¿™æ ·çš„ï¼‰ï¼Œæ„æ€å°±æ˜¯è¯´WebRTCæ¯æ¬¡åªèƒ½å¤„ç†10æ¯«ç§’ï¼Œ0.01ç§’çš„æ•°æ®ã€‚é‚£ä¹ˆä¾æ¬¡ç±»æ¨ï¼Œé’ˆå¯¹44100é‡‡æ ·ç‡çš„æ•°æ®å¤„ç†çš„è¯ï¼Œæ¯æ¬¡èƒ½å¤„ç†çš„æ•°æ®é•¿åº¦å°±åº”è¯¥æ˜¯441ä¸ªshortæ•°æ®äº†ã€‚

WebRTCçš„é™å™ªæ˜¯å¦‚ä½•åˆå§‹åŒ–å’Œå¤„ç†

``` C++
#include "audio_ns.h"
#include "noise_suppression.h"
 
#include <stdio.h>
 
int audio_ns_init(int sample_rate){
 
    NsHandle* NS_instance;
    int ret;
    //åˆ›å»ºWebRtcNså®ä¾‹
    if ((ret = WebRtcNs_Create(&NS_instance) )) {
        printf("WebRtcNs_Create failed with error code = %d", ret);
        return ret;
    }
 
    //åˆå§‹åŒ–WebRtcNså®ä¾‹,æ­¤å¤„éœ€è¦æŒ‡å®šé‡‡æ ·,å‘Šè¯‰å®ƒä¸€æ¬¡å¯ä»¥å¤„ç†å¤šå°‘ä¸ªshortéŸ³é¢‘æ•°æ®,
    //å¦‚æœæ˜¯8000, åˆ™ä¸€æ¬¡å¯ä»¥å¤„ç†80,å¦‚æœæ˜¯44100, åˆ™ä¸€æ¬¡å¯ä»¥å¤„ç†441ä¸ª
    //ä¹Ÿå°±æ˜¯è¯´,ä¸€æ¬¡æ€§å¯ä»¥å¤„ç†10msæ—¶é—´çš„æ•°æ®
    if ((ret = WebRtcNs_Init(NS_instance, sample_rate) )) {
        printf("WebRtcNs_Init failed with error code = %d", ret);
        return ret;
    }
 
    //è®¾ç½®é™å™ªçš„åŠ›åº¦,0,1,2, 0æœ€å¼±,2æœ€å¼º
    if (( ret =  WebRtcNs_set_policy(NS_instance, 2))){
        printf("WebRtcNs_set_policy failed with error code = %d", ret);
        return ret;
    }
 
    return (int)NS_instance;
}
 
 
int audio_ns_process(int ns_handle ,  short *src_audio_data ,short *dest_audio_data){
    //get handle
    NsHandle* NS_instance = (NsHandle* )ns_handle;
 
    //noise suppression
    if(
        //æ­¤å¤„è¿™ä¹ˆåš,æ˜¯å› ä¸º,çœŸæ­£çš„WebRtcNs_Process,ä¸€æ¬¡åªèƒ½å¤„ç†80ä¸ªshortséŸ³é¢‘æ•°æ®
        WebRtcNs_Process(NS_instance ,src_audio_data ,NULL ,dest_audio_data , NULL) ||
        WebRtcNs_Process(NS_instance ,&src_audio_data[80] ,NULL ,&dest_audio_data[80] , NULL) ){
            printf("WebRtcNs_Process failed with error code = " );
            return -1;
    }
 
    return 0;
}
 
void audio_ns_destroy(int ns_handle){
    //é‡Šæ”¾WebRtcNsèµ„æº
    WebRtcNs_Free((NsHandle *) ns_handle);
}
```

å…·ä½“çš„é™å™ªç»†èŠ‚åœ¨WebRtcNs_Process()å‡½æ•°ä¸­ï¼Œå…·ä½“ç®—æ³•ç»†èŠ‚ç¬”è€…æµ…å°è¾„æ­¢ï¼Œä¸‹è¿°ä»…ç®€è¿°æ€è·¯ï¼š

æŠŠå‰50å¸§çš„æ•°æ®æ‹¿æ¥æ„å»ºå™ªå£°æ¨¡å‹ï¼ŒæŠŠå‰200å¸§çš„ä¿¡å·å¼ºåº¦ç”¨æ¥è®¡ç®—å½’ä¸€åŒ–çš„é¢‘è°±å·®å€¼è®¡ç®—ã€‚æ ¹æ®è¿™ä¸¤ä¸ªæ¨¡å‹ä½¿ç”¨æ¦‚ç‡ç›®çš„å‡½æ•°æ¥è®¡ç®—å‡ºæ¯å¸§çš„ä¿¡å™ªæ¯”å¹¶åŒºåˆ†å‡ºå™ªå£°å’Œå£°éŸ³ï¼Œç„¶åæ ¹æ®è®¡ç®—å‡ºçš„ä¿¡å™ªæ¯”åœ¨é¢‘åŸŸä½¿ç”¨ç»´çº³æ»¤æ³¢å™¨å¯¹å™ªå£°ä¿¡å·è¿›è¡Œå™ªå£°æ¶ˆé™¤ï¼Œæœ€ååœ¨æ ¹æ®é™å™ªå‰åçš„èƒ½é‡æ¯”å’Œä¿¡å·å™ªå£°ä¼¼ç„¶æ¯”å¯¹é™å™ªåçš„æ•°æ®è¿›è¡Œä¿®å¤å’Œè°ƒæ•´åè¾“å‡ºã€‚

#### ä¸¤ç§é™å™ªæ–¹æ¡ˆé›†æˆä¼˜ç¼ºç‚¹å¯¹æ¯”

ç›®å‰WebRTCæœ€æ–°ä»£ç åªæ”¯æŒé‡‡æ ·ç‡ä¸º8000ã€16000ã€32000ã€44100ã€48000çš„éŸ³é¢‘è¿›è¡Œé™å™ªï¼Œé’ˆå¯¹å…¶ä½™çš„é‡‡æ ·ç‡éœ€è¦è¿›è¡Œæ•°æ®é‡é‡‡æ ·åˆ°ä¸Šè¿°é‡‡æ ·ç‡ä¹‹åè¿›è¡Œé™å™ªï¼Œå¤„ç†å®Œæ¯•ä¹‹åéœ€è¦å†æ¬¡æ¢å¤åŸé‡‡æ ·ç‡ï¼›RNNoiseå¯¹é‡‡æ ·ç‡æ²¡æœ‰è¦æ±‚ï¼Œå¯ä»¥é€‚é…å¸¸è§çš„é‡‡æ ·ç‡ã€‚

WebRTCåœ¨é™å™ªä¹‹åè¿˜éœ€è¦å¯¹æ•°æ®è¿›è¡Œå¢ç›Šå¤„ç†ï¼Œä½†æ˜¯å¢ç›Šä¼šå¢å¤§ç”µæµéŸ³ï¼Œæ•ˆæœä¼šç¨å·®äº›ã€‚

WebRTCå¤„ç†æ•°æ®çš„bufferç›®å‰ä»£ç æ˜¯320çš„æ•´æ•°å€ï¼›RNNoiseå¤„ç†æ•°æ®çš„bufferç›®å‰ä»£ç æ˜¯480çš„æ•´æ•°å€ã€‚è¾“å…¥çš„bufferéœ€æ˜¯å›ºå®šå¤§å°çš„ï¼Œå¦‚æœä¸æ˜¯æ­£æ•´æ•°å€ï¼Œéœ€è¦å¤–éƒ¨åœ¨ä¼ å…¥æ—¶å¤„ç†ä¸‹ã€‚

ä»ä»£ç å¤æ‚åº¦çœ‹ï¼ŒWebRTCçš„ä»£ç æ˜¯å¤šäºRNNoiseä»£ç çš„ã€‚RNNoiseæ”¯æŒæœºå™¨å­¦ä¹ ï¼Œé€šè¿‡æœºå™¨å­¦ä¹ ç”Ÿæˆrnn_data.hå’Œrnn_data.cæ–‡ä»¶æ¥åŒ¹é…ä¸åŒçš„é™å™ªæ•ˆæœã€‚

é™å™ªè€—æ—¶å¯¹æ¯”ï¼ŒRNNoiseå¤„ç†3840å­—èŠ‚çš„bufferæ•°æ®è€—æ—¶å¤§æ¦‚åœ¨6mså·¦å³ï¼Œä½†åœ¨å¼€å§‹æ—¶è€—æ—¶åœ¨30mså·¦å³ï¼Œé€’å‡åˆ°6mså¹¶ç¨³å®šï¼›WebRTCå¤„ç†3840å­—èŠ‚çš„bufferæ•°æ®è€—æ—¶å¤§æ¦‚åœ¨2mså·¦å³ï¼Œä½†åœ¨å¼€å§‹æ—¶è€—æ—¶åœ¨10mså·¦å³ï¼Œé€’å‡åˆ°2mså¹¶ç¨³å®šã€‚å¯¹æ¯”å‘ç°WebRTCå¤„ç†æ•ˆç‡æ›´å¥½äº›ã€‚

ä»å¤„ç†æµç¨‹ä¸Šçœ‹éƒ½æ˜¯éœ€è¦initã€processã€freeæ“ä½œçš„ï¼Œå¯¹æ¥å…¥æ–¹æ¥å…¥æˆæœ¬æ˜¯ä¸€è‡´çš„ã€‚

#### è¡¥å……

RNNï¼ˆå¾ªç¯ç¥ç»ç½‘ç»œRecurrent Neural Networksï¼Œä¸Šï¼‰å’ŒLSTMï¼ˆé•¿çŸ­æœŸè®°å¿†Long Short Term Memoryï¼Œä¸‹ï¼‰

{% asset_img 2.webp %}

{% asset_img 3.webp %}

***

### å˜éŸ³

å¯¹äºå˜å£°çš„å¤„ç†ä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š

#### å˜é€Ÿåˆå˜è°ƒ

å³æ”¹å˜éŸ³é¢‘çš„é€Ÿåº¦ï¼ˆè¯­é€Ÿï¼‰ï¼Œåˆæ”¹å˜éŸ³é¢‘çš„é¢‘ç‡ï¼ˆéŸ³è°ƒï¼‰

æˆ‘ä»¬å¯ä»¥å¯¹åŸå§‹éŸ³é¢‘è¿›è¡Œé‡é‡‡æ ·ï¼Œé‡é‡‡æ ·æœ‰ä¸Šé‡‡æ ·å’Œä¸‹é‡‡æ ·ï¼Œåˆ†åˆ«æ˜¯å¯¹åŸå§‹éŸ³é¢‘è¿›è¡Œæ’å€¼å’ŒæŠ½å–ï¼Œæ¯”å¦‚P/Qé‡é‡‡æ ·ï¼Œä¸€èˆ¬æˆ‘ä»¬çš„å¤„ç†æ˜¯ï¼Œå…ˆå¯¹åŸå§‹éŸ³é¢‘è¿›è¡Œæ’å€¼ï¼Œåœ¨ç›¸é‚»ä¸¤ç‚¹é—´æ’å…¥Pä¸ªé‡‡æ ·ç‚¹ï¼Œå…¨éƒ¨æ’å…¥ç»“æŸåå†æ¯éš”Qä¸ªé‡‡æ ·ç‚¹è¿›è¡Œé‡‡æ ·ï¼Œè¿™æ ·å¾—åˆ°çš„éŸ³é¢‘è¯­é€Ÿå’ŒéŸ³è°ƒéƒ½æ˜¯åŸæ¥çš„Q/På€

å˜è°ƒåˆå˜é€Ÿï¼ˆæé«˜ï¼‰

``` java
// å˜è°ƒåˆå˜é€Ÿï¼ˆæé«˜ï¼‰
public byte[] up(byte[] data, int up) {
    if (up == 1) {
        return data;
    }
    int length = data.length;
    int upLength = length / up;
    byte[] upData = new byte[upLength];
    for (int i = 0, j = 0; i < length; ) {
        if (j >= upLength) {
            break;
        }
        upData[j] = data[i];
        i += up;
        j++;
    }
    return upData;
}
```

å˜è°ƒåˆå˜é€Ÿï¼ˆé™ä½ï¼‰

``` java
public byte[] down(byte[] data, int down) {
    if (down == 1) {
        return data;
    }
    int length = data.length;
    int downLength = length * down;
    byte[] downData = new byte[downLength];
    for (int i = 0, j = 0; i < length - 1; ) {
        for (int k = 0; k < down; k++) {
            downData[j] = data[i];
            j++;
        }
        i++;
    }
    return downData;
}
```

#### å˜é€Ÿä¸å˜è°ƒ

åªæ”¹å˜è¯­é€Ÿï¼Œä¸æ”¹å˜éŸ³è°ƒ

åªæ˜¯æ”¹å˜è¯­é€Ÿçš„è¯ï¼Œé‚£ä¹ˆå°±è¦ç¨å¾®å¤æ‚ç‚¹ï¼Œå’Œé‡é‡‡æ ·æ–¹æ³•å·®ä¸å¤šï¼ŒåŒºåˆ«åœ¨äºæˆ‘ä»¬éœ€è¦å…ˆè§„å®šä¸€å¸§éŸ³é¢‘çš„é•¿åº¦ï¼Œä¸€èˆ¬æˆ‘ä»¬çš„é‡‡æ ·ç‡è®¾ä¸º44.1KHzï¼Œä¹Ÿå°±æ˜¯ä¸€ç§’é’Ÿé‡‡æ ·44.1Kæ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥è§„å®šä¸€å¸§ä¸º1024ï¼Œæ‰€æœ‰æˆ‘ä»¬å¯ä»¥ç®€å•çš„æ ¹æ®ä¸¢å¸§å’Œé‡å¤å¸§æ¥å®ç°å˜é€Ÿä¸å˜è°ƒï¼Œæ¯”å¦‚å¯¹äºP/Qå˜é€Ÿï¼Œæˆ‘ä»¬å…ˆå¯¹åŸå§‹éŸ³é¢‘çš„æ¯ä¸€å¸§é‡å¤Pæ¬¡ï¼Œæœ€åçš„ç»“æœå†è¿›è¡Œæ¯éš”Qå¸§å–ä¸€å¸§ï¼Œè¿™æ ·å°±å¾—åˆ°éŸ³é¢‘éŸ³è°ƒä¸å˜ï¼Œè¯­é€Ÿå˜ä¸ºQ/Pçš„éŸ³é¢‘

å˜é€Ÿä¸å˜è°ƒï¼ˆæé«˜ï¼‰

``` java
public byte[] speedUp(byte[] data, int up) {
    final int FRAME_LENGTH = 1024;
    if (up == 1) {
        return data;
    }
    int length = data.length;
    int frameShift = FRAME_LENGTH * up;
    int upLength = length / up;
    byte[] upData = new byte[upLength];
    for (int i = 0, j = 0; i < length; ) {
        if (i + FRAME_LENGTH >= length) {
            System.arraycopy(data, i, upData, j, length - i);
            break;
        }
        System.arraycopy(data, i, upData, j, FRAME_LENGTH);
        i += (FRAME_LENGTH + frameShift);
        j += FRAME_LENGTH;
    }
    return upData;
}
```

å˜é€Ÿä¸å˜è°ƒï¼ˆé™ä½ï¼‰

``` java
public byte[] speedDown(byte[] data, int down) {
    final int FRAME_LENGTH = 1024;
    if (down == 1) {
        return data;
    }
    int length = data.length;
    int downLength = length * down;
    byte[] downData = new byte[downLength];
    for (int i = 0, j = 0; i < length; ) {
        if (i + FRAME_LENGTH >= length) {
            int lastlength = length - i;
            for (int k = 0; k < down; k++) {
                System.arraycopy(data, lastlength, downData, j, lastlength);
                j += lastlength;
            }
            break;
        }
        for (int k = 0; k < down; k++) {
            System.arraycopy(data, i, downData, j, FRAME_LENGTH);
            j += FRAME_LENGTH;
        }
        i += FRAME_LENGTH;
    }
    return downData;
}
```

#### å˜è°ƒä¸å˜é€Ÿ

åªæ”¹å˜éŸ³è°ƒï¼Œä¸æ”¹å˜è¯­é€Ÿ

å¦‚æœåªæ˜¯å˜è°ƒçš„è¯ï¼Œå°±è¦ç»“åˆé‡é‡‡æ ·å’Œå˜é€Ÿä¸å˜è°ƒæ¥åšï¼Œæˆ‘ä»¬å…ˆå¯¹éŸ³é¢‘ä¿¡å·è¿›è¡Œå˜é€Ÿä¸å˜è°ƒå¤„ç†ï¼Œå†å¯¹å…¶è¿›è¡Œé‡é‡‡æ ·ï¼Œæ¯”å¦‚ï¼Œæˆ‘æƒ³è¦è®©éŸ³è°ƒå˜ä¸ºåŸæ¥çš„P/Qå€ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å…ˆå¯¹å…¶è¿›è¡ŒP/Qå˜é€Ÿä¸å˜è°ƒï¼Œè¯­é€Ÿå˜ä¸ºåŸæ¥çš„Q/Pï¼Œæ¥ç€ï¼Œåœ¨å¯¹å…¶è¿›è¡ŒQ/Pé‡é‡‡æ ·ï¼Œè¿™æ ·ï¼Œæœ€åå°±å¾—åˆ°äº†è¯­é€Ÿä¸å˜ï¼Œè€ŒéŸ³è°ƒå˜ä¸ºåŸæ¥çš„P/Qå€

è®¾ç½®è¯­é€Ÿ

``` java
public byte[] setSpeed(byte[] data, int up, int down) {
    byte[] downData = speedDown(data, down);
    byte[] upData = speedUp(downData, up);
    return upData;
}
```

è®¾ç½®éŸ³è°ƒ

``` java
public byte[] setTone(byte[] data, int up, int down) {
    byte[] speedData = setSpeed(data, down, up);
    byte[] downData = down(speedData, down);
    byte[] upData = up(downData, up);
    return upData;
}
```

ä¾‹å¦‚ï¼Œå°†upè®¾ä¸º4ï¼Œdownè®¾ä¸º5ï¼Œå£°éŸ³å°±å˜å¾—ä½æ²‰ã€‚
