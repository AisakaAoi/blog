---
title: Android-éŸ³è§†é¢‘-è§†é¢‘å¼€å‘-ï¼ˆäºŒï¼‰è§†é¢‘å½•åˆ¶
categories:
  - ğŸŒ™åŸºç¡€å­¦ä¹ 
  - â­Android
abbrlink: f3e23104
date: 2021-10-14 16:48:17
tags:
---

### ç›¸æœº

Androidæ¡†æ¶åŒ…å«äº†å„ç§ç›¸æœºå’Œç›¸æœºåŠŸèƒ½çš„æ”¯æŒï¼Œä½¿ä½ å¯ä»¥åœ¨ä½ çš„åº”ç”¨ä¸­æ•è·å›¾åƒå’Œè§†é¢‘ã€‚æœ¬æ–‡è®¨è®ºä¸€ä¸ªç®€å•å¿«é€Ÿçš„è·å–å›¾åƒå’Œè§†é¢‘çš„æ–¹æ³•ï¼Œå¹¶æ¦‚è¿°ä¸€ä¸ªåˆ›å»ºè‡ªå®šä¹‰ç”¨æˆ·ç›¸æœºä½“éªŒçš„æ–¹æ³•ã€‚

å½•åˆ¶è§†é¢‘æœ‰ä¸¤ç§æ–¹æ³•ï¼š

1. ç³»ç»Ÿç›¸æœºçš„å½•åˆ¶è§†é¢‘åŠŸèƒ½

2. é€šè¿‡å®‰å“è‡ªå¸¦çš„MediaRecorderæ¥å½•åˆ¶è§†é¢‘

<!--more-->

***

### åŸºç¡€çŸ¥è¯†

Androidæ¡†æ¶æ”¯æŒé€šè¿‡CameraAPIæˆ–Cemera intentæ¥æŠ“å–å›¾åƒå’Œè§†é¢‘ã€‚ä¸‹é¢å°±æ˜¯ç›¸å…³çš„ç±»ï¼š

**Camera**ï¼šæ­¤ç±»æ˜¯æ§åˆ¶è®¾å¤‡ç›¸æœºçš„ä¸»è¦APIï¼æ­¤ç±»ç”¨äºåœ¨åˆ›å»ºç›¸æœºåº”ç”¨æ—¶è·å–å›¾ç‰‡å’Œè§†é¢‘ï¼

**SurfaceView**ï¼šæ­¤ç±»ä¸ºç”¨æˆ·æä¾›cameraçš„å®æ—¶å›¾åƒé¢„è§ˆï¼

**MediaRecorder**ï¼šæ­¤ç±»ç”¨äºä»cameraå½•åˆ¶è§†é¢‘ï¼

**Intent**ï¼šä¸€ä¸ªMediaStore.ACTION_IMAGE_CAPTUREæˆ–MediaStore.ACTION_VIDEO_CAPTUREå‹çš„intentï¼Œå¯ä»¥ä½¿ç”¨å®ƒæ¥æŠ“å–å›¾åƒæˆ–è§†é¢‘ï¼Œè€Œä¸ç”¨æ“ä½œCameraå¯¹è±¡ã€‚

***

### Manifestä¸­çš„å£°æ˜

``` java
<uses-feature android:name="android.hardware.camera"/>
<uses-feature android:name="android.hardware.camera.autofocus" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.RECORD_AUDIO"/>
<uses-permission android:name="android.permission.CAMERA" />
```

***

### Cameraï¼ˆAndroid 5.0 API 21å·²å¼ƒç”¨ï¼‰

#### æ‹æ‘„å›¾ç‰‡

åˆ©ç”¨Cameraæƒ³è¦æ‹ç…§ï¼Œéœ€è¦å¦‚ä¸‹ä½¿ç”¨æ­¥éª¤:

1. åˆ©ç”¨open(int)è·å–Cameraå®ä¾‹ã€‚

2. åˆ©ç”¨getParameters()è·å–é»˜è®¤è®¾ç½®ï¼Œå¦‚æœéœ€è¦åˆ©ç”¨setParameters(Camera.Parameters)è¿›è¡Œå‚æ•°è®¾ç½®ã€‚

3. åˆ©ç”¨setDisplayOrientation(int)å‡½æ•°è®¾ç½®æ­£ç¡®çš„é¢„è§ˆæ–¹å‘ã€‚

4. æƒ³è¦é¢„è§ˆï¼Œéœ€è¦é…åˆSurfaceViewï¼Œåˆ©ç”¨setPreviewDisplay(SurfaceHolder)è®¾ç½®SurfaceViewçš„SurfaceHolderç”¨äºé¢„è§ˆã€‚

5. è°ƒç”¨startPreview()å¼€å§‹é¢„è§ˆï¼Œæ‹ç…§ä¹‹å‰å¿…é¡»å·²ç»å¼€å§‹é¢„è§ˆã€‚

6. takePicture æ‹æ‘„ç…§ç‰‡
    è°ƒç”¨takePictureåé¢„è§ˆä¼šåœæ­¢ï¼Œéœ€ç”¨é‡æ–°è°ƒç”¨startPreviewæ‰èƒ½å†æ¬¡å¼€å§‹é¢„è§ˆã€‚é¢„è§ˆå¼€å§‹åï¼Œå°±å¯ä»¥é€šè¿‡Camera.takePicture()æ–¹æ³•æ‹æ‘„ä¸€å¼ ç…§ç‰‡ï¼Œè¿”å›çš„ç…§ç‰‡æ•°æ®é€šè¿‡Callbackæ¥å£è·å–ã€‚
    takePicture()æ¥å£å¯ä»¥è·å–ä¸‰ä¸ªç±»å‹çš„ç…§ç‰‡ï¼š
    ç¬¬ä¸€ä¸ªï¼ŒShutterCallbackæ¥å£ï¼Œåœ¨æ‹æ‘„ç¬é—´ç¬é—´è¢«å›è°ƒï¼Œé€šå¸¸ç”¨äºæ’­æ”¾â€œå’”åš“â€è¿™æ ·çš„éŸ³æ•ˆ
    ç¬¬äºŒä¸ªï¼ŒPictureCallbackæ¥å£ï¼Œè¿”å›æœªç»å‹ç¼©çš„RAWç±»å‹ç…§ç‰‡
    ç¬¬ä¸‰ä¸ªï¼ŒPictureCallbackæ¥å£ï¼Œè¿”å›ç»è¿‡å‹ç¼©çš„JPEGç±»å‹ç…§ç‰‡

7. è°ƒç”¨takePicktureåé¢„è§ˆä¼šåœæ­¢ï¼Œæƒ³è¦ç»§ç»­é¢„è§ˆéœ€è¦è°ƒç”¨startPreview()å‡½æ•°

8. è°ƒç”¨stopPreview()åœæ­¢é¢„è§ˆ

9. è°ƒç”¨release()é‡Šæ”¾èµ„æºï¼Œä¸ºäº†èŠ‚çœèµ„æºåœ¨Activity.onPauseæ˜¯è°ƒç”¨åœæ­¢é¢„è§ˆï¼Œåœ¨onResumeæ˜¯å¼€å§‹é¢„è§ˆã€‚

#### å½•åˆ¶è§†é¢‘

è·³è½¬ä½¿ç”¨Intent

``` java
Intent intent = new Intent(MediaStore.ACTION_VIDEO_CAPTURE);
 
// 1. è®¾ç½®è§†é¢‘å½•åˆ¶çš„æœ€é•¿æ—¶é—´ï¼ˆå•ä½ï¼šsï¼‰ï¼Œå½•åˆ¶åˆ°è¾¾æ—¶é—´ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¿å­˜è§†é¢‘ï¼Œåœæ­¢å½•åˆ¶
intent.putExtra (MediaStore.EXTRA_DURATION_LIMIT, 30);
// 2. é™åˆ¶è§†é¢‘çš„å¤§å°ï¼Œè¿™é‡Œæ˜¯100å…†ã€‚å½“å¤§å°åˆ°è¾¾çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åœæ­¢å½•åˆ¶
intent.putExtra(MediaStore.EXTRA_SIZE_LIMIT, 1024 * 1024 * 100);
// 3. è®¾ç½®è§†é¢‘å½•åˆ¶çš„ç”»è´¨ï¼ˆ0~1ä¹‹é—´ï¼Œ0å’Œ1æ˜¯æ‰€æœ‰ç›¸æœºéƒ½æœ‰çš„è®¾ç½®ï¼š0è¾ƒå·®ï¼Œä¸€åˆ†é’Ÿçº¦5mï¼›é»˜è®¤1è¾ƒå¥½ï¼Œä¸€åˆ†é’Ÿçº¦40mï¼‰
intent.putExtra(MediaStore.EXTRA_VIDEO_QUALITY, 1);
// 4. è¡¨ç¤ºå½•åˆ¶å®Œåä¿å­˜çš„å½•åˆ¶ï¼Œå¦‚æœä¸å†™ï¼Œåˆ™ä¼šä¿å­˜åˆ°é»˜è®¤çš„è·¯å¾„ï¼Œåœ¨onActivityResult()çš„å›è°ƒï¼Œé€šè¿‡intent.getDataä¸­è¿”å›ä¿å­˜çš„è·¯å¾„
String filePath = getExternalFilesDir(Environment.DIRECTORY_DOCUMENTS) + "/msc/" + "test.mp4";
Uri uri = Uri.fromFile(new File(filePath));
intent.putExtra(MediaStore.EXTRA_OUTPUT, uri);
 
startActivityForResult (intent, VIDEO_WITH_CAMERA);
```

å½•åˆ¶å®Œå›è°ƒè·å–

``` java
@Override
protected void onActivityResult(int requestCode, int resultCode, Intent data) {
    super.onActivityResult(requestCode, resultCode, data);
    try {
        if (resultCode == Activity.RESULT_OK && requestCode == VIDEO_WITH_CAMERA) {
            Uri uri = data.getData();
            Log.e(TAG, "onActivityResult: " + uri.toString());
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

è·å–è§†é¢‘æ—¶é•¿

``` java
mediaPlayer.setDataSource(this, uri);
mediaPlayer.prepare();
int duration = mediaPlayer.getDuration() / 1000;   // è·å–åˆ°çš„æ˜¯æ¯«ç§’å€¼
```

è·å–è§†é¢‘çš„ç¬¬ä¸€å¸§çš„å›¾ç‰‡

``` java
MediaMetadataRetriever media = new MediaMetadataRetriever();
String videoPath = uri.getPath();            // é€šè¿‡Uriè·å–ç»å¯¹è·¯å¾„
media.setDataSource(videoPath);
Bitmap bitmap = media.getFrameAtTime();      // è§†é¢‘çš„ç¬¬ä¸€å¸§å›¾ç‰‡
```

#### é€‰æ‹©æœ¬åœ°è§†é¢‘

è¿™é‡Œæœ‰ä¸ªå‘ï¼Œä¸åŒå“ç‰Œæœºå­é—´è·å–æœ¬åœ°ç›¸å†Œæœ‰å…¼å®¹æ€§é—®é¢˜ï¼Œéœ€è¦æŸ¥é˜…å¯¹åº”æ‰‹å†Œé’ˆå¯¹æ€§è°ƒç”¨ï¼Œæœ‰ä¸€ç¯‡åšå®¢è®°å½•åˆ°ï¼š

â€œä½¿ç”¨**ACTION_PICK**çš„æ–¹å¼æ‰“å¼€ç›¸å†Œåœ¨**oppoã€vivoã€åä¸ºã€å°ç±³**ä½¿ç”¨å‡æ²¡é—®é¢˜ï¼Œä½†æ˜¯åœ¨**é­…æ—**å’Œ**ä¸€åŠ **éƒ½ä¸å¯ä»¥ï¼ˆè·³è½¬åçš„ç•Œé¢æ— æ³•é€‰æ‹©è§†é¢‘ï¼‰ã€‚è€Œ**é­…æ—**æ‰‹æœºä½¿ç”¨**ACTION_OPEN_DOCUMENT**æ–¹å¼å¯ä»¥é€‰æ‹©è§†é¢‘æ–‡ä»¶ï¼Œä½†æ˜¯åœ¨**åä¸º**æ‰‹æœºï¼ˆæµ‹è¯•ç”¨çš„åä¸ºï¼‰ä¸Šåˆ™ä¼šå‡ºç°é—ªé€€ï¼ˆæ— æ³•è·å–åˆ°è¢«é€‰ä¸­çš„è§†é¢‘æ–‡ä»¶çš„è·¯å¾„ï¼‰ã€‚â€

ä½¿ç”¨ç³»ç»Ÿçš„é€‰æ‹©æœ¬åœ°è§†é¢‘çš„æ–¹æ³•

``` java
Intent intent = new Intent();
if ("Meizu".equalsIgnoreCase(android.os.Build.MANUFACTURER)) {  // åˆ¤æ–­ç”¨æˆ·æ‰‹æœºæ˜¯å¦æ˜¯â€œé­…æ—â€ã€‚å¿½ç•¥å¤§å°å†™çš„æ¯”è¾ƒ
    intent.setAction(Intent.ACTION_OPEN_DOCUMENT);
    intent.addCategory(Intent.CATEGORY_OPENABLE);
    intent.setType("video/*");
} else {
    intent.setAction(Intent.ACTION_PICK);
    intent.setData(android.provider.MediaStore.Video.Media.EXTERNAL_CONTENT_URI);
}
context.startActivityForResult(intent, REQUEST_CODE_CHOOSE_VIDEO);
```

é€‰æ‹©è§†é¢‘åå›è°ƒ

``` java
public void handleVideoResult(int requestCode, int resultCode, Intent data) {
    if (resultCode == Activity.RESULT_OK && null != data)
        if (requestCode == REQUEST_CODE_CHOOSE_VIDEO) {
             try {
                Uri selectedVideo = data.getData();      // è·å–è§†é¢‘çš„Uri
                String[] filePathColumn = {MediaStore.Video.Media.DATA};
                cursor = context.getContentResolver().query(selectedVideo,
                        filePathColumn, null, null, null);
                cursor.moveToFirst();
                int columnIndex = cursor.getColumnIndex(filePathColumn[0]);
                String path = cursor.getString(columnIndex);          // è§†é¢‘è·¯å¾„
            } finally {
                if (cursor != null) cursor.close();                   // å…³é—­cursor
            }
        }
}
```

é€‰ä¸­åï¼Œå¯ä»¥è·å–åˆ°è§†é¢‘çš„å„ç§ä¿¡æ¯

``` java
// è§†é¢‘ID:MediaStore.Audio.Media._ID
int videoId = cursor.getInt(cursor.getColumnIndexOrThrow(MediaStore.Video.Media._ID));
// è§†é¢‘åç§°ï¼šMediaStore.Audio.Media.TITLE
String title = cursor.getString(cursor.getColumnIndexOrThrow(MediaStore.Video.Media.TITLE));
// è§†é¢‘è·¯å¾„ï¼šMediaStore.Audio.Media.DATA
String videoPath = cursor.getString(cursor.getColumnIndexOrThrow(MediaStore.Video.Media.DATA));
// è§†é¢‘æ—¶é•¿ï¼šMediaStore.Audio.Media.DURATION
int duration = cursor.getInt(cursor.getColumnIndexOrThrow(MediaStore.Video.Media.DURATION));
// è§†é¢‘å¤§å°ï¼šMediaStore.Audio.Media.SIZE
long size = cursor.getLong(cursor.getColumnIndexOrThrow(MediaStore.Video.Media.SIZE));
// è§†é¢‘ç¼©ç•¥å›¾è·¯å¾„ï¼šMediaStore.Images.Media.DATA
String imagePath = cursor.getString(cursor.getColumnIndexOrThrow(MediaStore.Images.Media.DATA));
// ç¼©ç•¥å›¾ID:MediaStore.Audio.Media._ID
int imageId = cursor.getInt(cursor.getColumnIndexOrThrow(MediaStore.Images.Media._ID));
```

***

### MediaRecorderåŸºäºCamera APIå®ç°è‡ªå®šä¹‰ç›¸æœº

è§†é¢‘å½•åˆ¶ä¹Ÿå¯ä»¥é€šè¿‡ MediaRecorder ç±»å®Œæˆï¼Œå…¶æ­¥éª¤ä¸éŸ³é¢‘å½•åˆ¶åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯æ·»åŠ äº†ä¸€äº›å¯¹è§†é¢‘è¿›è¡Œå¤„ç†çš„æ“ä½œã€‚

è§†é¢‘å½•åˆ¶çš„åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š

**1. è°ƒç”¨Camera.open()æ–¹æ³•æ‰“å¼€æ‘„åƒå¤´ã€‚**

**2. è°ƒç”¨ Camera.setPreviewDisplay() è¿æ¥é¢„è§ˆçª—å£ã€‚**

ä»¥ä¾¿å°†ä»æ‘„åƒå¤´è·å–çš„å›¾åƒæ”¾ç½®åˆ°é¢„è§ˆçª—å£ä¸­æ˜¾ç¤ºå‡ºæ¥ã€‚

**3. è°ƒç”¨ Camera.startPreview()å¯åŠ¨é¢„è§ˆã€‚**

æ˜¾ç¤ºæ‘„åƒå¤´æ‹æ‘„åˆ°çš„å›¾åƒã€‚

æ‰“å¼€æ‘„åƒæœºopenCamera()

``` java
private void openCamera() {
    Log.d(TAG, "openCamera.");
    try {
        camera = Camera.open(Camera.CameraInfo.CAMERA_FACING_BACK);
        // æ—‹è½¬æˆç«–å±
        camera.setDisplayOrientation(90);
    } catch (Exception e) {
        Log.e(TAG, "open camera error!");
        e.printStackTrace();
        return;
    }
    try {
        camera.setPreviewDisplay(mSurfaceHolder);
    } catch (IOException e) {
        Log.e(TAG, "preview failed.");
        e.printStackTrace();
    }
    camera.startPreview();
}
```

**4. ä½¿ç”¨ MediaRecorder è¿›è¡Œè§†é¢‘å½•åˆ¶ã€‚**

1ï¼‰ä½¿ç”¨ Camera.unlock() æ–¹æ³•è§£é”æ‘„åƒå¤´ï¼Œä»¥ä½¿ MediaRecorder è·å¾—å¯¹æ‘„åƒå¤´çš„ä½¿ç”¨æƒã€‚

unlockçš„ä½œç”¨æ˜¯ï¼šCameraå±äºç¡¬ä»¶è®¾å¤‡ï¼Œé€šå¸¸æƒ…å†µä¸‹Cameraè¢«ä¸€ä¸ªä½¿ç”¨Cameraçš„è¿›ç¨‹é”å®šï¼Œæ˜¯ä¸å…è®¸å…¶ä»–è¿›ç¨‹ä½¿ç”¨çš„ã€‚unLockå¿…é¡»åœ¨ä½ è°ƒç”¨MediaRecorder.setCameraä¹‹å‰è°ƒç”¨ã€‚

ä»api14 å¼€å§‹ï¼Œå½•åˆ¶è§†é¢‘æ—¶MediaRecorderè°ƒç”¨startå‡½æ•°æ—¶Camera ä¼šè‡ªåŠ¨çš„è°ƒç”¨Lockï¼Œæ‰€ä»¥å†å¼€å§‹å½•åˆ¶è§†é¢‘ä¹‹å‰æˆ–è€…å½•åˆ¶è§†é¢‘ç»“æŸä¹‹åä¸éœ€è¦æ‰‹åŠ¨çš„è°ƒç”¨lockå‡½æ•°ã€‚

ã€æ³¨æ„ï¼šlockå’ŒunLock éƒ½æ˜¯åªæœ‰åœ¨å½•åˆ¶è§†é¢‘æ—¶æ‰ä¼šä½¿ç”¨ï¼Œå…¶ä»–æƒ…å†µç”¨ä¸åˆ°è¿™ä¸¤ä¸ªå‡½æ•°ã€‚å¦‚æœä½ ä¸æ˜¯è¦å½•åˆ¶è§†é¢‘ï¼Œåªæ˜¯ç®€å•åœ°é¢„è§ˆä¸éœ€è¦è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚ã€‘

unlock()è§£é”æ‘„åƒæœº

``` java
Camera.Parameters params = camera.getParameters();
int height = params.getSupportedVideoSizes().get(3).height;
int width = params.getSupportedVideoSizes().get(3).width;
// ç»™æ‘„åƒå¤´è§£é”
camera.unlock();
// MediaRecorderè·å–åˆ°æ‘„åƒå¤´çš„è®¿é—®æƒ
mVideoRecorder.setCamera(camera);
```

2ï¼‰é…ç½® MediaRecorderã€‚

éŸ³é¢‘æºå’Œè§†é¢‘æºä¸­åŒ…æ‹¬

``` java
AudioSourceç±»ä¸­åŒ…æ‹¬ï¼šï¼ˆä¸€èˆ¬ä½¿ç”¨é»˜è®¤æˆ–è€…ä¸»éº¦å…‹é£æˆ–è€…æ‘„åƒå¤´æ—è¾¹çš„éº¦å…‹é£ã€‚ï¼‰
    MediaRecorder.AudioSource.DEFAULTï¼š é»˜è®¤éŸ³é¢‘æº
    MediaRecorder.AudioSource.MICï¼šä¸»éº¦å…‹é£ã€‚
    MediaRecorder.AudioSource.VOICE_CALLï¼šæ¥æºä¸ºè¯­éŸ³æ‹¨å‡ºçš„è¯­éŸ³ä¸å¯¹æ–¹è¯´è¯çš„å£°éŸ³
    MediaRecorder.AudioSource.VOICE_COMMUNICATIONï¼šæ‘„åƒå¤´æ—è¾¹çš„éº¦å…‹é£
    MediaRecorder.AudioSource.VOICE_DOWNLINKï¼šä¸‹è¡Œå£°éŸ³
    MediaRecorder.AudioSource.VOICE_RECOGNITIONï¼šè¯­éŸ³è¯†åˆ«
    MediaRecorder.AudioSource.VOICE_UPLINKï¼šä¸Šè¡Œå£°éŸ³
 
VideoSourceç±»ä¸­åŒ…æ‹¬ï¼š
    VideoSource.DEFAULT:é»˜è®¤
    VideoSource.CAMERA:æ‘„åƒå¤´
    VideoSource.SURFACEï¼šSurfaceä½œä¸ºæ¥æº
 
åœ¨å½•åˆ¶è§†é¢‘çš„æ­¥éª¤ä¸­æœ‰ä¸€æ­¥æ˜¯è°ƒç”¨setCameraè®¾ç½®Cameraï¼Œè¿™ä¸€æ­¥ç›¸å½“äºè®¾ç½®æ¥æºæ˜¯æ‘„åƒå¤´ï¼Œä¸‹é¢å°±éœ€è¦ä½¿ç”¨VideoSource.CAMERAä½œä¸ºè§†é¢‘æºï¼Œè¿˜å¯ä»¥ä½¿ç”¨MediaRecorderçš„getSurfaceæ’­æ”¾è§†é¢‘ï¼Œä»£æ›¿setCameraï¼Œè¿™æ—¶çš„è§†é¢‘æ¥æºå°±æ˜¯Surfaceã€‚
```

å»ºç«‹ MediaRecorder ç±»çš„å¯¹è±¡ï¼Œå¹¶è®¾ç½®éŸ³é¢‘æºå’Œè§†é¢‘æº

``` java
MediaRecorder mVideoRecorder = new MediaRecorder();
// è®¾ç½®è§†é¢‘å½•åˆ¶è¿‡ç¨‹ä¸­æ‰€å½•åˆ¶çš„éŸ³é¢‘æ¥è‡ªæ‰‹æœºçš„éº¦å…‹é£
mVideoRecorder.setAudioSource(MediaRecorder.AudioSource.MIC);
// mVideoRecorder.setAudioSource(MediaRecorder.AudioSource.CAMCORDER);ç³»ç»Ÿå†…éƒ¨å£°éŸ³
// è®¾ç½®è§†é¢‘æºä¸ºæ‘„åƒå¤´
mVideoRecorder.setVideoSource(MediaRecorder.VideoSource.CAMERA);
```

è®¾ç½®è§†é¢‘çš„è¾“å‡ºå’Œç¼–ç æ ¼å¼

``` java
// è®¾ç½®è§†é¢‘å½•åˆ¶çš„è¾“å‡ºæ–‡ä»¶ä¸ºmp4æ–‡ä»¶
mVideoRecorder.setOutputFormat(MediaRecorder.OutputFormat.MPEG_4);
// è®¾ç½®éŸ³é¢‘ç¼–ç æ–¹å¼ä¸ºAAC
mVideoRecorder.setAudioEncoder(MediaRecorder.AudioEncoder.AAC);
// è®¾ç½®å½•åˆ¶çš„è§†é¢‘ç¼–ç ä¸ºH.264
mVideoRecorder.setVideoEncoder(MediaRecorder.VideoEncoder.H264);
// è®¾ç½®è§†é¢‘å½•åˆ¶çš„åˆ†è¾¨ç‡ï¼Œå¿…é¡»æ”¾åœ¨è®¾ç½®ç¼–ç å’Œæ ¼å¼çš„åé¢ï¼Œå¦åˆ™æŠ¥é”™
mVideoRecorder.setVideoSize(width, height);
// è®¾ç½®å½•åˆ¶çš„è§†é¢‘çš„è§†é¢‘å¸§ç‡ï¼Œå¿…é¡»æ”¾åœ¨è®¾ç½®ç¼–ç å’Œæ ¼å¼çš„åé¢ï¼Œå¦åˆ™æŠ¥é”™
mVideoRecorder.setVideoFrameRate(30);
mVideoRecorder.setVideoEncodingBitRate(8*1024*1024);
```

ä¹Ÿå¯ä»¥é€šè¿‡ CamcorderProfile å¯¹è±¡å¯ç”¨äºå¯¹ MediaRecorder è¿›è¡Œç›¸å…³è®¾ç½®ã€‚

CamcorderProfile ä¸ºé¢„å…ˆå®šä¹‰å¥½çš„ä¸€ç»„è§†é¢‘å½•åˆ¶ç›¸å…³é…ç½®ä¿¡æ¯ã€‚

Android SDK å…±å®šä¹‰äº†10+ç§ CamcorderProfile é…ç½®ï¼Œå¦‚ CamcorderProfile. QUALITY_HIGHã€CamcorderProfile. QUALITY_LOWã€CamcorderProfile. QUALITY_TIME_LAPSE_1080P ç­‰ã€‚å…¶ä¸­ï¼ŒQUALITY_LOW å’Œ QUALITY_HIGH ä¸¤ç§é…ç½®æ˜¯æ‰€æœ‰çš„æ‘„åƒå¤´éƒ½æ”¯æŒçš„ï¼Œå…¶ä»–é…ç½®åˆ™æ ¹æ®ç¡¬ä»¶æ€§èƒ½å†³å®šã€‚

æ¯ä¸€ç§é…ç½®éƒ½æ¶‰åŠæ–‡ä»¶è¾“å‡ºæ ¼å¼ã€è§†é¢‘ç¼–ç æ ¼å¼ã€è§†é¢‘æ¯”ç‰¹ç‡ã€è§†é¢‘å¸§ç‡ã€è§†é¢‘çš„é«˜å’Œå®½ã€éŸ³é¢‘ç¼–ç æ ¼å¼ã€éŸ³é¢‘çš„æ¯”ç‰¹ç‡ã€éŸ³é¢‘é‡‡æ ·ç‡å’ŒéŸ³é¢‘å½•åˆ¶çš„é€šé“æ•°å‡ ä¸ªæ–¹é¢ã€‚é€šè¿‡ä½¿ç”¨è¿™äº›é¢„å®šä¹‰é…ç½®èƒ½å¤Ÿé™ä½ä»£ç å¤æ‚åº¦ï¼Œæé«˜ç¼–ç æ•ˆç‡ã€‚

CamcorderProfileå’Œå‚æ•°è®¾ç½®

``` java
CamcorderProfile get(int cameraId, int quality)
CamcorderProfile get(int quality)
// å‚æ•°è¯´æ˜
// cameraIdï¼šæ‘„åƒå¤´idï¼Œåˆ†ä¸ºå‰ç½®æ‘„åƒå¤´æˆ–è€…åç½®æ‘„åƒå¤´ã€‚
// qualityï¼šè´¨é‡æƒ…å†µ
// ç¬¬ä¸€ç§ä¾‹å¦‚QUALITY_HIGHï¼šéœ€è¦æ‰‹åŠ¨è®¾ç½®ç ç‡æ¯”ç‰¹ç‡é‡‡æ ·ç‡ç­‰
// QUALITY_TIME_LAPSE_HIGHï¼šæ—¶é—´æµé€è´¨é‡ï¼ˆæ¯”ç‰¹ç‡ï¼‰
// QUALITY_HIGH_SPEED_HIGHï¼šé«˜é€Ÿï¼ˆé«˜å¸§ç‡ï¼‰è´¨é‡
 
CamcorderProfile mCamcorderProfile = CamcorderProfile.get(Camera.CameraInfo.CAMERA_FACING_BACK, CamcorderProfile.QUALITY_HIGH);
mMediaRecorder.setProfile(mCamcorderProfile);
// åˆ©ç”¨setProfileè®¾ç½®å‚æ•°å¿…é¡»åœ¨è®¾ç½®äº†videoå’Œaudio Sourceä¹‹åè°ƒç”¨ï¼Œåœ¨setOutputFileä¹‹å‰è®¾ç½®ã€‚å¦‚æœæ—¶é—´æµé€çš„CamcorderProfileè¢«ä½¿ç”¨ï¼Œaudioç›¸å…³çš„æºæˆ–è€…å‚æ•°è®¾ç½®å°†è¢«å¿½ç•¥ã€‚
// æ³¨æ„ï¼šå¦‚æœè°ƒç”¨äº†setProfileå‡½æ•°ï¼ŒsetOutputFormatï¼ŒsetAudioEncoderï¼ŒsetVideoEncoderï¼Œä¸èƒ½å†è°ƒç”¨è®¾ç½®ã€‚
```

è®¾ç½®å½•åˆ¶çš„è§†é¢‘æ–‡ä»¶çš„ä¿å­˜ä½ç½®åŠæ–‡ä»¶å

``` java
mVideoRecorder.setOutputFile(PATH_NAME);
```

ä½¿ç”¨ MediaRecorder.setPreviewDisplay() æ–¹æ³•æŒ‡å®š MediaRecorder çš„è§†é¢‘é¢„è§ˆçª—å£

``` java
mVideoRecorder.setPreviewDisplay(mSurfaceHolder.getSurface());
```

3ï¼‰å°†å½•åƒå™¨ç½®äºå‡†å¤‡çŠ¶æ€ï¼Œç„¶åå¯åŠ¨å½•åƒå™¨

``` java
mVideoRecorder.prepare();
mVideoRecorder.start();
```

**5. è§†é¢‘å½•åˆ¶å®Œæˆåï¼Œå¯ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åœæ­¢è§†é¢‘å½•åˆ¶ã€‚**

åœæ­¢å½•åƒå™¨ï¼Œé‡ç½®å½•åƒå™¨çš„ç›¸å…³é…ç½®ï¼Œé‡Šæ”¾å½•åƒå™¨å¯¹è±¡

``` java
mMediaRecorder.stop();
mMediaRecorder.reset();
mMediaRecorder.release();
```

ã€è°ƒç”¨ Camera.lock() æ–¹æ³•é”å®šæ‘„åƒå¤´ã€‚ä» Android Nï¼ˆ7.xï¼‰ å¼€å§‹ï¼Œè¯¥è°ƒç”¨ä¹Ÿä¸å†å¿…éœ€ï¼Œé™¤é MediaRecorder.prepare() æ–¹æ³•å¤±è´¥ã€‘

**6. è°ƒç”¨Camera.stopPreview()æ–¹æ³•åœæ­¢é¢„è§ˆã€‚**

**7. è°ƒç”¨Camera.release()æ–¹æ³•é‡Šæ”¾æ‘„åƒå¤´ã€‚**

``` java
private void releaseCamera() {
    if (camera != null) {
        camera.release();
        camera = null;
    }
}
```

**#. å…¶å®ƒä¸€äº›å…³äºMediaRecorderçš„æ–¹æ³•ã€‚**

Android 4.0.3 å¼•å…¥å¯ä»¥ä½¿å›¾åƒç¨³å®šåŒ–ï¼ˆé€šè¿‡ä¿®æ”¹å‚æ•°ï¼‰

``` java
Camera.Parameters parameters = camera.getParameters();
// ä¸æ˜¯æ‰€æœ‰çš„ç…§ç›¸æœºè®¾å¤‡éƒ½æ”¯æŒå›¾åƒç¨³å®šåŒ–ï¼Œæ‰€ä»¥éœ€è¦å…ˆæ£€æŸ¥ä¸‹
if (parameters.isVideoStabilizationSupported()) {
    parameters.setVideoStabilization(true);
}
camera.setParameters(parameters);
```

åˆ›å»ºä¸€ä¸ªå»¶æ—¶çš„è§†é¢‘

``` java
// Capture an image every 30 seconds.
// å‚æ•°æ˜¯Double fpsï¼Œå³æ¯ç§’çš„å¸§æ•°
mediaRecorder.setCaptureRate(0.03);
```

***

### Camera2

#### ç®€ä»‹

Android 5.0ï¼ˆAPI 21ï¼‰å¼€å§‹å‡ºç°äº†æ–°çš„ç›¸æœºCamera 2 APIï¼Œå¼ƒç”¨ä»¥å‰çš„Camera APIï¼Œè¿™æ˜¯å› ä¸ºCamera1 é‚£å¯¥å¯¥æ— å‡ çš„ API å’Œæå·®çš„çµæ´»æ€§æ—©å·²ä¸èƒ½æ»¡è¶³æ—¥ç›Šå¤æ‚çš„ç›¸æœºåŠŸèƒ½å¼€å‘ã€‚Camera2 çš„å‡ºç°ç»™ç›¸æœºåº”ç”¨ç¨‹åºå¸¦æ¥äº†å·¨å¤§çš„å˜é©ï¼Œå› ä¸ºå®ƒçš„ç›®çš„æ˜¯ä¸ºäº†ç»™åº”ç”¨å±‚æä¾›æ›´å¤šçš„ç›¸æœºæ§åˆ¶æƒé™ï¼Œä»è€Œæ„å»ºå‡ºæ›´é«˜è´¨é‡çš„ç›¸æœºåº”ç”¨ç¨‹åºã€‚

Camera2 APIä¸ä»…æé«˜äº†androidç³»ç»Ÿçš„æ‹ç…§æ€§èƒ½ï¼Œè¿˜æ”¯æŒRAWç…§ç‰‡è¾“å‡ºï¼Œè¿˜å¯ä»¥è®¾ç½®ç›¸æœºçš„å¯¹ç„¦æ¨¡å¼ï¼Œæ›å…‰æ¨¡å¼ï¼Œå¿«é—¨ç­‰ç­‰ã€‚

{% asset_img 1.webp %}

è¿™é‡Œå¼•ç”¨äº†ç®¡é“çš„æ¦‚å¿µå°†å®‰å“è®¾å¤‡å’Œæ‘„åƒå¤´ä¹‹é—´è”é€šèµ·æ¥ï¼Œç³»ç»Ÿå‘æ‘„åƒå¤´å‘é€ Capture è¯·æ±‚ï¼Œè€Œæ‘„åƒå¤´ä¼šè¿”å› CameraMetadataã€‚è¿™ä¸€åˆ‡å»ºç«‹åœ¨ä¸€ä¸ªå«ä½œ CameraCaptureSession çš„ä¼šè¯ä¸­ã€‚

æ•´ä¸ªæ‹æ‘„æµç¨‹å¦‚ä¸‹ï¼š

1. åˆ›å»ºä¸€ä¸ªç”¨äºä» Pipeline è·å–å›¾ç‰‡çš„ CaptureRequestã€‚

2. ä¿®æ”¹ CaptureRequest çš„é—ªå…‰ç¯é…ç½®ï¼Œè®©é—ªå…‰ç¯åœ¨æ‹ç…§è¿‡ç¨‹ä¸­äº®èµ·æ¥ã€‚

3. åˆ›å»ºä¸¤ä¸ªä¸åŒå°ºå¯¸çš„ Surface ç”¨äºæ¥æ”¶å›¾ç‰‡æ•°æ®ï¼Œå¹¶ä¸”å°†å®ƒä»¬æ·»åŠ åˆ° CaptureRequest ä¸­ã€‚

4. å‘é€é…ç½®å¥½çš„ CaptureRequest åˆ° Pipeline ä¸­ç­‰å¾…å®ƒè¿”å›æ‹ç…§ç»“æœã€‚

{% asset_img 2.webp %}

ä¸€ä¸ªæ–°çš„ CaptureRequest ä¼šè¢«æ”¾å…¥ä¸€ä¸ªè¢«ç§°ä½œ Pending Request Queue çš„é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«æ‰§è¡Œï¼Œå½“ In-Flight Capture Queue é˜Ÿåˆ—ç©ºé—²çš„æ—¶å€™å°±ä¼šä» Pending Request Queue è·å–è‹¥å¹²ä¸ªå¾…å¤„ç†çš„ CaptureRequestï¼Œå¹¶ä¸”æ ¹æ®æ¯ä¸€ä¸ª CaptureRequest çš„é…ç½®è¿›è¡Œ Capture æ“ä½œã€‚æœ€åæˆ‘ä»¬ä»ä¸åŒå°ºå¯¸çš„ Surface ä¸­è·å–å›¾ç‰‡æ•°æ®å¹¶ä¸”è¿˜ä¼šå¾—åˆ°ä¸€ä¸ªåŒ…å«äº†å¾ˆå¤šä¸æœ¬æ¬¡æ‹ç…§ç›¸å…³çš„ä¿¡æ¯çš„ CaptureResultï¼Œæµç¨‹ç»“æŸã€‚

#### Camera2 ä¸­ä¸»è¦çš„APIç±»

{% asset_img 3.webp %}

CameraManagerç±»ï¼šæ‘„åƒå¤´ç®¡ç†ç±»ï¼Œç”¨äºæ£€æµ‹ã€æ‰“å¼€ç³»ç»Ÿæ‘„åƒå¤´ï¼Œé€šè¿‡getCameraCharacteristics(cameraId)å¯ä»¥è·å–æ‘„åƒå¤´ç‰¹å¾ã€‚

CameraCharacteristicsç±»ï¼šç›¸æœºç‰¹æ€§ç±»ï¼Œä¾‹å¦‚ï¼Œæ˜¯å¦æ”¯æŒè‡ªåŠ¨è°ƒç„¦ï¼Œæ˜¯å¦æ”¯æŒzoomï¼Œæ˜¯å¦æ”¯æŒé—ªå…‰ç¯ä¸€ç³»åˆ—ç‰¹å¾ã€‚

CameraDeviceç±»ï¼š ç›¸æœºè®¾å¤‡ï¼Œç±»ä¼¼æ—©æœŸçš„cameraç±»ã€‚

CameraCaptureSessionç±»ï¼šç”¨äºåˆ›å»ºé¢„è§ˆã€æ‹ç…§çš„Sessionç±»ã€‚é€šè¿‡å®ƒçš„setRepeatingRequest()æ–¹æ³•æ§åˆ¶é¢„è§ˆç•Œé¢ï¼Œé€šè¿‡å®ƒçš„capture()æ–¹æ³•æ§åˆ¶æ‹ç…§åŠ¨ä½œæˆ–è€…å½•åƒåŠ¨ä½œã€‚

CameraRequestç±»ï¼šä¸€æ¬¡æ•è·çš„è¯·æ±‚ï¼Œå¯ä»¥è®¾ç½®ä¸€äº›åˆ—çš„å‚æ•°ï¼Œç”¨äºæ§åˆ¶é¢„è§ˆå’Œæ‹ç…§å‚æ•°ï¼Œä¾‹å¦‚ï¼šå¯¹ç„¦æ¨¡å¼ï¼Œæ›å…‰æ¨¡å¼ï¼Œzoomå‚æ•°ç­‰ç­‰ã€‚

``` java
// CameraManagerç±»

é€šè¿‡ä»¥ä¸‹ä»£ç å¯ä»¥è·å–æ‘„åƒå¤´çš„ç‰¹å¾å¯¹è±¡ï¼Œä¾‹å¦‚ï¼šå‰åæ‘„åƒå¤´ï¼Œåˆ†è¾¨ç‡ç­‰ã€‚
CameraCharacteristics cameraCharacteristics = manager.getCameraCharacteristics(cameraId);
```

``` java
// CameraCharacteristicsç±»

ç›¸æœºç‰¹æ€§ç±»
CameraCharacteristicsæ˜¯ä¸€ä¸ªåŒ…å«ç›¸æœºå‚æ•°çš„å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡ä¸€äº›keyè·å–å¯¹åº”çš„valuesã€‚
 
ä»¥ä¸‹å‡ ç§å¸¸ç”¨çš„å‚æ•°ï¼š
LENS_FACINGï¼šè·å–æ‘„åƒå¤´æ–¹å‘ã€‚LENS_FACING_FRONTæ˜¯å‰æ‘„åƒå¤´ï¼ŒLENS_FACING_BACKæ˜¯åæ‘„åƒå¤´ã€‚
SENSOR_ORIENTATIONï¼šè·å–æ‘„åƒå¤´æ‹ç…§çš„æ–¹å‘ã€‚
FLASH_INFO_AVAILABLEï¼šè·å–æ˜¯å¦æ”¯æŒé—ªå…‰ç¯ã€‚
SCALER_AVAILABLE_MAX_DIGITAL_ZOOMï¼šè·å–æœ€å¤§çš„æ•°å­—è°ƒç„¦å€¼ï¼Œä¹Ÿå°±æ˜¯zoomæœ€å¤§å€¼ã€‚
LENS_INFO_MINIMUM_FOCUS_DISTANCEï¼šè·å–æœ€å°çš„è°ƒç„¦è·ç¦»ï¼ŒæŸäº›æ‰‹æœºä¸Šè·å–åˆ°çš„è¯¥valuesä¸ºnullæˆ–è€…0.0ã€‚å‰æ‘„åƒå¤´å¤§éƒ¨åˆ†æœ‰å›ºå®šç„¦è·ï¼Œæ— æ³•è°ƒèŠ‚ã€‚
INFO_SUPPORTED_HARDWARE_LEVELï¼šè·å–æ‘„åƒå¤´æ”¯æŒæŸäº›ç‰¹æ€§çš„ç¨‹åº¦ã€‚
 
ä»¥ä¸‹æ‰‹æœºä¸­æ”¯æŒçš„è‹¥å¹²ç§ç¨‹åº¦ï¼š
INFO_SUPPORTED_HARDWARE_LEVEL_FULLï¼šå…¨æ–¹ä½çš„ç¡¬ä»¶æ”¯æŒï¼Œå…è®¸æ‰‹åŠ¨æ§åˆ¶å…¨é«˜æ¸…çš„æ‘„åƒã€æ”¯æŒè¿æ‹æ¨¡å¼ä»¥åŠå…¶ä»–æ–°ç‰¹æ€§ã€‚
INFO_SUPPORTED_HARDWARE_LEVEL_LIMITEDï¼šæœ‰é™æ”¯æŒï¼Œè¿™ä¸ªéœ€è¦å•ç‹¬æŸ¥è¯¢ã€‚
INFO_SUPPORTED_HARDWARE_LEVEL_LEGACYï¼šæ‰€æœ‰è®¾å¤‡éƒ½ä¼šæ”¯æŒï¼Œä¹Ÿå°±æ˜¯å’Œè¿‡æ—¶çš„Camera APIæ”¯æŒçš„ç‰¹æ€§æ˜¯ä¸€è‡´çš„ã€‚
```

``` java
// CameraDeviceç±»

CameraDeviceçš„reateCaptureRequest(int templateType)æ–¹æ³•åˆ›å»ºCaptureRequest.Builderã€‚
 
templateTypeå‚æ•°æœ‰ä»¥ä¸‹å‡ ç§ï¼š
TEMPLATE_PREVIEWï¼šé¢„è§ˆ
TEMPLATE_RECORDï¼šæ‹æ‘„è§†é¢‘
TEMPLATE_STILL_CAPTUREï¼šæ‹ç…§
TEMPLATE_VIDEO_SNAPSHOTï¼šåˆ›å»ºè§†è§†é¢‘å½•åˆ¶æ—¶æˆªå±çš„è¯·æ±‚
TEMPLATE_ZERO_SHUTTER_LAGï¼šåˆ›å»ºä¸€ä¸ªé€‚ç”¨äºé›¶å¿«é—¨å»¶è¿Ÿçš„è¯·æ±‚ã€‚åœ¨ä¸å½±å“é¢„è§ˆå¸§ç‡çš„æƒ…å†µä¸‹æœ€å¤§åŒ–å›¾åƒè´¨é‡ã€‚
TEMPLATE_MANUALï¼šåˆ›å»ºä¸€ä¸ªåŸºæœ¬æ•è·è¯·æ±‚ï¼Œè¿™ç§è¯·æ±‚ä¸­æ‰€æœ‰çš„è‡ªåŠ¨æ§åˆ¶éƒ½æ˜¯ç¦ç”¨çš„(è‡ªåŠ¨æ›å…‰ï¼Œè‡ªåŠ¨ç™½å¹³è¡¡ã€è‡ªåŠ¨ç„¦ç‚¹)ã€‚
```

``` java
// CameraDevice.StateCallbackæŠ½è±¡ç±»

è¯¥æŠ½è±¡ç±»ç”¨äºCemeraDeviceç›¸æœºè®¾å¤‡çŠ¶æ€çš„å›è°ƒã€‚
 
/**
 * å½“ç›¸æœºè®¾å¤‡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œå°†ä¼šå›è°ƒã€‚
 */
protected final CameraDevice.StateCallback stateCallback = new CameraDevice.StateCallback() {
    /**
     * å½“ç›¸æœºæ‰“å¼€çš„æ—¶å€™ï¼Œè°ƒç”¨
     * @param cameraDevice
     */
    @Override
    public void onOpened(@NonNull CameraDevice cameraDevice) {
        mCameraDevice = cameraDevice;
        startPreView();
    }
 
    @Override
    public void onDisconnected(@NonNull CameraDevice cameraDevice) {
        cameraDevice.close();
        mCameraDevice = null;
    }
 
    /**
     * å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™è°ƒç”¨
     *
     * è¿™é‡Œé‡Šæ”¾èµ„æºï¼Œç„¶åå…³é—­ç•Œé¢
     * @param cameraDevice
     * @param error
     */
    @Override
    public void onError(@NonNull CameraDevice cameraDevice, int error) {
        cameraDevice.close();
        mCameraDevice = null;
    }
 
    /**
     *å½“ç›¸æœºè¢«å…³é—­çš„æ—¶å€™
     */
    @Override
    public void onClosed(@NonNull CameraDevice camera) {
        super.onClosed(camera);
    }
};
```

``` java
// CameraCaptureSession.StateCallbackæŠ½è±¡ç±»

è¯¥æŠ½è±¡ç±»ç”¨äºSessionè¿‡ç¨‹ä¸­çŠ¶æ€çš„å›è°ƒã€‚
 
public static abstract class StateCallback {
 
    //æ‘„åƒå¤´å®Œæˆé…ç½®ï¼Œå¯ä»¥å¤„ç†Captureè¯·æ±‚äº†ã€‚
    public abstract void onConfigured(@NonNull CameraCaptureSession session);
 
    //æ‘„åƒå¤´é…ç½®å¤±è´¥
    public abstract void onConfigureFailed(@NonNull CameraCaptureSession session);
 
    //æ‘„åƒå¤´å¤„äºå°±ç»ªçŠ¶æ€ï¼Œå½“å‰æ²¡æœ‰è¯·æ±‚éœ€è¦å¤„ç†
    public void onReady(@NonNull CameraCaptureSession session) {}
 
    //æ‘„åƒå¤´æ­£åœ¨å¤„ç†è¯·æ±‚
    public void onActive(@NonNull CameraCaptureSession session) {}
 
    //è¯·æ±‚é˜Ÿåˆ—ä¸­ä¸ºç©ºï¼Œå‡†å¤‡ç€æ¥å—ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚
    public void onCaptureQueueEmpty(@NonNull CameraCaptureSession session) {}
 
    //ä¼šè¯è¢«å…³é—­
    public void onClosed(@NonNull CameraCaptureSession session) {}
 
    //Surfaceå‡†å¤‡å°±ç»ª
    public void onSurfacePrepared(@NonNull CameraCaptureSession session,@NonNull Surface surface) {}
}
```

CameraManager æ˜¯é‚£ä¸ªç«™åœ¨é«˜å¤„ç»Ÿç®¡æ‰€æœ‰æ‘„åƒæŠ•è®¾å¤‡ï¼ˆCameraDeviceï¼‰çš„ç®¡ç†è€…ï¼Œè€Œæ¯ä¸ª CameraDevice è‡ªå·±ä¼šè´Ÿè´£å»ºç«‹ CameraCaptureSession ä»¥åŠå»ºç«‹ CaptureRequestã€‚

CameraCharacteristics æ˜¯ CameraDevice çš„å±æ€§æè¿°ç±»ï¼Œéè¦åšä¸ªå¯¹æ¯”çš„è¯ï¼Œé‚£ä¹ˆå®ƒä¸åŸæ¥çš„ CameraInfo æœ‰ç›¸ä¼¼æ€§ã€‚

ç±»å›¾ä¸­æœ‰ç€ä¸‰ä¸ªé‡è¦çš„ callbackï¼Œå…¶ä¸­ CameraCaptureSession.CaptureCallback å°†å¤„ç†é¢„è§ˆå’Œæ‹ç…§å›¾ç‰‡çš„å·¥ä½œï¼Œéœ€è¦é‡ç‚¹å¯¹å¾…ã€‚

è¿™äº›ç±»æ˜¯å¦‚ä½•ç›¸äº’é…åˆçš„ï¼Ÿä¸‹é¢æ˜¯ç®€å•çš„æµç¨‹å›¾ã€‚

{% asset_img 4.webp %}

#### Camera2 æ‹ç…§å’Œå½•åƒæµç¨‹ä¾‹å­

**1. æ‰“å¼€æŒ‡å®šçš„æ–¹å‘çš„ç›¸æœºã€‚**

æœ€å…ˆè·å–CameraManagerå¯¹è±¡ï¼Œé€šè¿‡è¯¥å¯¹è±¡çš„getCameraIdList()è·å–åˆ°ä¸€äº›åˆ—çš„æ‘„åƒå¤´å‚æ•°ã€‚

é€šè¿‡å¾ªç¯åŒ¹é…ï¼Œè·å–åˆ°æŒ‡å®šæ–¹å‘çš„æ‘„åƒå¤´ï¼Œä¾‹å¦‚åæ‘„åƒå¤´ç­‰

``` java
CameraManager manager = (CameraManager)getSystemService(Context.CAMERA_SERVICE);
 
// è·å–åˆ°å¯ç”¨çš„ç›¸æœº
for (String cameraId : manager.getCameraIdList()) {
 
    // è·å–åˆ°æ¯ä¸ªç›¸æœºçš„å‚æ•°å¯¹è±¡ï¼ŒåŒ…å«å‰åæ‘„åƒå¤´ï¼Œåˆ†è¾¨ç‡ç­‰
    CameraCharacteristics  cameraCharacteristics = manager.getCameraCharacteristics(cameraId);
    // æ‘„åƒå¤´çš„æ–¹å‘
    Integer facing = cameraCharacteristics.get(CameraCharacteristics.LENS_FACING);
 
    if (facing == null) {
        continue;
    }
    // åŒ¹é…æ–¹å‘,æŒ‡å®šæ‰“å¼€åæ‘„åƒå¤´
    if (facing != CameraCharacteristics.LENS_FACING_BACK) {
        continue;
    }
 
    // æ‰“å¼€æŒ‡å®šçš„æ‘„åƒå¤´
    manager.openCamera(mCameraId, stateCallback, workThreadManager.getBackgroundHandler());
 
    return;
}
```

å½“ç„¶ï¼Œå®é™…å¼€å‘ä¸­ï¼Œè¿˜éœ€è¦è·å–ç›¸æœºæ”¯æŒçš„ç‰¹æ€§ï¼ˆé—ªå…‰ç¯ã€zoomè°ƒç„¦ã€æ‰‹åŠ¨è°ƒç„¦ç­‰)ï¼Œå’Œè®¾ç½®æ‘„åƒå¤´çš„å‚æ•°ï¼ˆä¾‹å¦‚ï¼šé¢„è§ˆçš„Sizeï¼‰ã€‚

**2. åˆ›å»ºé¢„è§ˆç•Œé¢ã€‚**

CameraDevice.StateCallback å¯¹è±¡ä¼ å…¥CameraManagerä¸­openCamera(mCameraId, stateCallback, workThreadManager.getBackgroundHandler())çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œç”¨äºç›‘å¬æ‘„åƒå¤´çš„çŠ¶æ€ã€‚

åˆ›å»º CameraDevice.StateCallback å¯¹è±¡ï¼Œä¸”å¼€å¯ä¸€ä¸ªç›¸æœºã€‚å½“ç›¸æœºå¼€å¯åï¼Œå°†å‡ºç°ç›¸æœºé¢„è§ˆç•Œé¢ã€‚

``` java
/**
 * ç›¸æœºè®¾å¤‡
 */
protected CameraDevice mCameraDevice;
 
/**
 * å½“ç›¸æœºè®¾å¤‡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œå°†ä¼šå›è°ƒã€‚
 */
protected final CameraDevice.StateCallback stateCallback = new CameraDevice.StateCallback() {
    /**
     * å½“ç›¸æœºæ‰“å¼€çš„æ—¶å€™ï¼Œè°ƒç”¨
     * @param cameraDevice
     */
    @Override
    public void onOpened(@NonNull CameraDevice cameraDevice) {
        mCameraDevice = cameraDevice;
        createCameraPreviewSession();
    }
 
    // çœç•¥è¯¥çŠ¶æ€æ¥å£çš„éƒ¨åˆ†æ–¹æ³•
    ...............
};
 
/**
 * é¢„è§ˆè¯·æ±‚çš„Builder
 */
private CaptureRequest.Builder mPreviewRequestBuilder;
 
/**
 * ç›¸æœºå¼€å§‹é¢„è§ˆï¼Œåˆ›å»ºä¸€ä¸ªCameraCaptureSessionå¯¹è±¡
 */
private void createCameraPreviewSession() {
    // å°†CaptureRequestçš„æ„å»ºå™¨ä¸Surfaceå¯¹è±¡ç»‘å®šåœ¨ä¸€èµ·   
    mPreviewRequestBuilder = mCameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW);
 
    // ä¸ºç›¸æœºé¢„è§ˆï¼Œåˆ›å»ºä¸€ä¸ªCameraCaptureSessionå¯¹è±¡
    mCameraDevice.createCaptureSession(Arrays.asList(surface, imageReader.getSurface()), stateCallback, null);       
}
```

**3. åœ¨é¢„è§ˆç•Œé¢è¿‡ç¨‹ä¸­ï¼Œéœ€è¦é—´éš”åˆ·æ–°ç•Œé¢ã€‚**

ç›¸æœºé¢„è§ˆä½¿ç”¨TextureViewæ¥å®ç°ã€‚

åˆ›å»ºä¸€ä¸ªCameraCaptureSession ï¼Œé€šè¿‡ä¸€ä¸ªç”¨äºé¢„è§ˆç•Œé¢çš„CaptureRequestï¼Œé—´éš”å¤ç”¨ç»™CameraCaptureSessionã€‚

``` java
private CameraCaptureSession mCaptureSession;
 
CameraCaptureSession.StateCallback stateCallback=new CameraCaptureSession.StateCallback() {
    @Override
    public void onConfigured(@NonNull CameraCaptureSession cameraCaptureSession) {
        //å½“cameraCaptureSessionå·²ç»å‡†å¤‡å®Œæˆï¼Œå¼€å§‹æ˜¾ç¤ºé¢„è§ˆç•Œé¢
        mCaptureSession = cameraCaptureSession;
        setCameraCaptureSession();
    }
 
    // çœç•¥è¯¥æ¥å£çš„éƒ¨åˆ†æ–¹æ³•
    .......
}
 
/**
 * è®¾ç½®CameraCaptureSessionçš„ç‰¹å¾:
 * è‡ªåŠ¨å¯¹ç„¦ï¼Œé—ªå…‰ç¯
 */
private void setCameraCaptureSession() {
    // è®¾ç½®é¢„è§ˆç•Œé¢çš„ç‰¹å¾ï¼Œé€šè¿‡mPreviewRequestBuilder.set()æ–¹æ³•,ä¾‹å¦‚ï¼Œé—ªå…‰ç¯ï¼Œzoomè°ƒç„¦ç­‰
    ..........
 
    // ä¸ºCameraCaptureSessionè®¾ç½®é—´éš”çš„CaptureRequestï¼Œç”¨é—´éš”åˆ·æ–°é¢„è§ˆç•Œé¢ã€‚
    mCaptureSession.setRepeatingRequest(mPreviewRequestBuilder.build(), mCaptureCallback, workThreadManager.getBackgroundHandler());
}
```

åªè¦æœªå¼€å§‹æ‹ç…§åŠ¨ä½œæˆ–è€…å½•åƒåŠ¨ä½œï¼Œè¯¥å¤ç”¨çš„CaptureRequestä¼šé‡å¤çš„åˆ·æ–°é¢„è§ˆç•Œé¢ã€‚

æ¥ä¸‹æ¥ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»æ‹ç…§æŒ‰é’®æˆ–è€…å½•åƒæŒ‰é’®ï¼Œè¿›è¡Œæ‹ç…§åŠ¨ä½œï¼Œæˆ–è€…å½•åƒåŠ¨ä½œã€‚

**4. æ‹ç…§åŠ¨ä½œã€‚**

é¦–å…ˆé”ä½ç„¦ç‚¹ï¼Œé€šè¿‡åœ¨ç›¸æœºé¢„è§ˆç•Œé¢CaptureRequestï¼Œç„¶åä»¥ç±»ä¼¼æ–¹å¼è¿è¡Œä¸€ä¸ªé¢„æ•è·åºåˆ—ã€‚æ¥ä¸‹æ¥ï¼Œå·²ç»å‡†å¤‡å¥½æ•æ‰å›¾ç‰‡ã€‚

åˆ›å»ºä¸€ä¸ªæ–°çš„CaptureRequestï¼Œä¸”æ‹ç…§ã€‚

``` java
/**
 * æ‹ç…§ä¸€ä¸ªé™æ€çš„å›¾ç‰‡
 * å½“åœ¨CaptureCallbackç›‘å¬å™¨å“åº”çš„æ—¶å€™è°ƒç”¨è¯¥æ–¹æ³•ã€‚
 * å½“æ•°å­—è°ƒç„¦ç¼©æ”¾çš„æ—¶å€™ï¼Œåœ¨å†™å…¥å›¾ç‰‡æ•°ä¸­ä¹Ÿè¦è®¾ç½®ã€‚
 */
private void captureStillPicture() {
    try {
        // åˆ›å»ºä¸€ä¸ªæ‹ç…§çš„CaptureRequest.Builder
        final CaptureRequest.Builder captureBuilder = mCameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_STILL_CAPTURE);
 
        captureBuilder.addTarget(imageReader.getSurface());
 
        // è®¾ç½®ä¸€ç³»åˆ—çš„æ‹ç…§å‚æ•°ï¼Œè¿™é‡Œçœç•¥
        ...........
 
        // å…ˆåœæ­¢ä»¥å‰çš„é¢„è§ˆçŠ¶æ€
        mCaptureSession.stopRepeating();
        mCaptureSession.abortCaptures();
 
        // æ‰§è¡Œæ‹ç…§åŠ¨ä½œ
        mCaptureSession.capture(captureBuilder.build(), captureCallback, null);
    } catch (CameraAccessException e) {
        e.printStackTrace();
    }
}
```

æ‹ç…§ç•Œé¢äº§ç”Ÿçš„æ•°æ®åªæ˜¯åœ¨æ‰‹æœºå†…å­˜ä¸­ï¼Œå›¾ç‰‡æ˜¯ä¸€ä¸ªç£ç›˜æ–‡ä»¶ï¼Œè¿˜éœ€è¦ä¸€ä¸ªå°†æ‹ç…§äº§ç”Ÿæ•°æ®å†™å…¥æ–‡ä»¶ä¸­çš„æ“ä½œç±»ImageReaderã€‚

å…ˆæ˜¯åˆ›å»ºImageReaderå¯¹è±¡ï¼Œå’Œè®¾ç½®ç›‘å¬å™¨ç­‰ä¸€ç³»åˆ—å‚æ•°ã€‚

``` java
/**
 * å¤„ç†é™æ€å›¾ç‰‡çš„è¾“å‡º
 */
private ImageReader imageReader;
 
// å¯¹äºé™æ€å›¾ç‰‡ï¼Œä½¿ç”¨å¯ç”¨çš„æœ€å¤§å€¼æ¥æ‹æ‘„ã€‚
Size largest = Collections.max(Arrays.asList(map.getOutputSizes(ImageFormat.JPEG)), new CompareSizeByArea());
// è®¾ç½®ImageReader,å°†å¤§å°ï¼Œå›¾ç‰‡æ ¼å¼
imageReader = ImageReader.newInstance(largest.getWidth(), largest.getHeight(), ImageFormat.JPEG, /*maxImages*/2);
imageReader.setOnImageAvailableListener(onImageAvailableListener, workThreadManager.getBackgroundHandler());
```

å°†ImageReaderçš„surfaceé…ç½®åˆ°captureBuilderå¯¹è±¡ä¸­captureBuilder.addTarget(imageReader.getSurface());ï¼ˆcaptureStillPicture()ä¸­ï¼‰

å½“æ‹ç…§å®Œæˆåï¼Œä¼šåœ¨è¯¥ç›‘å¬çŠ¶æ€ä¸­å›è°ƒ

``` java
// è¿™é‡Œé‡‡ç”¨RxJava+RxAndroidå¼‚æ­¥é€šè®¯ï¼Œé¿å…å¤ªå¤šå›è°ƒæ¥å£
 
/**
 * ImageReaderçš„å›è°ƒç›‘å¬å™¨
 * onImageAvailableè¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå·²ç»æ‹ç…§å®Œï¼Œå‡†å¤‡ä¿å­˜çš„æ“ä½œ
 * é€šå¸¸å†™å…¥ç£ç›˜æ–‡ä»¶ä¸­ã€‚
 */
protected final ImageReader.OnImageAvailableListener onImageAvailableListener = (ImageReader reader)
        -> writePictureData(reader.acquireNextImage());
 
 
public void writePictureData(Image image) {
    if (camera2ResultCallBack != null) {
        camera2ResultCallBack.callBack(ObservableBuilder.createWriteCaptureImage(appContext, image));
    }
}       
 
/**
 * å°†JPEGå›¾ç‰‡çš„æ•°æ®ï¼Œå†™å…¥ç£ç›˜ä¸­
 *
 * @param context
 * @param mImage
 * @return
 */
public static Observable<String> createWriteCaptureImage(final Context context, final Image mImage) {
    Observable<String> observable = Observable.create(subscriber -> {
        File file = FileUtils.createPictureDiskFile(context, FileUtils.createBitmapFileName());
        ByteBuffer buffer = mImage.getPlanes()[0].getBuffer();
        byte[] bytes = new byte[buffer.remaining()];
        buffer.get(bytes);
        FileOutputStream output = null;
        try {
            output = new FileOutputStream(file);
            output.write(bytes);
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            mImage.close();
            if (null != output) {
                try {
                    output.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
        subscriber.onNext(file.getAbsolutePath());
    });
    return observable;
}
```

**5. å½•åƒåŠ¨ä½œã€‚**

å½•åƒæ˜¯é•¿æ—¶é—´çš„åŠ¨ä½œï¼Œå½•åƒè¿‡ç¨‹ä¸­éœ€è¦é‡å¤æ€§çš„åˆ·æ–°å½•åˆ¶ç•Œé¢ã€‚å…¶ä½™çš„æ­¥éª¤å’Œæ‹ç…§åŠ¨ä½œåŸºæœ¬ç±»ä¼¼ã€‚

``` java
/**
 * å¼€å§‹è§†é¢‘å½•åˆ¶ã€‚
 */
private void startRecordingVideo() {
    try {
        // åˆ›å»ºå½•åˆ¶çš„sessionä¼šè¯ä¸­çš„è¯·æ±‚
        mPreviewBuilder = mCameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_RECORD);
 
        // è®¾ç½®å½•åˆ¶å‚æ•°ï¼Œè¿™é‡Œçœç•¥
        .........
 
        // Start a capture session
        // Once the session starts, we can update the UI and start recording
        mCameraDevice.createCaptureSession(surfaces, new CameraCaptureSession.StateCallback() {
            @Override
            public void onConfigured(@NonNull CameraCaptureSession cameraCaptureSession) {
                mPreviewSession = cameraCaptureSession;
                Log.i(TAG, " startRecordingVideo æ­£å¼å¼€å§‹å½•åˆ¶ ");
                updatePreview();
            }
            // è¯¥æ¥å£çš„æ–¹æ³•ï¼Œéƒ¨åˆ†çœç•¥
            .............
        }, workThreadManager.getBackgroundHandler());
    } catch (CameraAccessException | IOException e) {
        e.printStackTrace();
    }
}
 
// å½•åˆ¶è¿‡ç¨‹ä¸­ï¼Œä¸æ–­åˆ·æ–°å½•åˆ¶ç•Œé¢
private void updatePreview() {
    try {
        mPreviewSession.setRepeatingRequest(mPreviewBuilder.build(), null, workThreadManager.getBackgroundHandler());
    } catch (CameraAccessException e) {
        e.printStackTrace();
    }
}
```

å’Œæ‹ç…§ç±»ä¼¼ï¼Œå°†è§†é¢‘æ•°æ®å†™å…¥ç£ç›˜æ–‡ä»¶ä¸­ï¼Œä¹Ÿæ˜¯éœ€è¦ä¸€ä¸ªæ“ä½œç±»MediaRecorderæ¥å®ç°çš„ã€‚

åˆ›å»ºè¯¥æ“ä½œç±»å¯¹è±¡ï¼Œè®¾ç½®ä¸€äº›å‚æ•°

``` java
// MediaRecorder
private MediaRecorder mMediaRecorder;
 
/**
 * è®¾ç½®åª’ä½“å½•åˆ¶å™¨çš„é…ç½®å‚æ•°
 * éŸ³é¢‘ï¼Œè§†é¢‘æ ¼å¼ï¼Œæ–‡ä»¶è·¯å¾„ï¼Œé¢‘ç‡ï¼Œç¼–ç æ ¼å¼ç­‰ç­‰
 */
private void setUpMediaRecorder() throws IOException {
    mMediaRecorder.setAudioSource(MediaRecorder.AudioSource.MIC);
    mMediaRecorder.setVideoSource(MediaRecorder.VideoSource.SURFACE);
    mMediaRecorder.setOutputFormat(MediaRecorder.OutputFormat.MPEG_4);
    mNextVideoAbsolutePath = FileUtils.createVideoDiskFile(appContext, FileUtils.createVideoFileName()).getAbsolutePath();
    mMediaRecorder.setOutputFile(mNextVideoAbsolutePath);
    mMediaRecorder.setVideoEncodingBitRate(10000000);
    // æ¯ç§’30å¸§
    mMediaRecorder.setVideoFrameRate(30);
    mMediaRecorder.setVideoSize(mVideoSize.getWidth(), mVideoSize.getHeight());
    mMediaRecorder.setVideoEncoder(MediaRecorder.VideoEncoder.H264);
    mMediaRecorder.setAudioEncoder(MediaRecorder.AudioEncoder.AAC);
    int rotation = activity.getWindowManager().getDefaultDisplay().getRotation();
    switch (mSensorOrientation) {
        case SENSOR_ORIENTATION_DEFAULT_DEGREES:
            mMediaRecorder.setOrientationHint(DEFAULT_ORIENTATIONS.get(rotation));
            break;
        case SENSOR_ORIENTATION_INVERSE_DEGREES:
            mMediaRecorder.setOrientationHint(ORIENTATIONS.get(rotation));
            break;
        default:
            break;
    }
    mMediaRecorder.prepare();
}
```

é—´éš”æ€§çš„éšç€è§†é¢‘å½•åˆ¶è€Œè¾“å‡ºæ•°æ®åˆ°æ–‡ä»¶ä¸­

``` java
// ä¸º MediaRecorderè®¾ç½®Surface
Surface recorderSurface = mMediaRecorder.getSurface();
surfaces.add(recorderSurface);
mPreviewBuilder.addTarget(recorderSurface);
```

æœ€åï¼Œå½“å½•åˆ¶è§†é¢‘ç»“æŸåï¼Œåœæ­¢è¾“å‡º

``` java
// åœæ­¢å½•åˆ¶
mMediaRecorder.stop();
mMediaRecorder.reset();
```

**6. æ¢å¤åˆ°é¢„è§ˆç•Œé¢ã€‚**

å®Œæˆä¸€äº›åˆ—æ‹ç…§æˆ–å½•åƒåŠ¨ä½œå,é‡æ–°æ¢å¤åˆ°é¢„è§ˆç•Œé¢

``` java
/**
 * å®Œæˆä¸€äº›åˆ—æ‹ç…§æˆ–å½•åƒåŠ¨ä½œåï¼Œé‡Šæ”¾ç„¦ç‚¹ã€‚
 */
private void unlockFocus() {
    try {
        //å‘sessioné‡æ–°å‘é€ï¼Œé¢„è§ˆçš„é—´éš”æ€§è¯·æ±‚ï¼Œå‡ºç°é¢„è§ˆç•Œé¢ã€‚
        mCaptureSession.setRepeatingRequest(mPreviewRequest, mCaptureCallback, workThreadManager.getBackgroundHandler());
    } catch (CameraAccessException e) {
        e.printStackTrace();
    }
}
```

å½“ç„¶ï¼Œè¿˜æœ‰å…³é—­ç›¸æœºæ“ä½œï¼Œå’Œä¸Activityç”Ÿå‘½å‘¨æœŸç»‘å®šçš„æ“ä½œï¼Œè¿™é‡Œä¸å†åšä»‹ç»äº†ã€‚

***

### æ€»ç»“

1. Camera Intentæ–¹ä¾¿å¿«æ·ï¼Œä¸éœ€è¦å¤ªå¤šçš„ä»£ç é‡ï¼›MediaRecorderä»£ç é‡ç¨å¤§

2. Camera Intentè§†é¢‘æ¸…æ™°åº¦åªæœ‰ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯æœ€ä¸æ¸…æ¥šï¼Œä¸€ä¸ªæ˜¯æœ€æ¸…æ¥šï¼›MediaRecorderè§†é¢‘æ¸…æ™°åº¦å¯æ ¹æ®æ•°å€¼è‡ªåŠ¨å¾€ä¸Šè°ƒ

3. Camera Intentåœ¨å½•åˆ¶è¿‡ç¨‹ä¸­ï¼Œæ“ä½œæ–¹ä¾¿ï¼Œæœ‰è‡ªå·±çš„æš‚åœã€å½•åˆ¶ã€æ’­æ”¾æŒ‰é’®ï¼›MediaRecorderéœ€è¦è‡ªå·±å»å†™æš‚åœã€å½•åˆ¶æˆ–æ’­æ”¾æŒ‰é’®

4. Camera1 ä¸¥æ ¼åŒºåˆ†äº†é¢„è§ˆå’Œæ‹ç…§ä¸¤ä¸ªæµç¨‹ï¼Œè€Œ Camera2 åˆ™æŠŠè¿™ä¸¤ä¸ªæµç¨‹éƒ½æŠ½è±¡æˆäº† Capture è¡Œä¸ºï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯ä¸€æ¬¡æ€§çš„ Captureï¼Œä¸€ä¸ªæ˜¯ä¸æ–­é‡å¤çš„ Capture è€Œå·²

5. å¦‚åŒ Camera1 ä¸€æ ·ï¼ŒCamera2 çš„ä¸€äº› API è°ƒç”¨ä¹Ÿä¼šè€—æ—¶ï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨ç‹¬ç«‹çš„çº¿ç¨‹æ‰§è¡Œæ‰€æœ‰çš„ç›¸æœºæ“ä½œï¼Œå°½é‡é¿å…ç›´æ¥åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ Camera2 çš„ APIï¼Œå¯ä½¿ç”¨ HandlerThread

6. Camera2 æ‰€æœ‰çš„ç›¸æœºæ“ä½œéƒ½å¯ä»¥æ³¨å†Œç›¸å…³çš„å›è°ƒæ¥å£ï¼Œç„¶ååœ¨ä¸åŒçš„å›è°ƒæ–¹æ³•é‡Œå†™ä¸šåŠ¡é€»è¾‘ï¼Œè¿™å¯èƒ½ä¼šè®©ä»£ç å› ä¸ºä¸å¤Ÿçº¿æ€§è€Œé”™ç»¼å¤æ‚ï¼Œå»ºè®®å¯ä»¥å°è¯•ä½¿ç”¨å­çº¿ç¨‹çš„é˜»å¡æ–¹å¼æ¥å°½å¯èƒ½åœ°ä¿è¯ä»£ç çš„çº¿æ€§æ‰§è¡Œã€‚ä¾‹å¦‚åœ¨å­çº¿ç¨‹é˜»å¡ç­‰å¾… CaptureResultï¼Œç„¶åç»§ç»­æ‰§è¡Œåç»­çš„æ“ä½œï¼Œè€Œä¸æ˜¯å°†ä»£ç æ‹†åˆ†åˆ°åˆ° CaptureCallback.onCaptureCompleted() æ–¹æ³•é‡Œ

7. å¯ä»¥è®¤ä¸º Camera1 æ˜¯ Camera2 çš„ä¸€ä¸ªå­é›†ï¼Œä¹Ÿå°±æ˜¯è¯´ Camera1 èƒ½åšçš„äº‹æƒ… Camera2 ä¸€å®šèƒ½åš

**ä¸€äº›å…¶å®ƒåœ°æ–¹åˆ«äººçš„æ€»ç»“ï¼š**

1. å¦‚æœåº”ç”¨ç¨‹åºéœ€è¦åŒæ—¶å…¼å®¹ Camera1 å’Œ Camera2ï¼Œå»ºè®®åˆ†å¼€ç»´æŠ¤ï¼Œå› ä¸º Camera1 è¹©è„šçš„ API è®¾è®¡å¾ˆå¯èƒ½è®© Camera2 çµæ´»çš„ API æ— æ³•å¾—åˆ°å……åˆ†çš„å‘æŒ¥ï¼Œå¦å¤–å°†ä¸¤ä¸ªè®¾è®¡ä¸Šå®Œå…¨ä¸å…¼å®¹çš„ä¸œè¥¿æ…å’Œåœ¨ä¸€èµ·å¸¦æ¥çš„ç—›è‹¦å¯èƒ½è¿œå¤§äºå…¶å¸¦æ¥ä¾¿åˆ©æ€§ï¼Œå¤šå†™ä¸€äº›å†—ä½™çš„ä»£ç ä¹Ÿè®¸è¿˜æ›´å¼€å¿ƒ

2. å®˜æ–¹è¯´ Camera2 çš„æ€§èƒ½ä¼šæ›´å¥½ï¼Œä½†èµ·ç åœ¨è¾ƒæ—©æœŸçš„ä¸€äº›æœºå™¨ä¸Šè¿è¡Œ Camera2 çš„æ€§èƒ½å¹¶æ²¡æœ‰æ¯” Camera1 å¥½

3. å½“è®¾å¤‡çš„ Supported Hardware Level ä½äº FULL çš„æ—¶å€™ï¼Œå»ºè®®è¿˜æ˜¯ä½¿ç”¨ Camera1ï¼Œå› ä¸º FULL çº§åˆ«ä»¥ä¸‹çš„ Camera2 èƒ½æä¾›çš„åŠŸèƒ½å‡ ä¹å’Œ Camera1 ä¸€æ ·ï¼Œæ‰€ä»¥å€’ä¸å¦‚é€‰æ‹©æ›´åŠ ç¨³å®šçš„ Camera1

***

### å‚è€ƒä¸é¸£è°¢

> <https://www.jianshu.com/p/9a2e66916fcb>
