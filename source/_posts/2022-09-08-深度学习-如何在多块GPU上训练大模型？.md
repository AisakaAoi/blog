---
title: æ·±åº¦å­¦ä¹ -å¦‚ä½•åœ¨å¤šå—GPUä¸Šè®­ç»ƒå¤§æ¨¡å‹ï¼Ÿ
categories:
  - ğŸŒ™è¿›é˜¶å­¦ä¹ 
  - â­äººå·¥æ™ºèƒ½ Artificial Intelligence
  - ğŸ’«å‰æ²¿æ”¹è¿› Frontier Improvement
abbrlink: 1833c598
date: 2022-09-08 15:49:47
tags:
---

ä»Šå¤©æ¥çœ‹ä¸€ç¯‡å·¥ç¨‹ä¼˜åŒ–æ–‡ç« ï¼Œå…³äºå¦‚ä½•åœ¨å¤šå—GPUä¸Šè®­ç»ƒå¤§æ¨¡å‹ï¼Œä½œè€…Lilian Wengç°ä¸ºOpenAIåº”ç”¨äººå·¥æ™ºèƒ½ç ”ç©¶è´Ÿè´£äººï¼Œä¸»è¦ä»äº‹æœºå™¨å­¦ä¹ ã€æ·±åº¦å­¦ä¹ å’Œç½‘ç»œç§‘å­¦ç ”ç©¶ã€‚

åŸæ–‡é“¾æ¥ï¼š[How to Train Really Large Models on Many GPUs?](https://lilianweng.github.io/posts/2021-09-25-train-large/)

<!--more-->

***

### Training Parallelism

#### Data Parallelism

DPæœ€æœ´ç´ çš„æ–¹æ³•æ˜¯å¤åˆ¶ç›¸åŒçš„æ¨¡å‹æƒé‡å‚æ•°åˆ°å¤šä¸ªworkersä¸Šï¼Œç»™æ¯ä¸ªworkerä¸€éƒ¨åˆ†æ•°æ®æ¥åŒæ—¶å¤„ç†ã€‚
å¦‚æœæ¨¡å‹sizeå¤§äºå•ä¸ªGPUèŠ‚ç‚¹å†…å­˜æ—¶ï¼Œè¿™ç§æ–¹æ³•æ˜¯ä¸èƒ½workçš„ã€‚GeePS (Cui et al. 2016) æå‡ºäº†å°†æš‚æ—¶ä¸ç”¨çš„æ¨¡å‹å‚æ•°å¸è½½å›CPUä¸Šã€‚è¿™ç§æ•°æ®äº¤æ¢ä¼ è¾“é€šå¸¸åœ¨åç«¯è¿›è¡Œï¼Œä¸ä¼šå¹²æ‰°è®­ç»ƒã€‚

åœ¨æ¯ä¸ªminibatchç»“æŸåï¼Œworkerséœ€è¦åŒæ­¥æ¢¯åº¦æˆ–å‚æ•°ï¼Œä»¥ä¿è¯å­¦ä¹ æ•ˆç‡ï¼Œæœ‰ä¸¤ç§ä¸»æµçš„åŒæ­¥æ–¹æ³•ï¼ŒåŒ…æ‹¬å®ƒä»¬çš„ä¼˜ç¼ºç‚¹ï¼š

1. **æ‰¹é‡åŒæ­¥å¹¶è¡Œ Bulk synchronous parallels (BSP)**: workeråœ¨æ¯ä¸ªMini-batchç»“æŸæ—¶åŒæ­¥æ•°æ®ï¼Œè¿™ç§æ–¹æ³•ä¿è¯äº†æ¨¡å‹æƒé‡ä¼ é€’çš„åŠæ—¶æ€§ï¼Œä½†æ¯å°æœºå™¨éƒ½å¿…é¡»æ’é˜Ÿç­‰å¾…å…¶ä»–æœºå™¨å‘é€æ¢¯åº¦ã€‚
2. **å¼‚æ­¥å¹¶è¡Œ Asynchronous parallel (ASP)**: æ¯ä¸ªGPUé‡‡ç”¨å¼‚æ­¥æ–¹å¼å¤„ç†æ•°æ®ï¼Œè¿™ç§æ–¹æ³•é¿å…äº†ä¸åŒæœºå™¨ä¹‹é—´çš„ç›¸äº’ç­‰å¾…æˆ–æš‚åœï¼Œä½†å½±å“äº†æƒé‡ä¼ é€’çš„æ—¶æ•ˆï¼Œé™ä½äº†ç»Ÿè®¡å­¦ä¹ æ•ˆç‡ã€‚è€Œä¸”å³ä½¿å¢åŠ è®¡ç®—æ—¶é•¿ï¼Œä¹Ÿä¸ä¼šåŠ å¿«è®­ç»ƒçš„æ”¶æ•›é€Ÿåº¦ã€‚
åœ¨æ¯ä¸€æ¬¡è¿­ä»£ï¼ˆx ï¼1ï¼‰çš„ä¸­é—´æŸäº›åœ°æ–¹éƒ½éœ€è¦åŒæ­¥å…¨å±€æ¢¯åº¦ï¼Œè¯¥ç‰¹å¾åœ¨**åˆ†å¸ƒå¼æ•°æ®å¹¶è¡Œï¼ˆDistribution Data Parallelï¼ŒDDPï¼‰**ä¸­è¢«ç§°ä¸ºâ€œ**æ¢¯åº¦ç´¯ç§¯ï¼ˆgradient accumulationï¼‰**â€ã€‚**åˆ†æ¡¶æ¢¯åº¦(bucketing gradients)é¿å…ç«‹å³æ‰§è¡ŒAllReduceæ“ä½œï¼Œè€Œæ˜¯å°†å¤šä¸ªæ¢¯åº¦å­˜å‚¨åˆ°ä¸€ä¸ªAllReduceä¸­ä»¥æé«˜ååé‡ï¼Œå¹¶åŸºäºè®¡ç®—å›¾ä¼˜åŒ–è®¡ç®—å’Œé€šä¿¡è°ƒåº¦ã€‚**

{% asset_img 1.png %}

***

#### Model Parallelism

æ¨¡å‹å¹¶è¡Œï¼ˆModel parallelismï¼ŒMPï¼‰ç”¨äºè§£å†³æ¨¡å‹æƒé‡ä¸èƒ½æ”¾åœ¨å•ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œè®¡ç®—å’Œæ¨¡å‹å‚æ•°è¢«åˆ†ç‰‡åˆ°å¤šå°æœºå™¨è¿›è¡Œå¤„ç†ã€‚å’ŒDPä¸åŒçš„æ˜¯ï¼ŒDPä¸­æ¯ä¸ªworkeréƒ½æœ‰ä¸€ä¸ªæ¨¡å‹çš„å®Œæ•´å‰¯æœ¬ï¼Œè€ŒMPåªåœ¨ä¸€ä¸ªworkerä¸Šåˆ†é…éƒ¨åˆ†æ¨¡å‹å‚æ•°ï¼Œå› æ­¤å¯¹å†…å­˜å’Œè®¡ç®—çš„éœ€æ±‚è¦å°å¾ˆå¤šã€‚

æ·±åº¦ç¥ç»ç½‘ç»œé€šå¸¸åŒ…å«ä¸€ä¸ªå †å å±‚ï¼Œå¦‚æœé€å±‚æ‹†åˆ†å°†è¿ç»­çš„å°å±‚åˆ†é…åˆ°å·¥ä½œå±‚åˆ†åŒºï¼Œæ“ä½œèµ·æ¥å¹¶ä¸éš¾ï¼Œä½†é€šè¿‡å¤§é‡å…·æœ‰é¡ºåºä¾èµ–æ€§çš„Workersæ¥è¿è¡Œæ¯ä¸ªæ•°æ®batchä¼šèŠ±è´¹å¤§é‡çš„ç­‰å¾…æ—¶é—´ï¼Œè®¡ç®—èµ„æºçš„åˆ©ç”¨ç‡ä¹Ÿä¸¥é‡ä¸è¶³ã€‚

{% asset_img 2.png %}

***

#### Pipeline Parallelism

PPç»“åˆäº†MPå’ŒDPï¼Œæ¥å‡å°‘æ— æ•ˆçš„æ—¶é—´ã€‚ä¸»è¦çš„æ€è·¯æ˜¯ï¼šå°†minibatchåˆ†å‰²æˆå¤šä¸ªmicrobatchesï¼Œæ¯ä¸ªç›¸åŒstageçš„workeråŒæ—¶å¤„ç†ä¸€ä¸ªmicrobatchesã€‚æ³¨æ„ï¼Œæ¯ä¸ªmicrobatchåŒ…å«ä¸¤æ¬¡ä¼ é€’ï¼Œå‰åå’Œåå‘ã€‚å†…éƒ¨workeré€šä¿¡åªä¼ è¾“æ¿€æ´»ï¼ˆå‰å‘ï¼‰å’Œæ¢¯åº¦ï¼ˆåå‘ï¼‰ã€‚è¿™ç§ä¼ è¾“çš„è°ƒåº¦æ–¹å¼å’Œæ¢¯åº¦è¢«èšåˆçš„æ–¹å¼åœ¨ä¸åŒçš„æ–¹æ³•ä¸­åˆæœ‰åŒºåˆ«ã€‚workersçš„æ•°é‡ï¼Œä¹Ÿè¢«ç§°ä¸ºâ€œpipeline depthâ€ã€‚

åœ¨ GPipe (Huang et al. 2019) æ–¹æ³•ä¸­ï¼Œå¤šä¸ªå¾®æ‰¹æ¬¡å¤„ç†ç»“æŸæ—¶ä¼šåŒæ—¶èšåˆæ¢¯åº¦å’Œåº”ç”¨ã€‚åŒæ­¥æ¢¯åº¦ä¸‹é™ä¿è¯äº†å­¦ä¹ çš„ä¸€è‡´æ€§å’Œæ•ˆç‡ï¼Œä¸workeræ•°é‡æ— å…³ã€‚å¦‚å›¾3æ‰€ç¤ºï¼Œâ€œBubbleâ€ä»ç„¶å­˜åœ¨ï¼Œä½†æ¯”å›¾2å°‘äº†å¾ˆå¤šã€‚ç»™å®šmä¸ªå‡åŒ€åˆ†å‰²çš„å¾®æ‰¹æ¬¡å’Œdä¸ªåˆ†åŒºï¼Œå‡è®¾æ¯ä¸ªå¾®æ‰¹æ¬¡å‘å‰å’Œå‘åéƒ½éœ€è¦ä¸€ä¸ªæ—¶é—´å•ä½ï¼Œåˆ™Bubbleçš„å æ¯”ä¸ºï¼š

{% asset_img 3.png %}

GPipeè®ºæ–‡è¡¨æ˜ï¼Œå¦‚æœå¾®æ‰¹æ¬¡çš„æ•°é‡è¶…è¿‡åˆ†åŒºæ•°é‡4å€ï¼ˆm>4dï¼‰ï¼Œåˆ™â€œBubbleâ€å¼€é”€å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚

GPipeåœ¨ååé‡ä¸Šå¯ä»¥å–å¾—å’Œè®¾å¤‡æ•°é‡ç›¸è¿‘çš„çº¿æ€§åŠ é€Ÿï¼Œå°½ç®¡å®ƒå¹¶ä¸èƒ½æ€»æ˜¯ä¿è¯æ¨¡å‹å‚æ•°è¢«å‡åŒ€åœ°åˆ†å¸ƒåœ¨ä¸åŒçš„workeèŠ‚ç‚¹ä¸Šã€‚

{% asset_img 4.png %}

PipeDream (Narayanan et al. 2019)æ–¹æ³•è¦æ±‚æ¯ä¸ªworkeräº¤æ›¿å¤„ç†å‘å‰å’Œå‘åä¼ é€’çš„æ¶ˆæ¯ï¼ˆ1F1Bï¼‰ã€‚å®ƒå°†æ¯ä¸ªæ¨¡å‹åˆ†åŒºå‘½åä¸ºâ€œstageâ€ï¼Œæ¯ä¸ªstage workerå¯ä»¥æœ‰å¤šä¸ªå‰¯æœ¬æ¥å¹¶è¡Œè¿è¡Œæ•°æ®ã€‚è¿™ä¸ªè¿‡ç¨‹ä½¿ç”¨å¾ªç¯è´Ÿè½½å‡è¡¡ç­–ç•¥åœ¨å¤šä¸ªå‰¯æœ¬ä¹‹é—´åˆ†é…å·¥ä½œï¼Œä»¥ç¡®ä¿ç›¸åŒminibatch å‘å‰å’Œå‘åçš„ä¼ é€’å‘ç”Ÿåœ¨åŒä¸€å‰¯æœ¬ä¸Šã€‚

{% asset_img 5.png %}

ç”±äºPipeDreamæ²¡æœ‰åœ¨æ‰€æœ‰worker batchç»“æŸæ—¶åŒæ­¥å…¨å±€æ¢¯åº¦ï¼Œ1F1B å¾ˆå®¹æ˜“å¯¼è‡´å¾®æ‰¹æ¬¡å‘å‰å’Œå‘åä¼ é€’ä¸­ä½¿ç”¨äº†ä¸åŒçš„æƒé‡ï¼Œé™ä½å­¦ä¹ æ•ˆç‡ã€‚å¯¹æ­¤ï¼ŒPipeDreamæä¾›äº†ä¸€äº›è§£å†³çš„æ€è·¯ï¼š

**ç¼“å­˜æƒé‡ã€Weight stashingã€‘**ï¼šæ¯ä¸ªworkerè·Ÿè¸ªå¤šä¸ªæ¨¡å‹ç‰ˆæœ¬ï¼Œç»™å®šæ•°æ® batch çš„å‘å‰å’Œå‘åä¼ é€’ç›¸åŒç‰ˆæœ¬çš„æƒé‡ã€‚

**å‚ç›´åŒæ­¥ã€Vertical syncã€‘**ï¼šä¸åŒæ¨¡å‹æƒé‡ç‰ˆæœ¬ä¸æ¿€æ´»å’Œæ¢¯åº¦ä¸€èµ·åœ¨å…¨å±€workerä¹‹é—´ä¼ é€’ï¼Œè®¡ç®—é‡‡ç”¨ä¸Šä¸€ä¸ªworkerä¼ æ’­çš„ç›¸å¯¹åº”çš„ç¼“å­˜ç‰ˆæœ¬ã€‚è¿™ä¸ªè¿‡ç¨‹ç¡®ä¿äº†workerä¹‹é—´çš„ç‰ˆæœ¬ä¸€è‡´æ€§ï¼ˆä¸åŒäºGPipeï¼Œé‡‡ç”¨å¼‚æ­¥è®¡ç®—ï¼‰ã€‚

åœ¨è®­ç»ƒå¼€å§‹æ—¶ï¼ŒPipeDreamä¼šå…ˆåˆ†ææ¨¡å‹æ¯ä¸€å±‚çš„è®¡ç®—å†…å­˜å’Œæ—¶é—´æˆæœ¬ï¼Œç„¶åå°†å±‚åˆ’åˆ†ä¸ºä¸åŒçš„stageè¿›è¡Œä¼˜åŒ–ï¼Œè¿™æ˜¯ä¸ªåŠ¨æ€è§„åˆ’é—®é¢˜ã€‚

{% asset_img 6.png %}

éšåï¼Œæœ‰ä¸¤ä¸ªPipeDreamçš„å˜ä½“è¢«æå‡ºæ¥ï¼Œä»¥èŠ‚çœç”±æ¨¡å‹ç¼“å­˜æ‰€å¸¦æ¥çš„å†…å­˜å ç”¨ã€‚

**PipeDream-flush**å¢åŠ äº†å®šæœŸåˆ·æ–°å…¨å±€åŒæ­¥ç®¡é“çš„åŠŸèƒ½ï¼Œå°±åƒGPipeä¸€æ ·ï¼Œè¿™ç§æ–¹å¼è™½ç„¶ç‰ºç‰²äº†ä¸€ç‚¹ååé‡ï¼Œä½†æ˜¾è‘—å‡å°‘äº†å†…å­˜å ç”¨ï¼ˆä»…éœ€è¦ç»´æŠ¤å•ä¸€ç‰ˆæœ¬çš„æ¨¡å‹æƒé‡ï¼‰ã€‚

{% asset_img 7.png %}

**PipeDream-2BW**ç»´æŠ¤äº†ä¸¤å¥—æ¨¡å‹æƒé‡å‚æ•°ã€‚â€œ2BWâ€ä»£è¡¨â€œåŒç¼“å†²æƒé‡ï¼ˆdouble-buffered weightsï¼‰â€ï¼Œå®ƒä¼šåœ¨æ¯ä¸ªå¾®æ‰¹æ¬¡ç”Ÿæˆä¸€ä¸ªæ–°çš„æ¨¡å‹ç‰ˆæœ¬Kï¼ˆK>dï¼‰ã€‚ç”±äºä¸€äº›å‰©ä½™çš„å‘åä¼ é€’ä»ç„¶ä¾èµ–äºæ—§ç‰ˆæœ¬ï¼Œæ–°çš„æ¨¡å‹ç‰ˆæœ¬æ— æ³•ç«‹å³å–ä»£æ—§ç‰ˆæœ¬ï¼Œä½†å› ä¸ºåªä¿å­˜äº†ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå†…å­˜å ç”¨çš„ä¹Ÿè¢«å¤§å¤§é™ä½äº†ã€‚

{% asset_img 8.png %}

***

#### Tensor Parallelism

æ¨¡å‹å¹¶è¡Œå’Œç®¡é“å¹¶è¡Œéƒ½ä¼šå‚ç›´æ‹†åˆ†æ¨¡å‹ï¼Œè€Œå¼ é‡å¹¶è¡Œï¼ˆTensor Parallelismï¼ŒTPï¼‰æ˜¯å°†å¼ é‡è¿ç®—çš„è®¡ç®—æ°´å¹³åˆ’åˆ†åˆ°å¤šä¸ªè®¾å¤‡ä¸Šã€‚

ä»¥Transformerä¸ºä¾‹ã€‚Transformeræ¶æ„ä¸»è¦ç”±å¤šå±‚MLPå’Œè‡ªæ³¨æ„åŠ›å—ç»„æˆã€‚Megatron-LMï¼ˆShoeybi et al.2020ï¼‰é‡‡ç”¨äº†ä¸€ç§ç®€å•çš„æ–¹æ³•æ¥å¹¶è¡Œè®¡ç®—å±‚å†…MLPå’Œè‡ªæ³¨æ„åŠ›ã€‚

MLPå±‚åŒ…å«GEMMï¼ˆé€šç”¨çŸ©é˜µä¹˜æ³•ï¼‰å’Œéçº¿æ€§GeLUä¼ è¾“ã€‚å¦‚æœæŒ‰åˆ—æ‹†åˆ†æƒé‡çŸ©é˜µAï¼Œå¯ä»¥å¾—åˆ°ï¼š

{% asset_img 9.png %}

æ³¨æ„åŠ›å—æ ¹æ®ä¸Šè¿°åˆ†åŒºå¹¶è¡Œè¿è¡ŒGEMMçš„ æŸ¥è¯¢ï¼ˆQï¼‰ã€é”®ï¼ˆKï¼‰å’Œ æƒé‡ï¼ˆVï¼‰ï¼Œç„¶åä¸å¦ä¸€ä¸ªGEMMç»„åˆä»¥ç”Ÿæˆå¤´æ³¨æ„åŠ›ç»“æœã€‚

{% asset_img 10.png %}

{% asset_img 11.png %}

Narayanan et al. (2021)æå‡ºå°†ç®¡é“ã€å¼ é‡å’Œæ•°æ®å¹¶è¡Œä¸æ–°çš„ç®¡é“è°ƒåº¦ç­–ç•¥ç›¸ç»“åˆï¼Œæå‡ºäº†ä¸€ç§åä¸ºPTD-Pçš„æ–°æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¸ä»…åœ¨è®¾å¤‡ä¸Šèƒ½å¤Ÿå®šä½ä¸€ç»„è¿ç»­çš„å±‚ï¼ˆâ€œæ¨¡å‹å—â€ï¼‰ï¼Œè¿˜å¯ä»¥ä¸ºæ¯ä¸ªwokersåˆ†é…å¤šä¸ªè¾ƒå°çš„è¿ç»­å±‚å­é›†å—ï¼ˆä¾‹å¦‚ï¼Œè®¾å¤‡1å…·æœ‰ç¬¬1ã€2ã€9ã€10å±‚ï¼›è®¾å¤‡2å…·æœ‰ç¬¬3ã€4ã€11ã€12å±‚ï¼›æ¯ä¸ªå…·æœ‰ä¸¤ä¸ªæ¨¡å‹å—ï¼‰

æ¯ä¸ªbatchä¸­ï¼Œå¾®æ‰¹æ¬¡çš„æ•°é‡åº”ç²¾ç¡®é™¤ä»¥wokersæ•°é‡ï¼ˆmï¼‰ã€‚å¦‚æœæ¯ä¸ªworkeræœ‰vä¸ªæ¨¡å‹å—ï¼Œé‚£ä¹ˆä¸GPipeè°ƒåº¦ç›¸æ¯”ï¼Œç®¡é“çš„â€œbubbleâ€æ—¶é—´å¯ä»¥å‡å°‘ v å€ã€‚

{% asset_img 12.png %}

***

### Mixture-of-Experts ï¼ˆMoEï¼‰

ä¸ºäº†çªç ´æ¨¡å‹å¤§å°çš„é™åˆ¶ï¼Œè°·æ­Œåæ¥æå‡ºä¸€ç§æ··åˆä¸“å®¶ï¼ˆMoEï¼‰æ–¹æ³•ï¼Œå…¶æ ¸å¿ƒç†å¿µæ˜¯ï¼šé›†æˆå­¦ä¹ ï¼Œå®ƒå‡è®¾é›†æˆå¤šä¸ªå¼±å­¦ä¹ å™¨å°±ä¼šæ‹¥æœ‰ä¸€ä¸ªå¼ºå­¦ä¹ å™¨ã€‚

åœ¨æ·±åº¦ç¥ç»ç½‘ç»œä¸­ï¼Œæ··åˆä¸“å®¶ï¼ˆMoEï¼‰é€šè¿‡è¿æ¥å¤šä¸ªä¸“å®¶çš„é—¨æœºåˆ¶ï¼ˆgating mechanismï¼‰å®ç°é›†æˆï¼ˆShazeerç­‰äººï¼Œ2017ï¼‰ã€‚é—¨æœºåˆ¶æ¿€æ´»ä¸åŒç½‘ç»œçš„ä¸“å®¶ä»¥äº§ç”Ÿä¸åŒçš„è¾“å‡ºã€‚ä½œè€…åœ¨è®ºæ–‡å°†å…¶å‘½åä¸ºâ€œç¨€ç–é—¨æ§ä¸“å®¶æ··åˆå±‚ï¼ˆsparsely gated MoEï¼‰â€ã€‚

ä»…ä¸€ä¸ªMoEå±‚åŒ…å«ï¼š
1. å‰é¦ˆç½‘ç»œä¸“å®¶nï¼›
2. å¯è®­ç»ƒçš„é—¨æ§ç½‘ç»œGï¼Œé€šè¿‡å­¦ä¹ nä¸ªä¸“å®¶çš„æ¦‚ç‡åˆ†å¸ƒï¼Œå°†æµé‡è·¯ç”±åˆ°å‡ ä¸ªç‰¹å®šçš„ä¸“å®¶ã€‚

æ ¹æ®é—¨æ§è¾“å‡ºï¼Œå¹¶éæ¯ä¸ªä¸“å®¶éƒ½å¿…é¡»è¿›è¡Œè¯„ä¼°ã€‚å½“ä¸“å®¶çš„æ•°é‡å¤ªå¤§æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸¤å±‚MoEã€‚

{% asset_img 13.png %}

Gå°†è¾“å…¥ä¸å¯è®­ç»ƒæƒé‡çŸ©é˜µGgç›¸ä¹˜ï¼Œç„¶åæ‰§è¡Œsoftmaxï¼š

{% asset_img 14.png %}

ç”±äºè¿™ä¸ªè¿‡ç¨‹ä¼šäº§ç”Ÿå¯†é›†çš„é—¨æ§åˆ¶å‘é‡ï¼Œä¸åˆ©äºèŠ‚çœè®¡ç®—èµ„æºï¼Œè€Œä¸”

{% asset_img 15.png %}

æ—¶ä¹Ÿä¸éœ€è¦è¯„ä¼°ä¸“å®¶ã€‚æ‰€ä»¥ï¼ŒMoEå±‚ä»…ä¿ç•™äº†é¡¶éƒ¨kå€¼ï¼Œå¹¶é€šè¿‡å‘Gä¸­æ·»åŠ é«˜æ–¯å™ªå£°æ”¹è¿›è´Ÿè½½å¹³è¡¡ï¼Œè¿™ç§æœºåˆ¶è¢«ç§°ä¸ºå™ªå£°top-ké—¨ã€‚

{% asset_img 16.png %}

ä¸ºäº†é¿å…é—¨æ§ç½‘ç»œå¯èƒ½å§‹ç»ˆåå‘å°‘æ•°å¼ºåŠ¿ä¸“å®¶çš„è‡ªæˆ‘å¼ºåŒ–æ•ˆåº”ï¼ŒShazeerç­‰äººï¼ˆ2017ï¼‰æå‡ºäº†é€šè¿‡é¢å¤–é‡è¦æŸå¤±çš„è½¯çº¦æŸï¼Œä»¥é¼“åŠ±æ‰€æœ‰ä¸“å®¶æ‹¥æœ‰ç›¸åŒçš„æƒé‡ã€‚å…¶æ•°å€¼ç›¸å½“äºæ¯ä¸ªä¸“å®¶çš„åˆ†æ‰¹å¹³å‡å€¼å˜å¼‚ç³»æ•°çš„å¹³æ–¹ï¼š

{% asset_img 17.png %}

å…¶ä¸­ï¼ŒCVæ˜¯å˜å¼‚ç³»æ•°ï¼Œå¤±é‡çš„w_auxâ€‹æ˜¯å¯è°ƒèŠ‚çš„è¶…å‚æ•°ã€‚ç”±äºæ¯ä¸ªä¸“å®¶ç½‘ç»œåªèƒ½è·å¾—å°éƒ¨åˆ†è®­ç»ƒæ ·æœ¬ï¼ˆâ€œæ”¶ç¼©æ‰¹æ¬¡é—®é¢˜â€ï¼‰ï¼Œæ‰€ä»¥åœ¨MoEä¸­åº”è¯¥å°½å¯èƒ½ä½¿ç”¨å¤§batchï¼Œä½†è¿™åˆä¼šå—åˆ°GPUå†…å­˜çš„é™åˆ¶ã€‚æ•°æ®å¹¶è¡Œå’Œæ¨¡å‹å¹¶è¡Œçš„åº”ç”¨å¯ä»¥æé«˜æ¨¡å‹çš„ååé‡ã€‚

{% asset_img 18.png %}

***

### Other Memory Saving Designs

#### CPU Offloading

å¦‚æœGPUå†…å­˜å·²æ»¡ï¼Œå¯ä»¥å°†æš‚æ—¶æœªä½¿ç”¨çš„æ•°æ®å¸è½½åˆ°CPUï¼Œå¹¶åœ¨ä»¥åéœ€è¦æ—¶å°†å…¶è¯»å›ï¼ˆRhuç­‰äººï¼Œ2016ï¼‰ã€‚ä¸è¿‡ï¼Œè¿™ç§æ–¹æ³•è¿‘å¹´æ¥å¹¶ä¸å¤ªæµè¡Œï¼Œå› ä¸ºå®ƒä¼šå»¶é•¿æ¨¡å‹è®­ç»ƒçš„æ—¶é—´ã€‚

***

#### Actiavation Recomputation

æ¿€æ´»é‡æ–°è®¡ç®—ï¼Œä¹Ÿç§°â€œæ¿€æ´»æ£€æŸ¥ç‚¹â€æˆ–â€œæ¢¯åº¦æ£€æŸ¥ç‚¹â€ï¼ˆChen et alï¼Œ2016ï¼‰ï¼Œå…¶æ ¸å¿ƒæ€è·¯æ˜¯ç‰ºç‰²è®¡ç®—æ—¶é—´æ¥æ¢å–å†…å­˜ç©ºé—´ã€‚å®ƒå‡å°‘äº†è®­ç»ƒ â„“ å±‚æ·±å±‚ç¥ç»ç½‘ç»œåˆ° O(sqrt(â„“)) çš„å†…å­˜å¼€é”€ï¼Œæ¯ä¸ªbatchåªæ¶ˆè€—é¢å¤–çš„å‰å‘ä¼ é€’è®¡ç®—ã€‚

å…·ä½“æ¥è¯´ï¼Œè¯¥æ–¹æ³•å°†å±‚ç½‘ç»œå¹³å‡åˆ’åˆ†ä¸ºdä¸ªåˆ†åŒºï¼Œä»…ä¿å­˜åˆ†åŒºè¾¹ç•Œçš„æ¿€æ´»ï¼Œå¹¶åœ¨workersä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚è®¡ç®—æ¢¯åº¦ä»ç„¶éœ€è¦åœ¨åˆ†åŒºå†…å±‚è¿›è¡Œä¸­é—´æ¿€æ´»ï¼Œä»¥ä¾¿åœ¨å‘åè¿‡ç¨‹ä¸­é‡æ–°è®¡ç®—æ¢¯åº¦ã€‚åœ¨æ¿€æ´»é‡æ–°è®¡ç®—çš„æƒ…å†µä¸‹ï¼Œç”¨äºè®­ç»ƒ M(l) æ˜¯ï¼š

{% asset_img 19.png %}

å®ƒçš„æœ€ä½æˆæœ¬æ˜¯ï¼šO(sqrt(â„“))å½“d=sqrt(â„“)æ—¶ã€‚

æ¿€æ´»é‡æ–°è®¡ç®—çš„æ–¹æ³•å¯ä»¥å¾—å‡ºä¸æ¨¡å‹å¤§å°æœ‰å…³æ¬¡çº¿æ€§å†…å­˜å¼€é”€ï¼Œå¦‚ä¸‹å›¾ï¼š

{% asset_img 20.png %}

***

#### Mixed Precision Training

Narang & Micikevicius et al. (2018)ä»‹ç»äº†ä¸€ç§ä½¿ç”¨åŠç²¾åº¦æµ®ç‚¹ï¼ˆFP16ï¼‰æ•°è®­ç»ƒæ¨¡å‹è€Œä¸æŸå¤±æ¨¡å‹ç²¾åº¦çš„æ–¹æ³•ã€‚

{% asset_img 21.png %}

å…¶ä¸­æ¶‰åŠä¸‰ç§å…³é”®æŠ€æœ¯ï¼š
- **å…¨ç²¾åº¦æƒé‡å¤åˆ¶ï¼š**ä¿æŒç´¯ç§¯æ¢¯åº¦çš„æ¨¡å‹æƒé‡çš„å…¨ç²¾åº¦ï¼ˆFP32ï¼‰å¤åˆ¶ã€‚å¯¹äºå‘å‰å’Œå‘åçš„ä¼ é€’çš„ä¿¡æ¯åšå››èˆäº”å…¥è‡³åŠç²¾åº¦å¤„ç†ï¼Œå› ä¸ºæ¯æ¬¡æ¢¯åº¦æ›´æ–°ï¼ˆå³æ¢¯åº¦Xå­¦ä¹ ç‡ï¼‰å¤ªå°ï¼Œå¯èƒ½æ— æ³•å®Œå…¨åŒ…å«åœ¨FP16èŒƒå›´å†…ã€‚
- **ç¼©æ”¾æŸå¤±ï¼š**æ”¾å¤§æŸå¤±ä»¥æ›´å¥½åœ°å¤„ç†å°å¹…åº¦çš„æ¢¯åº¦ï¼ˆè§å›¾16ï¼‰ï¼Œæ”¾å¤§æ¢¯åº¦ä»¥ä½¿å…¶å‘å¯è¡¨ç¤ºèŒƒå›´çš„å³ä¾§éƒ¨åˆ†ï¼ˆåŒ…å«è¾ƒå¤§çš„å€¼ï¼‰ç§»åŠ¨ï¼Œä»è€Œä¿ç•™å¯èƒ½ä¸¢å¤±çš„å€¼ã€‚
- **ç®—æœ¯ç²¾åº¦ï¼š**å¯¹äºå¸¸è§çš„ç½‘ç»œç®—æ³•ï¼ˆå¦‚çŸ¢é‡ç‚¹ç§¯ã€çŸ¢é‡å…ƒç´ æ±‚å’Œå½’çº¦ï¼‰ï¼Œå°†éƒ¨åˆ†ç»“æœç´¯åŠ åˆ°FP32ä¸­ï¼Œç„¶åè¾“å‡ºä¿å­˜ä¸ºFP16ã€‚é€ç‚¹æ“ä½œå¯ä»¥åœ¨FP16æˆ–FP32ä¸­æ‰§è¡Œã€‚

{% asset_img 22.png %}

åœ¨è¿™é¡¹å®éªŒä¸­ï¼Œå›¾åƒåˆ†ç±»ã€æ›´å¿«çš„R-CNNç­‰ä¸éœ€è¦æŸå¤±ç¼©æ”¾ï¼Œä½†å…¶ä»–ç½‘ç»œï¼Œå¦‚å¤šç›’SSDã€å¤§LSTMè¯­è¨€æ¨¡å‹æ˜¯éœ€è¦æŸå¤±ç¼©æ”¾çš„ã€‚

***

#### Compression

æ¨¡å‹æƒé‡åœ¨å‘å‰å’Œå‘åä¼ é€’çš„è¿‡ç¨‹ä¸­ä¼šæ¶ˆè€—å¤§é‡å†…å­˜ã€‚è€ƒè™‘åˆ°è¿™ä¸¤ç§ä¼ é€’æ–¹å¼ä¼šèŠ±è´¹å¤§é‡æ—¶é—´ï¼ŒJainï¼ˆJain et alï¼Œ2018ï¼‰æå‡ºäº†ä¸€ç§æ•°æ®ç¼–ç ç­–ç•¥ï¼Œå³åœ¨ç¬¬ä¸€æ¬¡ä¼ é€’åå‹ç¼©ä¸­é—´ç»“æœï¼Œç„¶åå°†å…¶è§£ç ç”¨äºåå‘ä¼ æ’­ã€‚

Jainå’Œå›¢é˜Ÿç ”å‘çš„Gistç³»ç»ŸåŒ…å«ä¸¤ç§ç¼–ç æ–¹æ¡ˆï¼šä¸€æ˜¯ç‰¹å®šäºå±‚çš„æ— æŸç¼–ç ï¼ŒåŒ…æ‹¬ ReLU-Poolå’Œ ReLU-Convæ¨¡å¼ï¼›äºŒæ˜¯æœ‰æ”»å‡»æ€§çš„æœ‰æŸç¼–ç ï¼Œä¸»è¦ä½¿ç”¨å»¶è¿Ÿç²¾åº¦ç¼©å‡ï¼ˆDPRï¼‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨ç‰¹å¾å›¾æ—¶åº”ä¿æŒé«˜ç²¾åº¦ï¼Œç¬¬äºŒæ¬¡ä½¿ç”¨æ—¶è¦é€‚åº¦é™ä½ç²¾åº¦ã€‚è¿™é¡¹å®éªŒè¡¨æ˜ï¼ŒGistå¯ä»¥åœ¨5ä¸ªæœ€ä½³å›¾åƒåˆ†ç±»DNNä¸Šå‡å°‘2å€çš„å†…å­˜å¼€é”€ï¼Œå¹³å‡å‡å°‘1.8å€ï¼Œæ€§èƒ½å¼€é”€ä»…ä¸º4%ã€‚

***

#### Memory Efficient Optimizer

ä¼˜åŒ–å™¨ä¹Ÿä¼šæ¶ˆè€—å†…å­˜ã€‚ä»¥ä¸»æµçš„Adamä¼˜åŒ–å™¨ä¸ºä¾‹ï¼Œå…¶å†…éƒ¨éœ€è¦ç»´æŠ¤åŠ¨é‡å’Œæ–¹å·®ï¼Œè¿™ä¸¤è€…ä¸æ¢¯åº¦å’Œæ¨¡å‹å‚æ•°æ¯”ä¾‹åŸºæœ¬ç›¸åŒã€‚è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬éœ€è¦èŠ‚çœ4å€æ¨¡å‹æƒé‡çš„å†…å­˜ã€‚

ä¸ºäº†å‡å°‘å†…å­˜æ¶ˆè€—ï¼Œå­¦æœ¯ç•Œå·²ç»æå‡ºäº†å‡ æ¬¾ä¸»æµä¼˜åŒ–å™¨ã€‚ä¸Adamç›¸æ¯”ï¼ŒAdafactorï¼ˆShazeer et al.2018ï¼‰ä¼˜åŒ–å™¨æ²¡æœ‰å­˜å‚¨å…¨éƒ¨åŠ¨é‡å’Œå˜åŒ–ï¼Œåªè·Ÿè¸ªç§»åŠ¨å¹³å‡æ•°çš„æ¯è¡Œå’Œæ¯åˆ—æ€»å’Œï¼Œç„¶åæ ¹æ®è¿™äº›æ€»å’Œä¼°è®¡äºŒé˜¶çŸ©ã€‚

SM3ï¼ˆAnil et al.2019ï¼‰ä¼˜åŒ–å™¨é‡‡ç”¨äº†ä¸€ç§ä¸åŒçš„è‡ªé€‚åº”ä¼˜åŒ–æ–¹æ³•ã€‚

ZeROï¼ˆRajbhandari et al.2019ï¼‰é›¶å†—ä½™ä¼˜åŒ–å™¨èŠ‚çœäº†å¤§å‹æ¨¡å‹è®­ç»ƒåœ¨ä¸¤æ–¹é¢çš„å†…å­˜æ¶ˆè€—ï¼š
1. å¤§å¤šæ•°å†…å­˜ç”±æ¨¡å‹çŠ¶æ€æ¶ˆè€—ï¼ŒåŒ…æ‹¬ä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆä¾‹å¦‚AdamåŠ¨é‡å’Œæ–¹å·®ï¼‰ã€æ¢¯åº¦å’Œå‚æ•°ã€‚æ··åˆç²¾åº¦è®­ç»ƒä¹Ÿéœ€è¦å¤§é‡å†…å­˜ï¼Œå› ä¸ºé™¤äº†FP16ç‰ˆæœ¬ä¹‹å¤–ï¼Œä¼˜åŒ–å™¨è¿˜éœ€è¦ä¿å­˜FP32å‚æ•°å’Œå…¶ä»–ä¼˜åŒ–å™¨çŠ¶æ€çš„å‰¯æœ¬ã€‚
2. å‰©ä½™éƒ¨åˆ†è¢«æ¿€æ´»ã€ä¸´æ—¶ç¼“å†²åŒºä»¥åŠä¸å¯ç”¨çš„ç¢ç‰‡å†…å­˜æ¶ˆè€—ã€‚

ZeROç»“åˆäº†ZeRO-DPå’ŒZeRO-Rä¸¤ç§æ–¹æ³•ã€‚ZeRO-DPæ˜¯ä¸€ç§å¢å¼ºçš„æ•°æ®å¹¶è¡Œï¼Œé¿å…äº†æ¨¡å‹çŠ¶æ€çš„ç®€å•å†—ä½™ã€‚å®ƒä»¥åŠ¨æ€çš„æ–¹å¼è·¨å¤šä¸ªå¹¶è¡Œæ•°æ®åˆ’åˆ†ä¼˜åŒ–å™¨çŠ¶æ€ã€æ¢¯åº¦å’Œå‚æ•°ï¼Œä»¥æœ€å°åŒ–é€šä¿¡é‡ã€‚ZeRO-Rä½¿ç”¨åˆ†åŒºæ¿€æ´»äºŒæ¬¡è®¡ç®—ã€æ’å®šç¼“å†²åŒºå¤§å°å’ŒåŠ¨æ€å†…å­˜ç¢ç‰‡ï¼Œä»¥ä¼˜åŒ–å‰©ä½™çŠ¶æ€çš„å†…å­˜æ¶ˆè€—ã€‚

***

### å‚è€ƒèµ„æ–™

> <https://blog.csdn.net/qq_32275289/article/details/124377578>
> <https://lilianweng.github.io/posts/2021-09-25-train-large/>
