---
title: Android-éŸ³è§†é¢‘-è§†é¢‘å¼€å‘-ï¼ˆäº”ï¼‰è§†é¢‘å¤„ç†
categories:
  - ğŸŒ™åŸºç¡€å­¦ä¹ 
  - â­Android
abbrlink: 44c52947
date: 2021-10-27 14:31:16
tags:
---

### ç®€ä»‹

ä¸€èˆ¬æ¥è¯´è§†é¢‘å¤„ç†æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯è½¯ç¼–è§£ç ï¼ˆè½¯è§£ï¼ŒFFmpegï¼‰ï¼Œä¸€ç§æ˜¯ç¡¬ç¼–è§£ç ï¼ˆç¡¬è§£ï¼ŒMediaCodecï¼‰ã€‚

ä¸¤è€…çš„ä¼˜ç¼ºç‚¹å¦‚ä¸‹ï¼š

|  | FFmpeg | MediaCodec |
| - | - | - |
| ä¼˜ç‚¹ | ï¼ˆ1ï¼‰å°è£…äº†å¾ˆå¤šçš„æ ¼å¼ï¼Œä½¿ç”¨èµ·æ¥æ¯”è¾ƒçµæ´»ã€ç®€å•ã€å…¼å®¹æ€§å¥½ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼›ï¼ˆ2ï¼‰å‘½ä»¤è¡Œçš„æ–¹å¼å¾ˆæ–¹ä¾¿ï¼Œæ¯”å¦‚è§†é¢‘è£å‰ªçš„æ­¥éª¤ï¼šffmpeg -ss 10 -t 20 -i INPUT -acodec copy -vcodec copy OUTPUTï¼Œç›¸å¯¹æ¥è¯´å†™ä¸ªå‡½æ•°å»å®ç°å°±å¤ªéº»çƒ¦ã€‚ | åŠŸè€—ä½ï¼Œé€Ÿåº¦å¿« |
| ç¼ºç‚¹ | è½¯ç¼–è§£ç åŠŸè€—å¤§ | æ‰©å±•æ€§ä¸å¼ºï¼Œä¸åŒèŠ¯ç‰‡å‚å•†æä¾›çš„æ”¯æŒæ–¹æ¡ˆä¸åŒï¼Œå¯¼è‡´ç¨‹åºç§»æ¤æ€§å·® |

***

<!--more-->

### è½¯ç¼–è§£ç 

#### FFmpegåº“çš„å¼•å…¥

å¼•å…¥åº“çš„æ–¹å¼æœ‰ä¸¤ç§ï¼šaaræˆ–è€…æºç ä¾èµ–

aarä¾èµ–

``` java
dependencies {
    compile 'com.writingminds:FFmpegAndroid:0.3.2'
}
```

æºç ä¾èµ–

``` java
// ç”¨gitå°†ffmpeg-android-java cloneåˆ°æœ¬åœ°ï¼Œç„¶åæŠŠé¡¹ç›®ä¸­FFmpegAndroidåº“çš„æºç åŠ å…¥åˆ°é¡¹ç›®ä¸appåŒçº§çš„ç›®å½•ä¸­ã€‚
// https://github.com/WritingMinds/ffmpeg-android-java
```

#### åº“çš„åˆå§‹åŒ–

åˆå§‹åŒ–çš„ç›®çš„æ˜¯æ ¹æ®Androidæ‰‹æœºçš„cpuæ¶æ„ï¼Œloadå¯¹åº”æ¶æ„çš„ffmpegåº“ã€‚

``` java
public class ZApplication extends Application {
    @Override
    public void onCreate() {
        super.onCreate();
        initFFmpegBinary(this);
    }
 
    private void initFFmpegBinary(Context context) {
        try {
            FFmpeg.getInstance(context).loadBinary(new LoadBinaryResponseHandler() {
                @Override
                public void onFailure() {
                }
            });
        } catch (FFmpegNotSupportedException e) {
            e.printStackTrace();
        }
    }
}
```

#### æ‰§è¡Œffmpegçš„commendå‘½ä»¤

è¿™ä¸ªåº“æ˜¯å¯¹ffmpegçš„åœ¨Linuxç³»ç»Ÿä¸­å‘½ä»¤è¡Œçš„ä¸€ä¸ªå°è£…ï¼Œåœ¨FFmpegInterface.javaç±»ä¸­æ‰¾åˆ°äº†å¦‚ä¸‹çš„APIï¼š

``` java
/**
 * Executes a command
 * @param environvenmentVars Environment variables
 * @param cmd command to execute
 * @param ffmpegExecuteResponseHandler {@link FFmpegExecuteResponseHandler}
 * @throws FFmpegCommandAlreadyRunningException
 */
public void execute(Map<String, String> environvenmentVars, String[] cmd, FFmpegExecuteResponseHandler ffmpegExecuteResponseHandler) throws FFmpegCommandAlreadyRunningException;
 
/**
 * Executes a command
 * @param cmd command to execute
 * @param ffmpegExecuteResponseHandler {@link FFmpegExecuteResponseHandler}
 * @throws FFmpegCommandAlreadyRunningException
 */
public void execute(String[] cmd, FFmpegExecuteResponseHandler ffmpegExecuteResponseHandler) throws FFmpegCommandAlreadyRunningException;
```

#### è§†é¢‘è£å‰ª

è§†é¢‘è£å‰ªï¼šffmpeg -ss START -t DURATION -i INPUT -vcodec copy -acodec copy OUTPUT

#### è§†é¢‘åˆå¹¶

æ–¹æ³•ä¸€ï¼šFFmpeg concat åè®®

``` java
å¯¹äº MPEG æ ¼å¼çš„è§†é¢‘ï¼Œå¯ä»¥ç›´æ¥è¿æ¥ï¼š
ffmpeg -i "concat:input1.mpg|input2.mpg|input3.mpg" -c copy output.mpg
 
å¯¹äºé MPEG æ ¼å¼å®¹å™¨ï¼Œä½†æ˜¯æ˜¯ MPEG ç¼–ç å™¨ï¼ˆH.264ã€DivXã€XviDã€MPEG4ã€MPEG2ã€AACã€MP2ã€MP3 ç­‰ï¼‰ï¼Œå¯ä»¥åŒ…è£…è¿› TS æ ¼å¼çš„å®¹å™¨å†åˆå¹¶ã€‚åœ¨æ–°æµªè§†é¢‘ï¼Œæœ‰å¾ˆå¤šè§†é¢‘ä½¿ç”¨ H.264 ç¼–ç å™¨ï¼Œå¯ä»¥é‡‡ç”¨è¿™ä¸ªæ–¹æ³•
ffmpeg -i input1.flv -c copy -bsf:v h264_mp4toannexb -f mpegts input1.ts
ffmpeg -i input2.flv -c copy -bsf:v h264_mp4toannexb -f mpegts input2.ts
ffmpeg -i input3.flv -c copy -bsf:v h264_mp4toannexb -f mpegts input3.ts
ffmpeg -i "concat:input1.ts|input2.ts|input3.ts" -c copy -bsf:a aac_adtstoasc -movflags +faststart output.mp4
ä¿å­˜ QuickTime/MP4 æ ¼å¼å®¹å™¨çš„æ—¶å€™ï¼Œå»ºè®®åŠ ä¸Š -movflags +faststartã€‚è¿™æ ·åˆ†äº«æ–‡ä»¶ç»™åˆ«äººçš„æ—¶å€™å¯ä»¥è¾¹ä¸‹è¾¹çœ‹ã€‚
```

æ–¹æ³•äºŒï¼šFFmpeg concat åˆ†ç¦»å™¨

``` java
å…ˆåˆ›å»ºä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶filelist.txtï¼š
file 'input1.mkv'
file 'input2.mkv'
file 'input3.mkv'
 
ç„¶åï¼š
ffmpeg -f concat -i filelist.txt -c copy output.mkv
æ³¨æ„ï¼šä½¿ç”¨ FFmpeg concat åˆ†ç¦»å™¨æ—¶ï¼Œå¦‚æœæ–‡ä»¶åæœ‰å¥‡æ€ªçš„å­—ç¬¦ï¼Œè¦åœ¨ filelist.txt ä¸­è½¬ä¹‰ã€‚
```

æ–¹æ³•ä¸‰ï¼šMencoder è¿æ¥æ–‡ä»¶å¹¶é‡å»ºç´¢å¼•

``` java
å¯¹äºæ²¡æœ‰ä½¿ç”¨ MPEG ç¼–ç å™¨çš„è§†é¢‘ï¼ˆå¦‚ FLV1 ç¼–ç å™¨ï¼‰ï¼Œå¯ä»¥å°è¯•è¿™ç§æ–¹æ³•ã€‚
mencoder -forceidx -of lavf -oac copy -ovc copy -o output.flv input1.flv input2.flv input3.flv
```

æ–¹æ³•å››ï¼šä½¿ç”¨ FFmpeg concat è¿‡æ»¤å™¨é‡æ–°ç¼–ç ï¼ˆæœ‰æŸï¼‰

``` java
è¿™ä¸ªæ–¹æ³•å¯ä»¥åˆå¹¶ä¸åŒç¼–ç å™¨çš„è§†é¢‘ç‰‡æ®µï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå…¶ä»–æ–¹æ³•å¤±æ•ˆçš„åå¤‡æªæ–½ã€‚
ffmpeg -i input1.mp4 -i input2.webm -i input3.avi -filter_complex '[0:0] [0:1] [1:0] [1:1] [2:0] [2:1] concat=n=3:v=1:a=1 [v] [a]' -map '[v]' -map '[a]' <ç¼–ç å™¨é€‰é¡¹> output.mkv
å¦‚ä½ æ‰€è§ï¼Œä¸Šé¢çš„å‘½ä»¤åˆå¹¶äº†ä¸‰ç§ä¸åŒæ ¼å¼çš„æ–‡ä»¶ï¼ŒFFmpeg concat è¿‡æ»¤å™¨ä¼šé‡æ–°ç¼–ç å®ƒä»¬ã€‚æ³¨æ„è¿™æ˜¯æœ‰æŸå‹ç¼©ã€‚
[0:0] [0:1] [1:0] [1:1] [2:0] [2:1] åˆ†åˆ«è¡¨ç¤ºç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„è§†é¢‘ã€éŸ³é¢‘ã€ç¬¬äºŒä¸ªè¾“å…¥æ–‡ä»¶çš„è§†é¢‘ã€éŸ³é¢‘ã€ç¬¬ä¸‰ä¸ªè¾“å…¥æ–‡ä»¶çš„è§†é¢‘ã€éŸ³é¢‘ã€‚concat=n=3:v=1:a=1 è¡¨ç¤ºæœ‰ä¸‰ä¸ªè¾“å…¥æ–‡ä»¶ï¼Œè¾“å‡ºä¸€æ¡è§†é¢‘æµå’Œä¸€æ¡éŸ³é¢‘æµã€‚[v] [a] å°±æ˜¯å¾—åˆ°çš„è§†é¢‘æµå’ŒéŸ³é¢‘æµçš„åå­—ï¼Œæ³¨æ„åœ¨ bash ç­‰ shell ä¸­éœ€è¦ç”¨å¼•å·ï¼Œé˜²æ­¢é€šé…ç¬¦æ‰©å±•ã€‚
```

#### å…¶å®ƒå¸¸ç”¨å‘½ä»¤

FFmpegå¸¸ç”¨åŸºæœ¬å‘½ä»¤

``` java
1.åˆ†ç¦»è§†é¢‘éŸ³é¢‘æµ
ffmpeg -i input_file -vcodec copy -an output_file_videoã€€ã€€//åˆ†ç¦»è§†é¢‘æµ
ffmpeg -i input_file -acodec copy -vn output_file_audioã€€ã€€//åˆ†ç¦»éŸ³é¢‘æµ
 
2.è§†é¢‘è§£å¤ç”¨
ffmpeg â€“i test.mp4 â€“vcodec copy â€“an â€“f m4v test.264
ffmpeg â€“i test.avi â€“vcodec copy â€“an â€“f m4v test.264
 
3.è§†é¢‘è½¬ç 
ffmpeg â€“i test.mp4 â€“vcodec h264 â€“s 352*278 â€“an â€“f m4v test.264 //è½¬ç ä¸ºç æµåŸå§‹æ–‡ä»¶
ffmpeg â€“i test.mp4 â€“vcodec h264 â€“bf 0 â€“g 25 â€“s 352*278 â€“an â€“f m4v test.264 //è½¬ç ä¸ºç æµåŸå§‹æ–‡ä»¶
ffmpeg â€“i test.avi -vcodec mpeg4 â€“vtag xvid â€“qsame test_xvid.avi //è½¬ç ä¸ºå°è£…æ–‡ä»¶
//-bf Bå¸§æ•°ç›®æ§åˆ¶ï¼Œ-g å…³é”®å¸§é—´éš”æ§åˆ¶ï¼Œ-s åˆ†è¾¨ç‡æ§åˆ¶
 
4.è§†é¢‘å°è£…
ffmpeg â€“i video_file â€“i audio_file â€“vcodec copy â€“acodec copy output_file
 
5.è§†é¢‘å‰ªåˆ‡
ffmpeg â€“i test.avi â€“r 1 â€“f image2 image-%3d.jpeg //æå–å›¾ç‰‡
ffmpeg -ss 0:1:30 -t 0:0:20 -i input.avi -vcodec copy -acodec copy output.avi //å‰ªåˆ‡è§†é¢‘
//-r æå–å›¾åƒçš„é¢‘ç‡ï¼Œ-ss å¼€å§‹æ—¶é—´ï¼Œ-t æŒç»­æ—¶é—´
 
6.è§†é¢‘å½•åˆ¶
ffmpeg â€“i rtsp://192.168.3.205:5555/test â€“vcodec copy out.avi
 
7.YUVåºåˆ—æ’­æ”¾
ffplay -f rawvideo -video_size 1920x1080 input.yuv
 
8.YUVåºåˆ—è½¬AVI
ffmpeg â€“s w*h â€“pix_fmt yuv420p â€“i input.yuv â€“vcodec mpeg4 output.avi
 
 
ã€å¸¸ç”¨å‚æ•°è¯´æ˜ã€‘
ä¸»è¦å‚æ•°ï¼š
-i è®¾å®šè¾“å…¥æµ
-f è®¾å®šè¾“å‡ºæ ¼å¼
-ss å¼€å§‹æ—¶é—´
è§†é¢‘å‚æ•°ï¼š
-b è®¾å®šè§†é¢‘æµé‡ï¼Œé»˜è®¤ä¸º200Kbit/s
-r è®¾å®šå¸§é€Ÿç‡ï¼Œé»˜è®¤ä¸º25
-s è®¾å®šç”»é¢çš„å®½ä¸é«˜
-aspect è®¾å®šç”»é¢çš„æ¯”ä¾‹
-vn ä¸å¤„ç†è§†é¢‘
-vcodec è®¾å®šè§†é¢‘ç¼–è§£ç å™¨ï¼Œæœªè®¾å®šæ—¶åˆ™ä½¿ç”¨ä¸è¾“å…¥æµç›¸åŒçš„ç¼–è§£ç å™¨
éŸ³é¢‘å‚æ•°ï¼š
-ar è®¾å®šé‡‡æ ·ç‡
-ac è®¾å®šå£°éŸ³çš„Channelæ•°
-acodec è®¾å®šå£°éŸ³ç¼–è§£ç å™¨ï¼Œæœªè®¾å®šæ—¶åˆ™ä½¿ç”¨ä¸è¾“å…¥æµç›¸åŒçš„ç¼–è§£ç å™¨
-an ä¸å¤„ç†éŸ³é¢‘
```

***

### ç¡¬ç¼–è§£ç 

#### exoplayer

å¦‚æœæ’­æ”¾å™¨éƒ¨åˆ†æ˜¯ç”¨exoplayerï¼Œä¹Ÿæ˜¯ç¡¬è§£ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘å¾ˆå¤šä½“ç§¯ï¼Œä¸”å†…ç½®äº†ä¸€äº›åŠŸèƒ½å¯ä»¥ç›´æ¥è°ƒç”¨ã€‚

ä½¿ç”¨exoplayerçš„åŸå› ï¼š

- è°·æ­Œå®˜æ–¹å‡ºå“çš„å¼€æºåº“ï¼Œæ˜“äºè‡ªå®šä¹‰å’Œæ‰©å±•ï¼Œexoplayerä¸“é—¨ä¸ºæ­¤åšäº†è®¾è®¡ï¼Œå‡†è®¸å¾ˆå¤šç»„ä»¶å¯ä»¥è¢«è‡ªå®šä¹‰çš„å®ç°ç±»æ›¿æ¢
- javaç¼–å†™ï¼Œç›¸æ¯”äºnative codeï¼Œå¼€å‘æ›´å®¹æ˜“ï¼Œæ›´æ¸…æ¥šçš„è·å¾—ä¸€äº›å¼‚å¸¸æºå’Œè¿›è¡Œéƒ¨åˆ†ä»£ç è°ƒè¯•
- è¾ƒå°‘çš„è®¾å¤‡å…¼å®¹é—®é¢˜

| åŠŸèƒ½ | exoplayeræ˜¯å¦å·²æœ‰apiæ”¯æŒ | æ‹“å±•ä½¿ç”¨çš„åŸºç±»å’Œæ¥å£ |
| --- | ----------------------- | ------------------- |
| è§†é¢‘è£å‰ª | å·²æœ‰æ”¯æŒ | ClippingMediaSource |
| ç´ ææ‹¼æ¥ | å·²æœ‰æ”¯æŒ | ConcatenatingMediaSource |
| è§†é¢‘å˜é€Ÿ | å·²æœ‰æ”¯æŒ | SimpleExoPlayer.setPlaybackParameters |

**è§†é¢‘è£å‰ªï¼š**

è§†é¢‘è£å‰ªæ’­æ”¾ä½¿ç”¨ClippingMediaSourceè®¾ç½®è£å‰ªç´ æï¼ŒæŒ‰apiæ–‡æ¡£ä¼ å…¥èµ·å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ã€‚

``` java
/**
 * Creates a new clipping source that wraps the specified source and provides samples between the
 * specified start and end position.
 *
 * @param mediaSource The single-period source to wrap.
 * @param startPositionUs The start position within {@code mediaSource}'s window at which to start
 *     providing samples, in microseconds.
 * @param endPositionUs The end position within {@code mediaSource}'s window at which to stop
 *     providing samples, in microseconds. Specify {@link C#TIME_END_OF_SOURCE} to provide samples
 *     from the specified start point up to the end of the source. Specifying a position that
 *     exceeds the {@code mediaSource}'s duration will also result in the end of the source not
 *     being clipped.
 */
public ClippingMediaSource(MediaSource mediaSource, long startPositionUs, long endPositionUs) {
    this(
        mediaSource,
        startPositionUs,
        endPositionUs,
        /* enableInitialDiscontinuity= */ true,
        /* allowDynamicClippingUpdates= */ false,
        /* relativeToDefaultPosition= */ false);
}
```

**ç´ ææ‹¼æ¥:**

å¤šä¸ªè§†é¢‘æ‹¼æ¥æ’­æ”¾ï¼Œä½¿ç”¨ConcatenatingMediaSourceå¯ä»¥ç”¨æ¥æ— ç¼åœ°åˆå¹¶æ’­æ”¾å¤šä¸ªç´ æã€‚

``` java
/**
 * @param mediaSources The {@link MediaSource}s to concatenate. It is valid for the same {@link
 *     MediaSource} instance to be present more than once in the array.
 */
public ConcatenatingMediaSource(MediaSource... mediaSources) {
    this(/* isAtomic= */ false, mediaSources);
}
```

**è§†é¢‘å˜é€Ÿï¼š**

å˜é€Ÿä½¿ç”¨setPlaybackParametersè®¾ç½®é€Ÿåº¦å‚æ•°

``` java
SimpleExoPlayer simpleExoPlayer = player.getExoPlayer();
if (simpleExoPlayer != null) {
    simpleExoPlayer.setPlaybackParameters(new PlaybackParameters(speed));
}
```

#### MediaCodec+MediaExtractor+MediaMuxer

éŸ³è§†é¢‘ç¼–è¾‘ä¸­ï¼Œå¯¹å¤šæ®µåª’ä½“ç´ æè¿›è¡Œæˆªå–å’Œæ‹¼æ¥æ˜¯éå¸¸å¸¸è§çš„æ“ä½œï¼Œæˆªå–å’Œæ‹¼æ¥å®é™…ä¸Šæ˜¯å¯¹åª’ä½“æ–‡ä»¶æ•°æ®é‡æ–°è¿›è¡Œç»„åˆçš„è¿‡ç¨‹ã€‚

è¦å®ç°è¿™äº›åŠŸèƒ½ï¼Œå°±éœ€è¦å¯¹åª’ä½“æ–‡ä»¶è¿›è¡Œç¼–è§£ç æ“ä½œï¼Œå³å…ˆè§£ç è¦å¤„ç†çš„åª’ä½“æ–‡ä»¶æ•°æ®ï¼Œç„¶åå†æŒ‰ç…§æŸç§è§„åˆ™å¯¹è¿™äº›æ•°æ®è¿›è¡Œç¼–ç ï¼Œä»¥ç”Ÿæˆæˆ‘ä»¬æ‰€éœ€çš„ç›®æ ‡ã€‚

{% asset_img 1.png %}

æ³¨æ„ï¼šå½“è¦å‘æ–‡ä»¶ä¸­åŒæ—¶å†™å…¥è§†é¢‘å’ŒéŸ³é¢‘æ•°æ®æ—¶ï¼Œå¿…éœ€å…ˆwriteSampleDataæ‰€æœ‰è§†é¢‘æ•°æ®ï¼Œå†å†™éŸ³é¢‘æ•°æ®ï¼Œæˆ–è€…åä¹‹ï¼Œå³äºŒè€…å¿…éœ€è¿ç»­è°ƒç”¨writeSampleDataï¼Œä¸èƒ½äº¤å‰è°ƒç”¨ï¼Œå¦åˆ™å†™å‡ºçš„æ–‡ä»¶ä¼šæœ‰é—®é¢˜ã€‚

**å…·ä½“æ“ä½œè¿‡ç¨‹ï¼š**

å…ˆåˆå§‹åŒ–MediaExtractorå¹¶åˆ†ç¦»éŸ³è§†é¢‘è½¨é“ã€MediaMuxeråˆå§‹åŒ–ï¼Œå†æŠŠåˆ†ç¦»åçš„æ•°æ®é€åˆ°MediaCodecä¸­è¿›è¡Œè§£ç å¤„ç†æ“ä½œå…ƒæ•°æ®ï¼Œæœ€åç”¨MediaMuxerå¯¹æ–‡ä»¶è¿›è¡Œå°è£…ã€‚

è§†é¢‘è£å‰ª

``` java
@TargetApi(Build.VERSION_CODES.LOLLIPOP)
public static boolean genVideoUsingMuxer(Context context, String srcPath, String dstPath, int startMs, int endMs, boolean useAudio, boolean useVideo) throws IOException {
    boolean success = true;
    // Set up MediaExtractor to read from the source.
    MediaExtractor extractor = new MediaExtractor();
    extractor.setDataSource(srcPath);
    int trackCount = extractor.getTrackCount();
    // Set up MediaMuxer for the destination.
    MediaMuxer muxer;
    muxer = new MediaMuxer(dstPath, MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);
    // Set up the tracks and retrieve the max buffer size for selected tracks.
    HashMap<Integer, Integer> indexMap = new HashMap<>(trackCount);
    int bufferSize = -1;
    for (int i = 0; i < trackCount; i++) {
        MediaFormat format = extractor.getTrackFormat(i);
        String mime = format.getString(MediaFormat.KEY_MIME);
        boolean selectCurrentTrack = false;
        if (mime.startsWith("audio/") && useAudio) {
            selectCurrentTrack = true;
        } else if (mime.startsWith("video/") && useVideo) {
            selectCurrentTrack = true;
        }
        if (selectCurrentTrack) {
            extractor.selectTrack(i);
            int dstIndex = muxer.addTrack(format);
            indexMap.put(i, dstIndex);
            if (format.containsKey(MediaFormat.KEY_MAX_INPUT_SIZE)) {
                int newSize = format.getInteger(MediaFormat.KEY_MAX_INPUT_SIZE);
                bufferSize = newSize > bufferSize ? newSize : bufferSize;
            }
        }
    }
    if (bufferSize < 0) {
        bufferSize = 1080*1920*30;
    }
 
    // Set up the orientation and starting time for extractor.
    MediaMetadataRetriever retrieverSrc = new MediaMetadataRetriever();
    retrieverSrc.setDataSource(srcPath);
    String degreesString = retrieverSrc.extractMetadata(
            MediaMetadataRetriever.METADATA_KEY_VIDEO_ROTATION);
    if (degreesString != null) {
        int degrees = Integer.parseInt(degreesString);
        if (degrees >= 0) {
            muxer.setOrientationHint(degrees);
        }
    }
    if (startMs > 0) {
        extractor.seekTo(startMs * 1000, MediaExtractor.SEEK_TO_PREVIOUS_SYNC);
    }
    // Copy the samples from MediaExtractor to MediaMuxer. We will loop
    // for copying each sample and stop when we get to the end of the source
    // file or exceed the end time of the trimming.
    int offset = 0;
    int trackIndex = -1;
    ByteBuffer dstBuf = ByteBuffer.allocate(bufferSize);
    MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo();
    try {
        muxer.start();
        while (true) {
            bufferInfo.offset = offset;
            bufferInfo.size = extractor.readSampleData(dstBuf, offset);
            if (bufferInfo.size < 0) {
                Log.d(TAG, "Saw input EOS.");
                bufferInfo.size = 0;
                break;
            } else {
                bufferInfo.presentationTimeUs = extractor.getSampleTime();
                if (endMs > 0 && bufferInfo.presentationTimeUs > (endMs * 1000)) {
                    Log.d(TAG, "The current sample is over the trim end time.");
                    break;
                } else {
                    bufferInfo.flags = extractor.getSampleFlags();
                    trackIndex = extractor.getSampleTrackIndex();
                    muxer.writeSampleData(indexMap.get(trackIndex), dstBuf, bufferInfo);
                    extractor.advance();
                }
            }
        }
        muxer.stop();
    } catch (Exception e) {
        // Swallow the exception due to malformed source.
        Log.w(TAG, "The source video file is malformed");
        success = false;
    } finally {
        muxer.release();
    }
    return success;
}
```

#### å…¶ä»–å¤„ç†ï¼šOpenGL+MediaCodec

ä¼—å¤šè§†é¢‘ç¼–è¾‘sdkå°è£…ffmpegå¯¹è§†é¢‘è¿›è¡Œè½¬ç ã€è£å‰ªã€åˆå¹¶ã€å‹ç¼©ã€‚åœ¨éŸ³è§†é¢‘é¢†åŸŸï¼Œä¸€èˆ¬å¤§å‹æˆç†Ÿçš„å•†ç”¨sdkæ˜¯è·¨å¹³å°çš„ï¼Œå„ç»ˆç«¯sdkå…¬ç”¨ä¸€å¥—ç”±c++å¼€å‘çš„åº•å±‚å¼•æ“ï¼Œé’ˆå¯¹å„ç«¯ç¡¬ä»¶çš„ä¸åŒåšä¸åŒå¤„ç†ï¼Œä¾‹å¦‚åˆ†åˆ«å¯¹pcã€androidã€iosï¼ˆå·²æœ‰AVFoundationæ¡†æ¶ï¼‰æä¾›ç¡¬ç¼–ç¡¬è§£çš„åŠŸèƒ½ã€‚ï¼ˆä¸ƒç‰›äº‘çŸ­è§†é¢‘SDK 12w/å¹´ã€è…¾è®¯äº‘çŸ­è§†é¢‘SDK 50w/å¹´ã€é˜¿é‡Œäº‘çŸ­è§†é¢‘SDK 15w/å¹´ã€VEè§†é¢‘ç¼–è¾‘SDK 60w/å¹´ï¼‰

{% asset_img 2.jpg %}

**ç¡¬è§£ç”¨åˆ°çš„æŠ€æœ¯ï¼š**

å…ˆç”¨MediaExtractorè¯»å‡ºè§†é¢‘æ•°æ®ï¼Œå†ç”¨MediaCodecè¿›è¡Œè§£ç ï¼Œå°†è§£ç çš„ç”»é¢é€šè¿‡OpenGLæ¸²æŸ“åˆ°SurfaceTextureä¸Šï¼Œç”±SurfaceTextureç”ŸæˆSurfaceæŠŠç”»é¢é‡æ–°ç¼–ç è¿›MediaCodecï¼Œæœ€åé€šè¿‡MediaMuxeråˆæˆè§†é¢‘ï¼Œè§†é¢‘é•¿åº¦ç”±MediaCodecæ§åˆ¶ï¼Œè€Œç”»é¢å¤§å°ç”±openglæ¥è£å‰ªã€‚

**OpenGLå¤„ç†ï¼š**

OpenGLè§†é¢‘å¤„ç†æµç¨‹å³ä½¿ç”¨OpenGLå¯¹åŸå§‹è§†é¢‘å¸§è¿›è¡ŒäºŒæ¬¡å¤„ç†ã€‚åˆ›å»ºOpenGLæ¸²æŸ“ç¯å¢ƒï¼Œé€šè¿‡SurfaceTextureçš„updateTexImageæ¥å£ï¼Œå¯å°†è§†é¢‘æµä¸­æœ€æ–°çš„å¸§æ•°æ®æ›´æ–°åˆ°å¯¹åº”çš„GLçº¹ç†ï¼Œå†æ“ä½œGLçº¹ç†å¯å¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚

ï¼ˆOpenGLè¿˜ä¸ç†Ÿæ‚‰ï¼Œå¾…è¡¥å……ï¼‰

***

### å‚è€ƒä¸é¸£è°¢

> <https://www.jianshu.com/p/41957301f4a3>
> <https://www.jianshu.com/p/2cf527f2129f>
> <https://www.cnblogs.com/duanxiaojun/articles/6904878.html>
> <https://www.cnblogs.com/dwdxdy/p/3240167.html>
> <https://blog.csdn.net/u010302327/article/details/81363402>
> <https://www.jianshu.com/p/a56505bfc15a>
> <https://www.jianshu.com/p/eb8615fe9f7a>
> <https://blog.csdn.net/yangxi_pekin/article/details/48374827>
