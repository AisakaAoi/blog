---
title: ç»å…¸æ¨¡å‹å‹ç¼©æ–¹æ³•ï¼šçŸ¥è¯†è’¸é¦ç³»åˆ—ï¼ˆä¸‰ï¼‰ï¼šä½¿ç”¨ MMRazor å®ç°çŸ¥è¯†è’¸é¦ç®—æ³•
categories:
  - ğŸŒ™è¿›é˜¶å­¦ä¹ 
  - â­äººå·¥æ™ºèƒ½ Artificial Intelligence
abbrlink: 7bacd7c9
date: 2023-01-04 05:33:07
---

åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¸‰ç±»åŸºç¡€çŸ¥è¯†è’¸é¦ç®—æ³•ä»¥åŠçŸ¥è¯†è’¸é¦çš„è¿ç§»å­¦ä¹ åº”ç”¨ã€‚ä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ¥å­¦ä¹ **å¦‚ä½•ä½¿ç”¨ MMRazor å®ç°çŸ¥è¯†è’¸é¦**ã€‚

MMRazor æ˜¯ OpenMMLab ç”Ÿæ€çš„é¢å‘æ¨¡å‹å‹ç¼©çš„å¼€æºç®—æ³•åº“ï¼Œç›®å‰ä¸»è¦æ¶µç›–äº†çŸ¥è¯†è’¸é¦ã€å‰ªæã€NAS ä¸‰ç±»ç®—æ³•ï¼Œè¿‘æœŸä¼šè¿›ä¸€æ­¥æ”¯æŒä¸€ç³»åˆ—æ¨¡å‹é‡åŒ–ç®—æ³•ã€‚

> https://github.com/open-mmlab/mmrazor/tree/dev-1.x

æˆ‘ä»¬æ¥ä¸‹æ¥å°†ä» **MMRazor çŸ¥è¯†è’¸é¦æ¡†æ¶ä»‹ç»ï¼ŒåŸºäº MMRazor çš„çŸ¥è¯†è’¸é¦å®æˆ˜æ•™ç¨‹**ä¸¤ä¸ªæ–¹é¢å±•å¼€åˆ†äº«ã€‚

<!--more-->

***

### MMRazor çŸ¥è¯†è’¸é¦æ¡†æ¶ä»‹ç»

çŸ¥è¯†è’¸é¦ï¼ˆKnowledge Distillationï¼Œç®€è®°ä¸º KDï¼‰æ˜¯ä¸€ç§ç»å…¸çš„æ¨¡å‹å‹ç¼©æ–¹æ³•ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡å¼•å¯¼è½»é‡åŒ–çš„å­¦ç”Ÿæ¨¡å‹â€œæ¨¡ä»¿â€æ€§èƒ½æ›´å¥½ã€ç»“æ„æ›´å¤æ‚çš„æ•™å¸ˆæ¨¡å‹ï¼ˆæˆ–å¤šæ¨¡å‹çš„ ensembleï¼‰ï¼Œåœ¨ä¸æ”¹å˜å­¦ç”Ÿæ¨¡å‹ç»“æ„çš„æƒ…å†µä¸‹æé«˜å…¶æ€§èƒ½ã€‚2015 å¹´ Hinton å›¢é˜Ÿæå‡ºçš„åŸºäºâ€œè½¯æ ‡ç­¾â€ï¼ˆ**response-based**ï¼‰çš„çŸ¥è¯†è’¸é¦æŠ€æœ¯ï¼ˆä¸€èˆ¬å°†è¯¥æ–‡ç®—æ³•ç§°ä¸º[**vanilla-KD**](https://arxiv.org/pdf/1503.02531)ï¼‰æ€èµ·äº†ç›¸å…³ç ”ç©¶çƒ­æ½®ï¼Œå…¶ååŸºäºâ€œç‰¹å¾â€ï¼ˆ**feature-based**ï¼‰å’ŒåŸºäºâ€œå…³ç³»â€ï¼ˆ**relation-based**ï¼‰çš„KDç®—æ³•è¢«é™†ç»­æå‡ºã€‚

ç”±äºçŸ¥è¯†è’¸é¦çš„è¿‡ç¨‹å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªï¼Œè·å–å­¦ç”Ÿç½‘ç»œå’Œæ•™å¸ˆç½‘ç»œæŒ‡å®šè’¸é¦ä½ç‚¹çš„è¾“å‡ºç‰¹å¾å¹¶è®¡ç®—è’¸é¦ loss çš„è¿‡ç¨‹ã€‚å› æ­¤ï¼Œå®ç°ä¸€ä¸ªè’¸é¦ç®—æ³•å¾€å¾€ä¼šæœ‰ä»¥ä¸‹å‡ ç‚¹éœ€æ±‚ï¼š
1. è·å–å­¦ç”Ÿç½‘ç»œå’Œæ•™å¸ˆç½‘ç»œæŒ‡å®šè’¸é¦ä½ç‚¹çš„è¾“å‡ºç‰¹å¾ï¼Œä¾‹å¦‚æŸä¸ª nn.Moduleï¼ŒæŸä¸ªç±»æ–¹æ³•æˆ–æ˜¯æŸä¸ªå‡½æ•°çš„è¾“å…¥è¾“å‡ºä¿¡æ¯ã€‚åœ¨ MMRazor ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ **Recorder** ç»„ä»¶å®ç°ã€‚
2. åœ¨å­¦ç”Ÿç½‘ç»œå‰å‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼ŒæŸä¸€ä¸­é—´è¾“å‡ºéœ€è¦è¢«æ•™å¸ˆç½‘ç»œå¯¹åº”è¾“å‡ºè¦†ç›–ã€‚ä¾‹å¦‚ï¼Œåœ¨ LAD ä¸­ï¼Œå­¦ç”Ÿç½‘ç»œè®­ç»ƒè¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨æ•™å¸ˆç½‘ç»œçš„ label assign ç»“æœè¦†ç›–æ‰è‡ªèº«ç»“æœã€‚åœ¨ MMRazor ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ **Deliver** ç»„ä»¶å®ç°ã€‚
3. ä¸€ä¸ªè’¸é¦ç®—æ³•ä¸­å¯èƒ½ä¼šæœ‰å¤šä¸ªè’¸é¦ loss è”åˆä½œç”¨ã€‚è€ŒæŸä¸ªè’¸é¦ loss éœ€è¦çš„è¾“å…¥å¯èƒ½æ¥è‡ªäºä¸åŒ recorderï¼Œä¹Ÿå¯èƒ½æ¥è‡ªäºæŸä¸€ä¸ª recorder è·å–çš„å¤šä¸ªæ•°æ®ä¸­çš„è‹¥å¹²ä¸ªã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨ loss_forward_mappings æ•°æ®ç»“æ„ä» Recorder è·å–çš„è¾“å‡ºç‰¹å¾ä¸­ç­›é€‰å¾—åˆ°è’¸é¦ loss éœ€è¦çš„éƒ¨åˆ†ï¼Œå¹¶åˆ©ç”¨ connectors æ¨¡å—è¿›è¡Œåå¤„ç†ï¼ˆä¾‹å¦‚ï¼Œå¯¹äº feature-base çš„æ–¹æ³•ï¼Œå½“å­¦ç”Ÿå’Œæ•™å¸ˆç½‘ç»œè¾“å‡ºç‰¹å¾ç»´åº¦ä¸åŒæ—¶ï¼Œå¾€å¾€ä¼šå¯¹å­¦ç”Ÿç½‘ç»œå¯¹åº”ç‰¹å¾è¿›è¡Œåå¤„ç†ä»¥ä¿è¯è’¸é¦ loss æ­£ç¡®è®¡ç®—ï¼‰ã€‚åœ¨ MMRazor ä¸­ï¼Œè¿™ä¸€ç³»åˆ—åŠŸèƒ½æˆ‘ä»¬é€šè¿‡ **ConfigurableDistiller** æ¥ç»Ÿä¸€ç®¡ç†ã€‚
4. è¿›ä¸€æ­¥ï¼Œä¸ºäº†è§£å†³ç‰¹å®šé—®é¢˜æˆ–é¢å‘ç‰¹å®šåœºæ™¯ï¼ŒçŸ¥è¯†è’¸é¦ç®—æ³•æœ¬èº«åˆå¯ä»¥ç»†åˆ†ä¸º data-free KDã€online KDã€self KDï¼ˆå¯è§†ä¸ºä¸€ç§ç‰¹æ®Šçš„ online KDï¼‰å’Œæ¯”è¾ƒç»å…¸çš„ offline KD ç­‰ç­‰ã€‚åœ¨ MMRazorä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è®¾è®¡ä¸åŒçš„high level çš„ **Algorithm** ç»„ä»¶ä»¥æ”¯æŒä¸åŒç±»å‹çš„è’¸é¦ç®—æ³•å¯¹åº”çš„ pipelineã€‚

ä¸Šè¿° 4 ä¸ªç»„ä»¶åœ¨ MMRazor ä¸­çš„ä½ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç»å„ä¸ªç»„ä»¶çš„è®¾è®¡åŠ¨æœºå’Œä½¿ç”¨æ–¹æ³•ã€‚

{% asset_img 1.webp %}

***

#### Recorder

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒRecorder æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œç”¨äºåœ¨æ¨¡å‹å‰é¡¹ä¼ æ’­è¿‡ç¨‹ä¸­è®°å½•å„ç§ä¸­é—´ç»“æœã€‚åŒæ—¶ï¼Œå®ƒè¿˜å¯ä»¥ç”¨æ¥è·å–ä¸€äº›ç‰¹å®šä½ç‚¹çš„æ•°æ®ï¼Œç”¨äºå¯è§†åŒ–åˆ†ææˆ–å…¶ä»–ä½ æƒ³è¦çš„åŠŸèƒ½ã€‚ä¸ºäº†é€‚åº”æ›´å¤šçš„éœ€æ±‚ï¼Œæˆ‘ä»¬åœ¨ MMRazor ä¸­å®ç°äº†å¤šç§ç±»å‹çš„ Recorder æ¥è·å¾—ä¸åŒç±»å‹çš„ä¸­é—´ç»“æœï¼Œå®ƒä»¬ç”± RecorderManager ç»Ÿä¸€ç®¡ç†ã€‚

{% asset_img 2.webp %}

ç›®å‰ï¼Œæˆ‘ä»¬æ”¯æŒäº† 7 ç±» Recorderï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

| Recorder åç§° | æè¿° |
| ------------ | ---- |
| ModuleOutputsRecorder / ModuleInputsRecorder | è·å–æŸä¸ª torch.nn.Module çš„ è¾“å‡º / è¾“å…¥ ç»“æœ |
| FunctionOutputsRecorder / FunctionInputsRecorder | è·å–æ¨¡å‹ä¸­ä½¿ç”¨åˆ°çš„æŸä¸ªå‡½æ•°çš„ è¾“å‡º / è¾“å…¥ ç»“æœ |
| MethodOutputsRecorder / MethodInputsRecorder | è·å–æ¨¡å‹ä¸­æŸä¸ªç±»çš„æŸä¸ªæ–¹æ³•çš„ è¾“å‡º / è¾“å…¥ ç»“æœ |
| ParameterRecorder | è·å–æŸä¸ª torch.nn.Module çš„æ¨¡å‹å‚æ•° |

æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ ModuleOutputsRecorder ä¸ºä¾‹ï¼Œä¸ºå¤§å®¶ä»‹ç»ä¸‹ Recorder çš„ä½¿ç”¨æ–¹æ³•ã€‚

***

##### ModuleOutputsRecorder

è·å– nn.Module çš„è¾“å…¥è¾“å‡ºç›¸å¯¹ä¼šæ¯”è¾ƒå®¹æ˜“ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡ä¸º nn.Module æŒ‚ä¸Š PyTorch åŸç”Ÿçš„ forward hook æ¥å®ç°ã€‚ç”±äºè¿™ä¸¤ç§ Recorder çš„ä½¿ç”¨æ–¹æ³•éå¸¸ç±»ä¼¼ï¼Œæˆ‘ä»¬ä»¥ ModuleOutputsRecorder ä¸ºä¾‹æ¥ä»‹ç»å®ƒä»¬æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š

``` python
import torch
from torch import nn
from mmrazor.core import ModuleOutputsRecorder

class ToyModel(nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = nn.Conv2d(1, 1, 1)
        self.conv2 = nn.Conv2d(1, 1, 1)

    def forward(self, x):
        x1 = self.conv1(x)
        x2 = self.conv1(x + 1)
        return self.conv2(x1 + x2)

model = ToyModel()
# instantiate with specified module name.
r1 = ModuleOutputsRecorder('conv1')

# initialize is to make specified module can be recorded by 
# registering customized forward hook.
r1.initialize(model)

x = torch.randn(1, 1, 1, 1)
with r1:
    out = model(x)
    
print(r1.data_buffer)
# [tensor([[[[0.0820]]]], grad_fn=<ThnnConv2DBackward0>), tensor([[[[-0.0894]]]], grad_fn=<ThnnConv2DBackward0>)]

print(torch.equal(r1.data_buffer[0], model.conv1(x)))
# True
print(torch.equal(r1.data_buffer[1], model.conv1(x + 1)))
# True
```

**æ³¨æ„ï¼Œæ‰€æœ‰çš„ Recorder åœ¨ä½¿ç”¨å‰éƒ½éœ€è¦æ‰§è¡Œ initialize æ–¹æ³•**

***

##### RecorderManager

RecorderManager åŒæ ·æ˜¯ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå¯ç”¨äºç®¡ç†å„ç§ç±»å‹çš„ Recorderã€‚

åœ¨ RecorderManager çš„å¸®åŠ©ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å°½å¯èƒ½å°‘çš„ä»£ç ç®¡ç†å‡ ä¸ªä¸åŒçš„è®°å½•å™¨ï¼Œè¿™å‡å°‘äº†å‡ºé”™çš„å¯èƒ½æ€§ã€‚

``` python
import random
from torch import nn
from mmrazor.core import RecorderManager

class Toy():
    def toy_func(self):
        return random.randint(0, 1000000)

class ToyModel(nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = nn.Conv2d(1, 1, 1)
        self.conv2 = nn.Conv2d(1, 1, 1)
        self.toy = Toy()

    def forward(self, x):
        return self.conv2(self.conv1(x)) + self.toy.toy_func()

# configure multi-recorders
conv1_rec = ConfigDict(type='ModuleOutputs', source='conv1')
conv2_rec = ConfigDict(type='ModuleOutputs', source='conv2')
func_rec = ConfigDict(type='MethodOutputs', source='toy_module.Toy.toy_func')
# instantiate RecorderManager with a dict that contains recorders' configs,
# you can customize their keys.
manager = RecorderManager(
    {'conv1_rec': conv1_rec,
     'conv2_rec': conv2_rec,
     'func_rec': func_rec})

model = ToyModel()
# initialize is to make specified module can be recorded by 
# registering customized forward hook.
manager.initialize(model)

x = torch.rand(1, 1, 1, 1)
with manager:
    out = model(x)
    
conv2_out = manager.get_recorder('conv2_rec').get_record_data()
print(conv2_out)
# tensor([[[[0.5543]]]], grad_fn=<ThnnConv2DBackward0>)
func_out = manager.get_recorder('func_rec').get_record_data()
print(func_out)
# 313167
```

***

#### Deliver

Deliver å·¥å…·æ˜¯ MMRazor ä¸“é—¨ä¸ºå¤„ç†è’¸é¦ç®—æ³•ä¸­æ¶‰åŠçš„ä¸€äº›ç‰¹æ®Šæƒ…å†µè€Œè®¾è®¡çš„ï¼Œå®ƒåœ¨æ•™å¸ˆæ¨¡å‹å’Œå­¦ç”Ÿæ¨¡å‹ä¹‹é—´è½¬ç§»å¹¶è¦†ç›–æ‰ä¸€äº›ä¸­é—´ç»“æœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

{% asset_img 3.webp %}

Deliver å¹¶ä¸åƒ Recorder é‚£æ ·ï¼ŒåŸºæœ¬åœ¨æ¯ä¸ªè’¸é¦ç®—æ³•ä¸­éƒ½ä¼šä½¿ç”¨ï¼Œä½†å¯¹äºä¸€äº›ç®—æ³•ï¼Œå®ƒæ˜¯å¿…ä¸å¯å°‘çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨ [LAD](https://arxiv.org/abs/2108.10520) ä¸­ï¼Œå­¦ç”Ÿç½‘ç»œéœ€è¦ç›´æ¥è·å–æ•™å¸ˆç½‘ç»œçš„ label assignment ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å¦‚ä¸‹é…ç½® Deliverï¼š
``` python
distill_deliveries = ConfigDict(
    delivery1=dict(
        type='MethodOutputs',
        max_keep_data=100,
        method_path='mmdet.models.dense_heads.paa_head.PAAHead.paa_reassign'),
    delivery2=dict(
        type='MethodOutputs',
        max_keep_data=100,
        method_path='mmdet.models.dense_heads.paa_head.PAAHead.get_targets'))
```

Deliver çš„å¯é…ç½®æ€§ï¼Œè®©æˆ‘ä»¬å¯ä»¥ä¸éœ€è¦å¯¹æºä»£ç è¿›è¡Œ hardcode ä¿®æ”¹ã€‚

***

#### ConfigurableDistiller

ConfigurableDistiller æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹æ•™å¸ˆæˆ–å­¦ç”Ÿæ¨¡å‹ä»£ç çš„æƒ…å†µä¸‹å®ç°å¤§å¤šæ•°è’¸é¦ç®—æ³•ã€‚å®ƒå¯ä»¥é€šè¿‡ Recorder ä»¥ä¸€ç§ hack çš„æ–¹å¼è·å¾—æ¨¡å‹çš„å„ç§ä¸­é—´ç»“æœã€‚åŒæ ·ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ Delivery ä»¥ hack çš„æ–¹å¼ä½¿ç”¨è€å¸ˆçš„ä¸­é—´ç»“æœæ¥è¦†ç›–å­¦ç”Ÿçš„ä¸­é—´ç»“æœã€‚

``` python
class ConfigurableDistiller:
    def __init__(self,
             student_recorders: Optional[Dict[str, Dict]] = None,
             teacher_recorders: Optional[Dict[str, Dict]] = None,
             distill_deliveries: Optional[Dict[str, Dict]] = None,
             connectors: Optional[Dict[str, Dict]] = None,
             distill_losses: Optional[Dict[str, Dict]] = None,
             loss_forward_mappings: Optional[Dict[str, Dict]] = None,
             **kwargs):
```

è¿™é‡Œçš„ student_recordersã€teacher_recordersdistill_deliveries ä¸Šæ–‡åˆšåˆšä»‹ç»ã€‚distill_losses æ˜¯è’¸é¦æ—¶ç”¨åˆ°çš„è’¸é¦æŸå¤±å‡½æ•°ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªã€‚

è¿™é‡Œå¼•å…¥äº†ä¸¤ä¸ªæ–°æ¦‚å¿µï¼šconnectors å’Œ loss_forward_mappings

***

##### Connectors

çŸ¥è¯†è’¸é¦ç®—æ³•å¾€å¾€åˆ†ä¸º reponse-basedã€feature-based å’Œ relation-based ä¸‰ç±»ã€‚å…¶ä¸­ï¼Œfeature-based æ–¹æ³•ä»¥æ•™å¸ˆæ¨¡å‹ç‰¹å¾æå–å™¨äº§ç”Ÿçš„ä¸­é—´å±‚ç‰¹å¾ä¸ºå­¦ä¹ å¯¹è±¡ï¼Œæœ€ç®€å•çš„ L2 æŸå¤±å¦‚ä¸‹æ‰€ç¤ºï¼š

{% asset_img 4.webp %}

å®ç°ç‰¹å¾å¯¹é½åŠŸèƒ½çš„æ¨¡å—ï¼ˆä¸Šé¢æåˆ°çš„ phi_t å’Œ phi_s ï¼‰æ˜¯ feature-based KD ç®—æ³•çš„æ ¸å¿ƒæ¨¡å—ï¼ˆMMRazor ä¸­ç§°ä¹‹ä¸º connectorï¼‰ï¼Œä¹Ÿæ˜¯å¾ˆå¤šç®—æ³•çš„é‡ç‚¹ç ”ç©¶å¯¹è±¡ã€‚å¦‚é’ˆå¯¹æ•™å¸ˆ connector è¿›è¡Œé¢„è®­ç»ƒçš„ [Factor Transfer](https://arxiv.org/abs/1802.04977) ç®—æ³•ï¼›ä»¥äºŒå€¼åŒ–å½¢å¼ç­›é€‰æ•™å¸ˆå’Œå­¦ç”ŸåŸå§‹ç‰¹å¾çš„ [AB](https://arxiv.org/pdf/1811.03233) ç®—æ³•ï¼›å°†ç‰¹å¾å€¼è½¬æ¢ä¸ºæ³¨æ„åŠ›å€¼çš„ [AT](https://arxiv.org/pdf/1612.03928.pdf) ç®—æ³•ç­‰ã€‚[OFD](https://arxiv.org/pdf/1904.01866.pdf) å¯¹å„ç›¸å…³ç®—æ³•è¿›è¡Œæ€»ç»“ï¼Œç ”ç©¶äº†ç‰¹å¾ä½ç½®ã€connector çš„æ„æˆã€æŸå¤±å‡½æ•°ç­‰å› ç´ å¯¹è’¸é¦æ€§èƒ½ã€ä¿¡æ¯æŸå¤±çš„å½±å“ï¼Œæ±‡æ€»è¡¨å¦‚ä¸‹æ‰€ç¤ºï¼š

{% asset_img 5.webp %}

ä¸Šé¢æåˆ°çš„ FitNetsã€Factor Transferã€ABã€AT Lossï¼ˆAT ç®—æ³•ä¸è’¸é¦æœ€ç›¸å…³çš„æŸå¤±è®¡ç®—éƒ¨åˆ†ï¼‰ã€OFD ç­‰ç®—æ³•å‡è¢«é›†æˆåˆ°äº† [MMRazor](https://github.com/open-mmlab/mmrazor) ç®—æ³•åº“ä¸­ï¼Œä¸”æ ¸å¿ƒæ¨¡å— connector è¢«å•ç‹¬æŠ½è±¡å‡ºæ¥ä½œä¸ºå¯é…ç½®ç»„ä»¶ï¼Œéå¸¸ä¾¿äºå¤§å®¶è¿›è¡Œâ€œç®—æ³•é­”æ”¹â€ï¼ˆå¦‚ä¸º FitNets ç®—æ³•é…ç½®ä¸Š Factor Transfer çš„ connector å¹¶è®¡ç®— AT Lossï¼‰ã€‚

***

##### loss_forward_mappings

é€šè¿‡ Recorder ç»„ä»¶è·å¾—æ¨¡å‹ä¸­é—´ç»“æœåï¼Œå¯ä»¥é€šè¿‡é…ç½® loss_forward_mappings æ¥è¿›ä¸€æ­¥æŒ‡å®šä¸åŒçš„è’¸é¦ loss çš„è¾“å…¥å‚æ•°æ˜¯ä»€ä¹ˆã€‚

ä¸‹é¢ä»£ç è¡¨ç¤ºæˆ‘ä»¬åªä½¿ç”¨ä¸€ä¸ªè’¸é¦ lossï¼Œæˆ‘ä»¬æŠŠå®ƒç§°ä¸º loss_neckï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ª L2Lossï¼Œloss weight=5ã€‚æˆ‘ä»¬åˆ†åˆ«è®¾ç½® student_recorders å’Œ teacher_recorder å¸Œæœ›è·å–å­¦ç”Ÿå’Œæ•™å¸ˆç½‘ç»œçš„ 'neck.gap' è¿™ä¸€ module çš„è¾“å‡ºï¼Œè¾“å‡ºç‰¹å¾å‘½åä¸º featã€‚é‚£ä¹ˆåœ¨é…ç½® loss_forward_mappings æ—¶å¯ä»¥çœ‹åˆ° L2Loss çš„ forward æ–¹æ³•æœ‰ä¸¤ä¸ªè¾“å…¥å‚æ•°ï¼Œåˆ†åˆ«ä¸º s_feature å’Œ t_featureã€‚è€Œ s_feature å’Œ t_feature åˆåˆ†åˆ«æ¥è‡ªäºåå­—ä¸º feat çš„å­¦ç”Ÿå’Œæ•™å¸ˆç½‘ç»œä¸­é—´ç‰¹å¾ã€‚

``` python
>>> distill_losses = dict(
...     loss_neck=dict(type='L2Loss', loss_weight=5))
>>> student_recorders = dict(
...     feat = dict(type='ModuleOutputs', source='neck.gap'))

>>> teacher_recorders = dict(
...     feat = dict(type='ModuleOutputs', source='neck.gap'))

>>> loss_forward_mappings = dict(
...     loss_neck=dict(
...         s_feature=dict(from_recorder='feat', from_student=True,
...                        connector='loss_neck_sfeat'),
...         t_feature=dict(from_recorder='feat', from_student=False,
...                        connector='loss_neck_tfeat')))
```

***

#### Algorithm

æœ€åï¼ŒDistill Algorithm è´Ÿè´£æ§åˆ¶è’¸é¦çš„ä¸€æ•´ä¸ª pipelineã€‚MMRazor å®ç°äº†å¤šç±»çŸ¥è¯†è’¸é¦ç®—æ³•ï¼Œæˆ‘ä»¬ä»¥æœ€ç»å…¸çš„ï¼Œä½¿ç”¨å•ä¸ªæ•™å¸ˆç½‘ç»œè’¸é¦å•ä¸ªå­¦ç”Ÿç½‘ç»œçš„ SingleTeacherDistill ç®—æ³•ä¸ºä¾‹ã€‚ä¸‹é¢ä»£ç å±•ç¤ºäº†å…¶åœ¨åˆå§‹åŒ–æ—¶éœ€è¦ä¼ å…¥çš„å‚æ•°ï¼š

``` python
class SingleTeacherDistill:
    def __init__(self,
        architecture,  # å­¦ç”Ÿç½‘ç»œå¯¹åº”é…ç½®
        distiller: dict,  # è’¸é¦ç›¸å…³toolsçš„é…ç½®æ–‡ä»¶
        teacher: Union[BaseModel, Dict],  # æ•™å¸ˆç½‘ç»œå¯¹åº”é…ç½®æ–‡ä»¶
        teacher_ckpt: Optional[str] = None,  # æ•™å¸ˆç½‘ç»œçš„é¢„è®­ç»ƒæƒé‡è·¯å¾„
        teacher_trainable: bool = False,  # æ•™å¸ˆç½‘ç»œæ˜¯å¦å¯ä»¥è®­ç»ƒ
        teacher_norm_eval: bool = True,  # æ•™å¸ˆç½‘ç»œçš„normalization æ¨¡å—æ˜¯å¦éœ€è¦è°ƒæˆeval modeï¼Œè‹¥ä¸ºeval modeï¼Œåœ¨å­¦ç”Ÿç½‘ç»œè®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ•™å¸ˆç½‘ç»œçš„norm moduleçš„ç»Ÿè®¡ä¿¡æ¯ä¸ä¼šéšç€æ”¹å˜
        student_trainable: bool = True,  # å­¦ç”Ÿç½‘ç»œæ˜¯å¦å¯è®­ç»ƒ
        calculate_student_loss: bool = True,  # å­¦ç”Ÿç½‘ç»œæ˜¯å¦å—ground truthæ ‡ç­¾ç›‘ç£
```

***

### åŸºäº MMRazor çš„çŸ¥è¯†è’¸é¦å®æˆ˜æ•™ç¨‹

æˆ‘ä»¬é¦–å…ˆä»¥ KD ç®—æ³•ä½¿ç”¨ ResNet34 è’¸é¦ ResNet18 ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨ MMRazor å®ç°åŸºç¡€è’¸é¦ç®—æ³•ã€‚

#### KD

##### æ­¥éª¤ä¸€ï¼šè®¾è®¡ Distiller ç›¸å…³é…ç½®æ–‡ä»¶

ä¼ ç»Ÿ [KD](https://arxiv.org/abs/1503.02531) ç®—æ³•çš„çŸ¥è¯†æå–å’Œ loss è®¡ç®—è¿‡ç¨‹éå¸¸ç®€æ´ï¼Œåªéœ€è·å–å­¦ç”Ÿç½‘ç»œå’Œæ•™å¸ˆç½‘ç»œçš„è¾“å‡º logits å¹¶è®¡ç®— KL æ•£åº¦å³å¯ã€‚Distiller ç»„ä»¶çš„é…ç½®æ–‡ä»¶ä¸»è¦åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼Œå¦‚ä¸‹æ–¹ä»£ç æ‰€ç¤ºã€‚

``` python
distiller=dict(
    type='ConfigurableDistiller',
    student_recorders=dict(
        fc=dict(type='ModuleOutputs', source='head.fc')),
    teacher_recorders=dict(
        fc=dict(type='ModuleOutputs', source='head.fc')),
    distill_losses=dict(
        loss_kl=dict(type='KLDivergence', tau=1, loss_weight=3)),
    loss_forward_mappings=dict(
        loss_kl=dict(
            preds_S=dict(from_student=True, recorder='fc'),
            preds_T=dict(from_student=False, recorder='fc'))))
```

1. student_recorders å’Œ teacher_recorders è¡¨ç¤ºæˆ‘ä»¬éœ€è¦åˆ†åˆ«è®°å½•å­¦ç”Ÿå’Œæ•™å¸ˆç½‘ç»œä¸­æŸä¸€ä¸ª nn.Module çš„è¾“å‡ºï¼Œè¿™ä¸ª nn.Module çš„ module name æ˜¯ head.fcï¼Œè®°å½•çš„æ•°æ®æˆ‘ä»¬å°†å…¶å‘½åä¸º fcã€‚
2. åœ¨æ•´ä¸ªè’¸é¦è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªä½¿ç”¨äº†ä¸€ç§æŸå¤±å‡½æ•°ï¼Œå› æ­¤ distill_losses ä¸­åªåŒ…å«ä¸€ç»„ key å’Œ valueã€‚key æ˜¯ loss_kl ï¼Œè¡¨ç¤ºå°†è¿™ä¸ªè’¸é¦ loss å‘½åä¸º loss_klï¼Œvalue åˆ™æ˜¯è’¸é¦ loss å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œè¡¨ç¤ºæˆ‘ä»¬ç”¨çš„è’¸é¦ loss æ˜¯ KLDivergenceï¼Œè¶…å‚æ•° temperature æ¸©åº¦ä¸º 1ï¼Œloss weigh ä¸º 5ã€‚
3. loss_forward_mappings æŒ‡å®šæ¯ä¸ª loss module çš„è¾“å…¥æ•°æ®æ˜¯ä»€ä¹ˆã€‚åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œloss module æœ‰ä¸¤ä¸ªè¾“å…¥ï¼špreds_S å’Œ preds_Tï¼Œåˆ†åˆ«è¡¨ç¤ºå­¦ç”Ÿå’Œæ•™å¸ˆç½‘ç»œè¾“å‡º logitsï¼Œå®ƒä»¬éœ€è¦è·Ÿ KLDivergence loss module ä¸­ forward æ–¹æ³•ä¼ å…¥å‚æ•°ä¿æŒä¸€è‡´ã€‚å¦å¤–ï¼Œæˆ‘ä»¬é€šè¿‡ from_student å’Œ recorder ä¸¤ä¸ªå­—æ®µåˆ¤æ–­ä»student_recorders è¿˜æ˜¯ teacher_recorders ä¸­è¯»å–å“ªä¸ªå€¼ã€‚dict(from_student=True, recorder='fc') è¡¨ç¤ºè¯»å– student_recorders ä¸­åå­—ä¸º fc çš„æ•°æ®ã€‚

##### æ­¥éª¤äºŒï¼šè®¾è®¡ Algorithm ç›¸å…³é…ç½®æ–‡ä»¶

ç®—æ³•å±‚é¢éœ€è¦è¿›è¡Œä»¥ä¸‹é…ç½®ã€‚architecture å’Œ teacher æŒ‡å®šäº†å­¦ç”Ÿ/æ•™å¸ˆç½‘ç»œçš„ç½‘ç»œé…ç½®ï¼Œteacher_ckpt æŒ‡å®šæ•™å¸ˆç½‘ç»œçš„é¢„è®­ç»ƒæƒé‡çš„è·¯å¾„ï¼Œå¦‚æœä½¿ç”¨ MMClassification æä¾›çš„é¢„è®­ç»ƒå‚æ•°ï¼Œä¹Ÿå¯ç›´æ¥åœ¨ teacher å¯¹åº”çš„å­—å…¸ä¸­çš„ pretrained çš„å€¼è®¾ä¸º Trueã€‚å…¶ä½™é…ç½®åªéœ€æŒ‰ç…§é»˜è®¤è®¾ç½®ï¼Œå³ï¼šteacher_trainable=False è¡¨ç¤ºè’¸é¦è¿‡ç¨‹ä¸­æ•™å¸ˆç½‘ç»œæ˜¯ä¸å¯å­¦ä¹ çš„ï¼›teacher_norm_eval=True è¡¨ç¤ºè’¸é¦è¿‡ç¨‹ä¸­æ•™å¸ˆç½‘ç»œçš„ norm module å…¨ç¨‹éƒ½å¤„åœ¨ eval æ¨¡å¼ä¸‹ï¼›calculate_student_loss=True è¡¨ç¤ºå­¦ç”Ÿç½‘ç»œé™¤äº†å—æ•™å¸ˆç½‘ç»œç›‘ç£å¤–ï¼Œè¿˜å—åˆ° ground truth çš„ç›‘ç£ã€‚

``` python
model = dict(
    ...,
    architecture=dict(
        cfg_path='mmcls::resnet/resnet18_8xb32_in1k.py', pretrained=False),
    teacher=dict(
        cfg_path='mmcls::resnet/resnet34_8xb32_in1k.py', pretrained=False),
    teacher_ckpt=teacher_ckpt,
    teacher_trainable=False,
    teacher_norm_eval=True,
    student_trainable=True,
    calculate_student_loss=True,
    distiller=...
)
```

##### æ­¥éª¤ä¸‰ï¼šè®¾è®¡å…¶ä»–é…ç½®æ–‡ä»¶

æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰æ•°æ®é›†ã€ä¼˜åŒ–å™¨ç­‰å…¶ä»–é…ç½®æ–‡ä»¶ï¼Œè¿™éƒ¨åˆ†ç›´æ¥å¼•å…¥ MMClassification å®šä¹‰å¥½çš„é…ç½®æ–‡ä»¶å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­ val_cfg å®šä¹‰äº†è’¸é¦è¿‡ç¨‹ä¸­ evaluation çš„ pipelineï¼š

``` python
_base_ = [
    'mmcls::_base_/datasets/imagenet_bs32.py',
    'mmcls::_base_/schedules/imagenet_bs256.py',
    'mmcls::_base_/default_runtime.py'
]
find_unused_parameters = True

val_cfg = dict(_delete_=True, type='mmrazor.SingleTeacherDistillValLoop')
```

***

#### OFD

æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ [OFD](https://arxiv.org/abs/1904.01866) ç®—æ³•ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨ MMRazor å®ç°ç¨å¾®å¤æ‚ä¸€äº›çš„ç®—æ³•ã€‚

##### æ­¥éª¤ä¸€ï¼šè®¾è®¡ Distiller ç›¸å…³é…ç½®æ–‡ä»¶

``` python
distiller=dict(
    type='OFDDistiller',
    student_recorders=dict(
        bb_1=dict(type='ModuleOutputs', source='backbone.layer2.0.bn1'),
        bb_2=dict(type='ModuleOutputs', source='backbone.layer3.0.bn1'),
        bb_3=dict(type='ModuleOutputs', source='backbone.bn1')),
    teacher_recorders=dict(
        bb_1=dict(type='ModuleOutputs', source='backbone.layer2.0.bn1'),
        bb_2=dict(type='ModuleOutputs', source='backbone.layer3.0.bn1'),
        bb_3=dict(type='ModuleOutputs', source='backbone.bn1')),
    distill_losses=dict(
        loss_1=dict(type='OFDLoss', loss_weight=0.25),
        loss_2=dict(type='OFDLoss', loss_weight=0.5),
        loss_3=dict(type='OFDLoss', loss_weight=1.0)),
    connectors=dict(
        loss_1_sfeat=dict(
            type='ConvModuleConncetor',
            in_channel=32,
            out_channel=64,
            norm_cfg=dict(type='BN'),
            act_cfg=None),
        loss_1_tfeat=dict(type='OFDTeacherConnector'),
        loss_2_sfeat=dict(
            type='ConvModuleConncetor',
            in_channel=64,
            out_channel=128,
            norm_cfg=dict(type='BN'),
            act_cfg=None),
        loss_2_tfeat=dict(type='OFDTeacherConnector'),
        loss_3_sfeat=dict(
            type='ConvModuleConncetor',
            in_channel=128,
            out_channel=256,
            norm_cfg=dict(type='BN'),
            act_cfg=None),
        loss_3_tfeat=dict(type='OFDTeacherConnector')),
    loss_forward_mappings=dict(
        loss_1=dict(
            s_feature=dict(
                from_student=True,
                recorder='bb_1',
                connector='loss_1_sfeat'),
            t_feature=dict(
                from_student=False,
                recorder='bb_1',
                connector='loss_1_tfeat'),
        ),
        loss_2=dict(
            s_feature=dict(
                from_student=True,
                recorder='bb_2',
                connector='loss_2_sfeat'),
            t_feature=dict(
                from_student=False,
                recorder='bb_2',
                connector='loss_2_tfeat'),
        ),
        loss_3=dict(
            s_feature=dict(
                from_student=True,
                recorder='bb_3',
                connector='loss_3_sfeat'),
            t_feature=dict(
                from_student=False,
                recorder='bb_3',
                connector='loss_3_tfeat'),
        )))
```

ä¸Šæ–¹ä»£ç æ˜¯ OFD ç®—æ³• distiller éƒ¨åˆ†å¯¹åº”çš„é…ç½®æ–‡ä»¶ã€‚student_recorders å’Œ teacher_recorders ä¸ä¸Šè¿° KD ç®—æ³•ç±»ä¼¼ï¼Œåˆ†åˆ«è·å–å­¦ç”Ÿå’Œæ•™å¸ˆç½‘ç»œä¸‰ä¸ª nn.module çš„è¾“å‡ºå¹¶å‘½åä¸º bb_1ï¼Œbb_2ï¼Œbb_3

distill_losseså®šä¹‰äº†ä¸‰ä¸ªè’¸é¦ lossï¼Œloss weight åˆ†åˆ«ä¸º 0.25ï¼Œ0.5 å’Œ 1.0ã€‚ä¸ä¼ ç»Ÿ KD ç®—æ³•ä¸åŒï¼Œconnectorså®šä¹‰äº† OFD ä¸­ç”¨åˆ°çš„ connector ç»“æ„ â€”â€” convbn layerã€‚å‰æ–‡ä»‹ç»è¿‡ï¼ŒMMRazor ä½¿ç”¨ connectors æ¨¡å—å®ç°ç‰¹å¾å¯¹é½åŠŸèƒ½ï¼Œå³ï¼šåœ¨è·å– loss module æ‰€éœ€è¾“å…¥æ•°æ®åï¼Œè¾“å…¥ loss module å‰ï¼Œæ•°æ®éœ€è¦ç»è¿‡ connector å¤„ç†ã€‚

æœ€å loss_forward_mappings ä¹Ÿä¼šæ¯” KD ä¸­å¤æ‚äº›ï¼Œæˆ‘ä»¬ä»¥ä¸‹æ–¹ä»£ç ä¸ºä¾‹ã€‚ä»£ç ä¸­ distill_losseså®šä¹‰äº† åä¸º loss_1 çš„è’¸é¦æŸå¤±å‡½æ•°å¯¹åº”çš„æ˜¯ loss_weight=0.25 çš„ OFDLossã€‚å…¶ä¸­ OFDLoss loss module çš„è¾“å…¥å‚æ•°æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯ s_feature å’Œ t_featureã€‚s_feature æ¥è‡ªåä¸º bb_1 çš„ student_recorders ï¼Œéœ€è¦ç»è¿‡åä¸º loss_1_sfeat çš„ connector è¿›è¡Œç‰¹å¾åå¤„ç†ã€‚ä»ä¸‹æ–¹ connectors éƒ¨åˆ†çš„å®šä¹‰å¯çŸ¥ï¼Œåä¸ºloss_1_sfeat çš„ connector æ˜¯ä¸€ä¸ª ConvModuleï¼Œè¾“å…¥è¾“å‡ºé€šé“æ•°åˆ†åˆ«ä¸º 32 å’Œ 64ã€‚åŒç†å¯å¾— t_featureã€‚

``` python
student_recorders=dict(bb_1=dict(type='ModuleOutputs', source='backbone.layer2.0.bn1'))
teacher_recorders=dict(bb_1=dict(type='ModuleOutputs', source='backbone.layer2.0.bn1'))
distill_losses=dict(loss_1=dict(type='OFDLoss', loss_weight=0.25))
connectors=dict(
    loss_1_sfeat=dict(
        type='ConvModuleConncetor',
        in_channel=32,
        out_channel=64,
        norm_cfg=dict(type='BN'),
        act_cfg=None),
    loss_1_tfeat=dict(type='OFDTeacherConnector'))
loss_forward_mappings=dict(
    loss_1=dict(
        s_feature=dict(
            from_student=True,
            recorder='bb_1',
            connector='loss_1_sfeat'),
        t_feature=dict(
            from_student=False,
            recorder='bb_1',
            connector='loss_1_tfeat'),
    ))
```

##### æ­¥éª¤äºŒ / ä¸‰ï¼šè®¾è®¡ Algorithm ç›¸å…³é…ç½®æ–‡ä»¶ / è®¾è®¡å…¶ä»–é…ç½®æ–‡ä»¶

æ­¥éª¤äºŒã€ä¸‰ä¸ä¼ ç»Ÿ KD ç®—æ³•ç±»ä¼¼ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶å®ç°äº† OFD ç®—æ³•ã€‚

***

### æ€»ç»“

æœ¬æ–‡ä»‹ç»äº† MMRazor å¯¹çŸ¥è¯†è’¸é¦ç®—æ³•çš„è®¾è®¡æ¡†æ¶ï¼Œå¹¶åˆ—ä¸¾äº†ä¸¤ä¸ªç®€å•ä¾‹å­æ¥ä»‹ç»å¦‚ä½•ä½¿ç”¨ MMRazor å¼€å‘çŸ¥è¯†è’¸é¦ç®—æ³•ã€‚

> https://github.com/open-mmlab/mmrazor/tree/main

***

### å‚è€ƒèµ„æ–™

> <https://zhuanlan.zhihu.com/p/596582609>
